OpenLayers.Handler.FeatureInfo=OpenLayers.Class.create();OpenLayers.Handler.FeatureInfo.prototype=OpenLayers.Class.inherit(OpenLayers.Handler,{alertErrorTitle:"Error :",alertRequestFailedMsg:"Sorry, the feature info request failed...",click:function(a){var c=new OpenLayers.Pixel(a.xy.x,a.xy.y);var d=this.map.getLonLatFromPixel(c);var b=Genapp.base_url+"proxy/getInfo?SERVICE=WFS&VERSION=1.0.0&REQUEST=GetFeature&typename="+Genapp.map.featureinfo_typename+"&BBOX="+(d.lon-Genapp.map.featureinfo_margin)+","+(d.lat+Genapp.map.featureinfo_margin)+","+(d.lon+Genapp.map.featureinfo_margin)+","+(d.lat-Genapp.map.featureinfo_margin);if(Genapp.map.featureinfo_maxfeatures!==0){b=b+"&MAXFEATURES="+Genapp.map.featureinfo_maxfeatures}OpenLayers.loadURL(b,"",this,function(g){try{var f=Ext.decode(g.responseText);if(!Ext.isEmpty(f.data)){if(Genapp.map.featureinfo_maxfeatures===1){Genapp.cardPanel.consultationPage.openDetails(f.data[0][0],"getdetails")}else{Genapp.cardPanel.consultationPage.openFeaturesInformationSelection(f)}}}catch(h){Ext.Msg.alert(this.alertErrorTitle,this.alertRequestFailedMsg)}},function(e){Ext.Msg.alert(this.alertErrorTitle,this.alertRequestFailedMsg)});Event.stop(a)}});OpenLayers.Control.FeatureInfoControl=OpenLayers.Class.create();OpenLayers.Control.FeatureInfoControl.prototype=OpenLayers.Class.inherit(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,initialize:function(b,a){OpenLayers.Control.prototype.initialize.apply(this,[a])},draw:function(){this.handler=new OpenLayers.Handler.FeatureInfo(this,{click:this.click})},CLASS_NAME:"OpenLayers.Control.FeatureInfoControl"});Genapp.CardGridDetailsPanel=Ext.extend(Ext.Panel,{headerWidth:95,closable:true,autoScroll:true,cls:"genapp-query-card-grid-details-panel",loadingMsg:"Loading...",header:false,layout:"card",cardGridDetailsPanelTitle:"Selection",activeItem:0,initComponent:function(){this.itemId=this.initConf.id;this.title='<div style="width:'+this.headerWidth+'px;">'+this.cardGridDetailsPanelTitle+" "+this.initConf.featuresInformationSearchNumber+"</div>";this.items=new Genapp.GridDetailsPanel({initConf:this.initConf});Genapp.CardGridDetailsPanel.superclass.initComponent.call(this)}});Genapp.CardPanel=Ext.extend(Ext.TabPanel,{cls:"genapp-card-panel",activeItem:1,border:false,renderTo:"page",widthToSubstract:80,heightToSubstract:160,shownPages:["predefinedrequestpage","consultationpage","docsearchpage"],initComponent:function(){var a,c=function(d){Ext.History.add(this.id)};this.addEvents("resizewrapper");this.height=Ext.getBody().getViewSize().height-this.heightToSubstract;this.width=Ext.getBody().getViewSize().width-this.widthToSubstract;Ext.EventManager.onWindowResize(function(d,f){var e={width:Ext.getBody().getViewSize().width-this.widthToSubstract,height:Ext.getBody().getViewSize().height-this.heightToSubstract};this.setSize(e);this.fireEvent("resizewrapper",e.width,e.height)},this);if(!this.items&&this.shownPages.length!==0){this.items=[];for(a=0;a<this.shownPages.length;a++){var b={xtype:this.shownPages[a]};if(Genapp.config.historicActivated){b.listeners={activate:c}}this.items.push(b)}}if(this.shownPages.length===1){this.headerCfg={style:"display:none;"};this.defaults={frame:false}}Genapp.CardPanel.superclass.initComponent.call(this)}});Genapp.ConsultationPanel=Ext.extend(Ext.Panel,{title:"Consultation",frame:true,region:"center",layout:"border",cls:"genapp_consultation_panel",border:false,id:"consultation_panel",ref:"consultationPage",hideCsvExportAlert:false,hideCsvExportButton:false,hideGridCsvExportMenuItem:false,hideAggregationCsvExportMenuItem:false,hideInterpolationButton:false,hideAggregationButton:false,hidePrintMapButton:true,hideDetails:false,hideMapDetails:true,hideUserManualLink:true,hidePredefinedRequestSaveButton:true,hideGridDataEditButton:true,userManualLinkHref:Genapp.base_url+"pdf/User_Manual.pdf",userManualLinkText:"User Manual",hideDetailsVerticalLabel:false,showGridOnSubmit:false,datasetComboBoxEmptyText:"Please select a dataset...",datasetPanelTitle:"Dataset",formsPanelTitle:"Forms Panel",csvExportButtonText:"Csv Export",gridCsvExportMenuItemText:"Results",aggregationCsvExportMenuItemText:"Aggregation cells",interpolationButtonText:"Interpolation",aggregationButtonText:"Aggregation",printMapButtonText:"Print map",gridViewEmptyText:"No result...",gridPanelTitle:"Results",gridPanelTabTip:"The request's results",gridPageSize:20,centerPanelTitle:"Result Panel",queryPanelTitle:"Query Panel",queryPanelWidth:370,queryPanelPinToolQtip:"Pin the panel",queryPanelUnpinToolQtip:"Unpin the panel",queryPanelCancelButtonText:"Cancel",queryPanelPredefinedRequestSaveButtonText:"Save the request",queryPanelResetButtonText:"Reset",queryPanelSearchButtonText:"Search",queryPanelCancelButtonTooltip:"Cancel the request",queryPanelPredefinedRequestSaveButtonTooltip:"Add the current request to the predefined requests",queryPanelResetButtonTooltip:"Reset the request",queryPanelSearchButtonTooltip:"Launch the request",detailsPanelCtTitle:"Details",detailsPanelCtPinToolQtip:"Pin the panel",detailsPanelCtUnpinToolQtip:"Unpin the panel",featuresInformationPanelCtTitle:"Features Information",featuresInformationPanelCtHeight:185,mapMaskMsg:"Loading...",alertErrorTitle:"Error :",alertRequestFailedMsg:"Sorry, the request failed...",dateFormat:"Y/m/d",csvExportAlertTitle:"CSV exportation on IE",csvExportAlertMsg:"<div><H2>For your comfort on Internet Explorer you can:</H2>         <H3>Disable confirmation for file downloads.</H3>         <ul>         <li>In IE, expand the 'Tools' menu</li>         <li>Click on 'Internet Options'</li>         <li>Click on the 'Security' tab</li>         <li>Click on 'Custom Level'</li>         <li>Scroll down to the 'Downloads' part</li>         <li>Enable the confirmation for file download </li>         </ul>         <H3>Disable the file opening in the current window.</H3>         <ul>         <li>Open the workstation</li>         <li>Expand the 'Tools' menu</li>         <li>Click on 'Folder Options ...'</li>         <li>Click on the 'File Types' tab</li>         <li>Select the XLS extension</li>         <li>Click on the 'Advanced' button</li>         <li>Uncheck 'Browse in same window'</li>         </ul></div>",interpolationButtonMenuMaxDistanceTextDefaultValue:5000,autoZoomOnResultsFeatures:false,launchRequestOnPredefinedRequestLoad:true,collapseQueryPanelOnPredefinedRequestLoad:true,featuresInformationSearchNumber:0,tipDefaultWidth:300,openGridDetailsButtonTitle:"See the details",openGridDetailsButtonTip:"Display the row details into the details panel.",seeOnMapButtonTitle:"See on the map",seeOnMapButtonTip:"Zoom and centre on the location on the map.",editDataButtonTitle:"Edit the data",editDataButtonTip:"Go to the edition page to edit the data.",initComponent:function(){this.datasetDS=new Ext.data.JsonStore({url:Genapp.ajax_query_url+"ajaxgetdatasets",method:"POST",autoLoad:true,listeners:{load:{fn:function(d,c,e){for(i=0;i<c.length;i++){if(c[i].data.is_default==="1"){this.datasetComboBox.setValue(c[i].data.id);this.updateDatasetFormsPanel(c[i].data.id);break}}},scope:this}}});this.datasetComboBox=new Ext.form.ComboBox({name:"datasetId",hiddenName:"datasetId",hideLabel:true,store:this.datasetDS,editable:false,displayField:"label",valueField:"id",forceSelection:true,mode:"local",typeAhead:true,width:345,maxHeight:100,triggerAction:"all",emptyText:this.datasetComboBoxEmptyText,selectOnFocus:true,disableKeyFilter:true,listeners:{select:{fn:function(e,c,d){this.updateDatasetFormsPanel(c.data.id)},scope:this}}});this.datasetPanel=new Ext.Panel({region:"north",layout:"form",autoHeight:true,frame:true,margins:"10 0 5 0",cls:"genapp_query_panel_dataset_panel",title:this.datasetPanelTitle,items:this.datasetComboBox});this.formsPanel=new Ext.form.FieldSet({layout:"auto",region:"center",autoScroll:true,cls:"genapp_query_formspanel",frame:true,margins:"5 0 5 0",title:this.formsPanelTitle,keys:{key:Ext.EventObject.ENTER,fn:this.submitRequest,scope:this}});this.gridDSReader=new Ext.data.ArrayReader();this.gridDSReader.updateMetadata=function(c){delete this.ef;this.meta=c;this.recordType=Ext.data.Record.create(c.fields);this.onMetaChange(c,this.recordType,{metaData:c})};this.gridDS=new Ext.data.Store({autoDestroy:true,url:Genapp.ajax_query_url+"ajaxgetresultrows",remoteSort:true,reader:this.gridDSReader});this.pagingToolbar=new Ext.PagingToolbar({pageSize:this.gridPageSize,store:this.gridDS,displayInfo:true});this.pagingToolbar.reset=function(){if(!this.rendered){return}this.afterTextItem.setText(String.format(this.afterPageText,1));this.inputItem.setValue(1);this.first.setDisabled(true);this.prev.setDisabled(true);this.next.setDisabled(true);this.last.setDisabled(true);this.refresh.enable();if(this.displayItem){this.displayItem.setText(this.emptyMsg)}this.fireEvent("change",this,{total:0,activePage:1,pages:1})};this.gridView=new Ext.grid.GridView({autoFill:true,emptyText:this.gridViewEmptyText,deferEmptyText:true});this.gridView.reset=function(){this.mainBody.dom.innerHTML="&#160;"};this.gridPanel=new Ext.grid.GridPanel({frame:true,tabTip:this.gridPanelTabTip,collapsible:true,titleCollapse:true,title:this.gridPanelTitle,header:false,layout:"fit",autoScroll:true,loadMask:true,view:this.gridView,store:this.gridDS,trackMouseOver:false,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),cm:new Ext.grid.ColumnModel({}),bbar:this.pagingToolbar,listeners:{activate:function(c){if(!this.hideCsvExportButton){this.csvExportButton.show()}if(!this.hidePrintMapButton){this.printMapButton.hide()}},scope:this}});this.mapPanel=new Genapp.MapPanel({hideMapDetails:this.hideMapDetails,listeners:{activate:function(c){if(!this.hideCsvExportButton){this.csvExportButton.hide()}if(!this.hidePrintMapButton){this.printMapButton.show()}},scope:this}});this.centerPanel=new Ext.TabPanel({activeItem:0,frame:true,plain:true,region:"center",title:this.centerPanelTitle,items:[this.mapPanel,this.gridPanel]});this.centerPanel.on("render",function(f){var c=f.getEl().query(".x-tab-edge");if(!this.hideUserManualLink){var e=Ext.DomHelper.insertBefore(c[0],{tag:"li",children:[{tag:"a",target:"_blank",href:this.userManualLinkHref,children:[{tag:"span",cls:"x-tab-strip-text genapp-query-center-panel-tab-strip-link",html:this.userManualLinkText}]}]},true);e.on("mousedown",Ext.emptyFn,null,{stopPropagation:true})}function g(h){var j=Ext.DomHelper.insertBefore(c[0],{tag:"li",cls:"genapp-query-center-panel-tab-strip-top-button"},true);j.parent().setWidth("100%");j.on("mousedown",Ext.emptyFn,null,{stopPropagation:true});return new Ext.ComponentMgr.create(Ext.apply({renderTo:j.id},h))}this.mask=new Ext.LoadMask(this.getEl(),{msg:this.mapMaskMsg});this.centerPanel.doLayout();var d=[];if(!this.hideGridCsvExportMenuItem){d.push(this.gridCsvExportMenuItem=new Ext.menu.Item({text:this.gridCsvExportMenuItemText,handler:this.exportCSV.createDelegate(this,["grid-csv-export"]),iconCls:"genapp-query-center-panel-grid-csv-export-menu-item-icon"}))}if(Ext.isEmpty(d)){this.hideCsvExportButton=true}if(!this.hideCsvExportButton){this.csvExportButton=g({xtype:"splitbutton",text:this.csvExportButtonText,disabled:true,menu:this.csvExportButtonMenu=new Ext.menu.Menu({items:d})})}if(!this.hidePrintMapButton){this.printMapButton=g({xtype:"button",iconCls:"genapp-query-center-panel-print-map-button-icon",text:this.printMapButtonText,handler:this.printMap,scope:this})}},this,{single:true});this.queryPanelPinned=true;var a={region:"west",title:this.queryPanelTitle,collapsible:true,margins:"0 5 0 0",titleCollapse:true,width:this.queryPanelWidth,frame:true,layout:"border",cls:"genapp_query_panel",items:[this.datasetPanel,this.formsPanel],tools:[{id:"pin",qtip:this.queryPanelPinToolQtip,hidden:true,handler:function(e,d,c){d.hide();c.header.child(".x-tool-unpin").show();this.queryPanelPinned=true},scope:this},{id:"unpin",qtip:this.queryPanelUnpinToolQtip,handler:function(e,d,c){d.hide();c.header.child(".x-tool-pin").show();this.queryPanelPinned=false},scope:this}],bbar:[{xtype:"tbbutton",text:this.queryPanelCancelButtonText,tooltipType:"title",tooltip:this.queryPanelCancelButtonTooltip,cls:"genapp_query_formspanel_cancel_button",scope:this,handler:this.cancelRequest},{xtype:"tbseparator"},{xtype:"tbbutton",text:this.queryPanelResetButtonText,tooltipType:"title",tooltip:this.queryPanelResetButtonTooltip,cls:"genapp_query_formspanel_reset_button",scope:this,handler:this.resetRequest},{xtype:"tbfill"},{xtype:"tbbutton",text:this.queryPanelSearchButtonText,tooltipType:"title",tooltip:this.queryPanelSearchButtonTooltip,cls:"genapp_query_formspanel_search_button",scope:this,handler:this.submitRequest}]};if(!this.hidePredefinedRequestSaveButton){a.tbar={cls:"genapp_query_panel_tbar",items:[{xtype:"tbbutton",text:this.queryPanelPredefinedRequestSaveButtonText,tooltipType:"title",tooltip:this.queryPanelPredefinedRequestSaveButtonTooltip,iconCls:"genapp-query-panel-predefined-request-save-button-icon",scope:this,handler:function(c,d){}}]}}this.queryPanel=new Ext.FormPanel(a);if(!this.hideRequestVerticalLabel){this.addVerticalLabel(this.queryPanel,"genapp-query-request-panel-ct-xcollapsed-vertical-label-div")}this.detailsPanel=new Ext.TabPanel({frame:true,plain:true,enableTabScroll:true,cls:"genapp-query-details-panel",scrollIncrement:91,scrollRepeatInterval:100,idDelimiter:"___"});this.detailsPanelPinned=true;this.detailsPanelCt=new Ext.Panel({region:"east",title:this.detailsPanelCtTitle,frame:true,split:true,layout:"fit",width:344,minWidth:200,collapsible:true,titleCollapse:true,collapsed:true,items:this.detailsPanel,tools:[{id:"pin",qtip:this.detailsPanelCtPinToolQtip,hidden:true,handler:function(e,d,c){d.hide();c.header.child(".x-tool-unpin").show();this.detailsPanelPinned=true},scope:this},{id:"unpin",qtip:this.detailsPanelCtUnpinToolQtip,handler:function(e,d,c){d.hide();c.header.child(".x-tool-pin").show();this.detailsPanelPinned=false},scope:this}],listeners:{expand:function(){if(this.centerPanel.getActiveTab() instanceof Genapp.MapPanel){this.mapPanel.layersAndLegendsPanel.collapse()}else{this.centerPanel.activate(this.mapPanel);this.mapPanel.layersAndLegendsPanel.collapse();this.centerPanel.activate(this.gridPanel)}},scope:this}});if(!this.hideDetailsVerticalLabel){this.addVerticalLabel(this.detailsPanelCt,"genapp-query-details-panel-ct-xcollapsed-vertical-label-div")}this.featuresInformationPanel=new Ext.TabPanel({frame:true,plain:true,enableTabScroll:true,cls:"genapp-query-locations-panel",scrollIncrement:91,scrollRepeatInterval:100,idDelimiter:"___"});this.featuresInformationPanelPinned=true;this.featuresInformationPanelCt=new Ext.Panel({region:"south",title:this.featuresInformationPanelCtTitle,frame:true,split:true,layout:"fit",height:this.featuresInformationPanelCtHeight,collapsible:true,titleCollapse:true,collapsed:true,items:this.featuresInformationPanel,tools:[{id:"pin",qtip:this.featuresInformationPanelCtPinToolQtip,hidden:true,handler:function(e,d,c){d.hide();c.header.child(".x-tool-unpin").show();this.featuresInformationPanelPinned=true},scope:this},{id:"unpin",qtip:this.featuresInformationPanelCtUnpinToolQtip,handler:function(e,d,c){d.hide();c.header.child(".x-tool-pin").show();this.featuresInformationPanelPinned=false},scope:this}]});var b=[this.centerPanel];if(!this.hideDetails){b.push(this.detailsPanelCt)}if(!this.hideMapDetails&&Genapp.map.featureinfo_maxfeatures!==1){b.push(this.featuresInformationPanelCt)}this.centerPanelCt=new Ext.Panel({layout:"border",region:"center",items:b});if(!this.items){this.items=[this.queryPanel,this.centerPanelCt]}Genapp.ConsultationPanel.superclass.initComponent.call(this)},updateWestPanels:function(b,d,f,e){var a=Ext.decode(b.responseText),c;this.formsPanel.body.update();for(c=0;c<a.data.length;c++){if(!(Ext.isEmpty(a.data[c].criteria)&&Ext.isEmpty(a.data[c].columns))){this.formsPanel.add(new Genapp.FieldForm({title:a.data[c].label,id:a.data[c].id,criteria:a.data[c].criteria,criteriaValues:e,columns:a.data[c].columns}))}}this.formsPanel.doLayout();if(!Ext.isEmpty(f)){if(f.collapseQueryPanel===true){this.queryPanel.collapse()}if(f.launchRequest===true){this.submitRequest()}}},renderLeftTools:function(f,e,a,g,d,b){var c="";if(!this.hideDetails){c='<div class="genapp-query-grid-slip" onclick="Genapp.cardPanel.consultationPage.openDetails(\'{0}\', \'getdetails\');" ext:qtitle="'+this.openGridDetailsButtonTitle+'"ext:qwidth="'+this.tipDefaultWidth+'"ext:qtip="'+this.openGridDetailsButtonTip+'"></div>'}c+='<div class="genapp-query-grid-map" onclick="Genapp.cardPanel.consultationPage.displayLocation(\'{0}\',\'{1}\');" ext:qtitle="'+this.seeOnMapButtonTitle+'"ext:qwidth="'+this.tipDefaultWidth+'"ext:qtip="'+this.seeOnMapButtonTip+'"></div>';return String.format(c,a.data.id,a.data.location_centroid)},renderRightTools:function(f,e,a,g,d,b){var c='<div class="genapp-query-grid-edit" onclick="window.open(Genapp.base_url + \'dataedition/show-edit-data/{0}\');"ext:qtitle="'+this.editDataButtonTitle+'"ext:qwidth="'+this.tipDefaultWidth+'"ext:qtip="'+this.editDataButtonTip+'"></div>';return String.format(c,a.data.id)},openDetails:function(d,a){if(!Ext.isEmpty(d)){var b=Ext.getCmp("consultation_panel");b.collapseQueryPanel();b.detailsPanel.ownerCt.expand();var c=b.detailsPanel.get(d);if(Ext.isEmpty(c)){c=b.detailsPanel.add(new Genapp.DetailsPanel({rowId:d,dataUrl:a}))}b.detailsPanel.activate(c)}},openFeaturesInformationSelection:function(c){this.featuresInformationSearchNumber++;c.featuresInformationSearchNumber=this.featuresInformationSearchNumber;if(!Ext.isEmpty(c.data)){var a=Ext.getCmp("consultation_panel");a.featuresInformationPanel.ownerCt.expand();var b=a.featuresInformationPanel.get(c.id);if(Ext.isEmpty(b)){b=a.featuresInformationPanel.add(new Genapp.CardGridDetailsPanel({initConf:c}))}a.featuresInformationPanel.activate(b)}},launchLocationRequest:function(c,b){if(!Ext.isEmpty(b)){var a=this.formsPanel.get("LOCALISATION_FORM");a.addCriteria("LOCALISATION_FORM__SIT_NO_CLASS",b);this.submitRequest()}},getChildren:function(d,e){var c=Ext.getCmp(d);var b=c.get(e);if(Ext.isEmpty(b)){var a=c.getLayout().activeItem.getId();Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetchildren",success:function(f,g){var h=Ext.decode(f.responseText);h.parentItemId=a;h.ownerCt=c;b=c.add(new Genapp.GridDetailsPanel({initConf:h}));c.getLayout().setActiveItem(b)},failure:function(f,g){console.log("server-side failure with status code "+f.status)},params:{id:e}})}else{c.getLayout().setActiveItem(b)}},displayChildren:function(b){var a=Ext.getCmp("consultation_panel");tab=a.featuresInformationPanel.get(b);if(!Ext.isEmpty(tab)){a.featuresInformationPanel.activate(tab)}else{Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetchildren",success:function(c,e){var f=Ext.decode(c.responseText);var d=Ext.getCmp("consultation_panel");d.openFeaturesInformationSelection(f)},failure:function(c,d){console.log("server-side failure with status code "+c.status)},params:{id:b}})}},getParent:function(b){var a=Ext.getCmp(b);a.getLayout().setActiveItem(Ext.getCmp(a.getLayout().activeItem.parentItemId))},displayLocation:function(c,b){var a=Ext.getCmp("consultation_panel");a.centerPanel.activate(a.mapPanel);a.mapPanel.zoomToFeature(c,b)},cancelRequest:function(){if(this.requestConn&&this.requestConn!==null){this.requestConn.abort();this.gridPanel.loadMask.hide();this.mapMask.hide()}},resetRequest:function(){this.updateDatasetFormsPanel(this.datasetComboBox.getValue())},submitRequest:function(){var c;if(!this.hideCsvExportButton){this.csvExportButton.disable()}this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.request,true,false,true);this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.aggregation,true,true,true);this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.interpolation,true,true,true);if(!this.mapResultLayers){var a=this.mapPanel.layersActivation.request;this.mapResultLayers=[];if(!Ext.isEmpty(a)){for(c=0;c<a.length;c++){var b=this.mapPanel.map.getLayersByName(a[c])[0];b.events.register("loadend",this,function(e){this.mapResultLayersLoadEnd[e.object.name]=1;var d=0;for(b in this.mapResultLayersLoadEnd){if(typeof this.mapResultLayersLoadEnd[b]!=="function"){d+=this.mapResultLayersLoadEnd[b]}}if(d===this.mapResultLayers.length){this.mapMask.hide()}});this.mapResultLayers.push(b)}}}this.mapResultLayersLoadEnd={};for(c=0;c<this.mapResultLayers.length;c++){var b=this.mapResultLayers[c];this.mapResultLayersLoadEnd[b.name]=0}if(!this.mapMask){this.mapMask=new Ext.LoadMask(this.mapPanel.getEl(),{msg:this.mapMaskMsg})}if(this.showGridOnSubmit){this.centerPanel.activate(this.mapPanel);this.mapMask.show();this.centerPanel.activate(this.gridPanel);this.gridPanel.loadMask.show()}else{this.centerPanel.activate(this.gridPanel);this.gridPanel.loadMask.show();this.centerPanel.activate(this.mapPanel);this.mapMask.show()}for(c=0;c<this.mapResultLayersLoadEnd.length;c++){var b=this.mapResultLayersLoadEnd[c];b.display(false)}this.mapPanel.clean();this.clearGrid();Ext.Ajax.on("beforerequest",function(e,d){this.requestConn=e},this,{single:true});this.formsPanel.findParentByType("form").getForm().submit({url:Genapp.ajax_query_url+"ajaxgetresultcolumns",timeout:480000,success:function(g,j){this.requestConn=null;var f=j.result.columns;var e=[{dataIndex:"leftTools",header:"",renderer:this.renderLeftTools.createDelegate(this),sortable:false,fixed:true,menuDisabled:true,align:"center",width:50}];var h=[];var d;var k;for(c=0;c<f.length;c++){d={header:Genapp.util.htmlStringFormat(f[c].label),sortable:true,dataIndex:f[c].name,width:100,tooltip:Genapp.util.htmlStringFormat(f[c].definition),hidden:f[c].hidden};k={name:f[c].name};switch(f[c].type){case"STRING":d.xtype="gridcolumn";k.type="string";break;case"INTEGER":d.xtype="gridcolumn";break;case"NUMERIC":d.xtype="numbercolumn";if(f[c].decimals!==null){d.format=this.numberPattern(".",f[c].decimals)}break;case"DATE":d.xtype="datecolumn";d.format=this.dateFormat;break;default:d.xtype="gridcolumn";k.type="auto";break}e.push(d);h.push(k)}if(!this.hideGridDataEditButton){e.push({dataIndex:"rightTools",header:"",renderer:this.renderRightTools.createDelegate(this),sortable:false,fixed:true,menuDisabled:true,align:"center",width:30})}this.gridDSReader.updateMetadata({root:"rows",fields:h,totalProperty:"total"});if(this.centerPanel.getActiveTab() instanceof Genapp.MapPanel){this.centerPanel.activate(this.gridPanel);this.gridPanel.getColumnModel().setConfig(e);this.centerPanel.activate(this.mapPanel)}else{this.gridPanel.getColumnModel().setConfig(e)}this.gridPanel.getView().reset();Ext.Ajax.on("beforerequest",function(m,l){this.requestConn=m},this,{single:true});this.gridPanel.getStore().load({params:{start:0,limit:this.gridPageSize},callback:function(){this.requestConn=null;this.getResultsBBox();if(this.autoZoomOnResultsFeatures!==true){this.mapPanel.enableLayersAndLegends(this.mapPanel.layersActivation.request,true,true)}this.collapseQueryPanel();this.collapseDetailsPanel();if(!this.hideCsvExportButton){this.csvExportButton.enable()}this.gridPanel.syncSize()},scope:this})},failure:function(d,e){if(e.result&&e.result.errorMessage){Ext.Msg.alert(this.alertErrorTitle,e.result.errorMessage)}else{Ext.Msg.alert(this.alertErrorTitle,this.alertRequestFailedMsg)}this.gridPanel.loadMask.hide();this.mapMask.hide()},scope:this})},collapseQueryPanel:function(){if(!this.queryPanelPinned){this.queryPanel.collapse()}},collapseDetailsPanel:function(){if(!this.detailsPanelPinned){this.detailsPanel.ownerCt.collapse()}},updateFormsPanel:function(b,c,a){this.formsPanel.removeAll(true);this.formsPanel.getUpdater().showLoading();Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetqueryform",success:this.updateWestPanels.createDelegate(this,[c,a],true),method:"POST",params:b,scope:this})},updatePredefinedRequestFormsPanel:function(b,a){this.updateFormsPanel({requestName:b},{launchRequest:this.launchRequestOnPredefinedRequestLoad,collapseQueryPanel:this.collapseQueryPanelOnPredefinedRequestLoad},a)},updateDatasetFormsPanel:function(a){this.updateFormsPanel({datasetId:a})},loadRequest:function(a){this.datasetComboBox.setValue(a.datasetId);this.updatePredefinedRequestFormsPanel(a.name,a.fieldValues)},clearGrid:function(){var a=this.gridPanel.getStore();if(a.getCount()!==0){this.gridPanel.getBottomToolbar().reset()}if(this.gridPanel.rendered){this.gridPanel.getColumnModel().setConfig({});this.gridPanel.getView().updateAllColumnWidths();this.gridPanel.getView().reset()}},exportCSV:function(a){var b=function(d,e,c){this.showMask(true);window.location=Genapp.ajax_query_url+a};if(Ext.isIE&&!this.hideCsvExportAlert){Ext.Msg.show({title:this.csvExportAlertTitle,msg:this.csvExportAlertMsg,cls:"genapp-query-center-panel-csv-export-alert",buttons:Ext.Msg.OK,fn:b,animEl:this.csvExportButton.getEl(),icon:Ext.MessageBox.INFO,scope:this});this.hideCsvExportAlert=true}else{b.call(this)}},printMap:function(d,f){var a=this.mapPanel.map.center,e=this.mapPanel.map.zoom,c;var g=this.mapPanel.map.getLayersBy("visibility",true);var b="";for(c=0;c<g.length;c++){if(g[c].printable!==false){b+=g[c].name+","}}b=b.substr(0,b.length-1);Genapp.util.post(Genapp.base_url+"map/ajaxgeneratemap",{center:a,zoom:e,layers:b})},showMask:function(a){this.mask.show();if(a){window.onfocus=(function(){this.mask.hide();window.onfocus=Ext.emptyFn}).createDelegate(this)}},numberPattern:function(c,e,a){var d=[],b;d.push("0");if(a){d.push(a+"000")}if(e){d.push(c);for(b=0;b<e;b++){d.push("0")}}return d.join("")},hideMask:function(){this.mask.hide()},addVerticalLabel:function(b,a){b.on("collapse",function(c){Ext.get(c.id+"-xcollapsed").createChild({tag:"div",cls:a})},this,{single:true})},getStatus:function(a,b){Ext.Ajax.request({url:Genapp.base_url+a+"/ajax-get-status",success:function(f,d){var c=Ext.decode(f.responseText),e;if(Ext.isEmpty(c.success)||c.success===false){this.hideMask();e="An error occured during the status request.";if(!Ext.isEmpty(c.errorMsg)){e+=" "+c.errorMsg}Ext.Msg.alert("Error...",e)}else{if(c.status==="RUNNING"){this.getStatus.defer(2000,this,[a,b])}else{if(c.status==="OK"){this.hideMask();b.call(this)}else{this.hideMask();e="An error occured during the status request.";if(!Ext.isEmpty(c.errorMsg)){e+=" "+c.errorMsg}Ext.Msg.alert("Error...",e)}}}},failure:function(){this.hideMask();var c="An error occured during the status request.";Ext.Msg.alert("Error...",c)},scope:this})},getResultsBBox:function(){Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetresultsbbox",success:function(e,b){try{var a=Ext.decode(e.responseText);if(Ext.isEmpty(a.success)||a.success===false){if(!Ext.isEmpty(a.errorMsg)){throw (a.errorMsg)}throw ("")}else{if(!Ext.isEmpty(a.resultsbbox)){this.mapPanel.resultsBBox=a.resultsbbox}else{this.mapPanel.resultsBBox=null}if(this.autoZoomOnResultsFeatures===true){if(this.mapPanel.resultsBBox!==null){this.mapPanel.zoomOnBBox(this.mapPanel.resultsBBox)}this.mapPanel.enableLayersAndLegends(this.mapPanel.layersActivation.request,true,true)}}}catch(c){var d="An error occured during the bounding box request.";if(!Ext.isEmpty(c)){d+=" "+c}Ext.Msg.alert("Error...",d)}},failure:function(a,b){var c="An error occured during the bounding box request. Status code : "+a.status;Ext.Msg.alert("Error...",c)},scope:this})}});Ext.reg("consultationpage",Genapp.ConsultationPanel);Genapp.DetailsPanel=Ext.extend(Ext.Panel,{headerWidth:60,closable:true,autoScroll:true,dataUrl:null,cls:"genapp-query-details-panel",hideSeeChildrenButton:false,seeChildrenButtonTitle:"Display the children",seeChildrenButtonTip:"Display the children of the data into the grid details panel.",seeChildrenTextSingular:"&gt;&gt;&gt; See the only child",seeChildrenTextPlural:"&gt;&gt;&gt; See the {children_count} children",tipDefaultWidth:300,loadingMsg:"Loading...",initComponent:function(){this.title='<div style="width:'+this.headerWidth+'px;">'+this.loadingMsg+"</div>";this.on("render",this.updateDetails,this);this.itemId=this.rowId;this.tpl=new Ext.XTemplate('<tpl for="maps">','<img title="{title}" src="{url}">',"</tpl>",'<tpl for="formats">',"<fieldset>",'<legend align="top"> {title} </legend>','<tpl for="fields">',"<p><b>{label} :</b> {value}</p>","</tpl>",'<tpl if="!'+this.hideSeeChildrenButton+'">','<div class="genapp-query-details-panel-see-children" ',"onclick=\"Genapp.cardPanel.consultationPage.displayChildren('{id}');\"",'ext:qtitle="'+this.seeChildrenButtonTitle+'" ','ext:qwidth="'+this.tipDefaultWidth+'" ','ext:qtip="'+this.seeChildrenButtonTip+'">','<tpl if="children_count == 1">',this.seeChildrenTextSingular,"</tpl>",'<tpl if="children_count &gt; 1">',this.seeChildrenTextPlural,"</tpl>","</div>","</tpl>","</fieldset>","</tpl>",{compiled:true,disableFormats:true});Genapp.DetailsPanel.superclass.initComponent.call(this)},updateDetails:function(a){this.getUpdater().showLoading();Ext.Ajax.request({url:Genapp.ajax_query_url+this.dataUrl,success:function(b,c){var d=Ext.decode(b.responseText);this.setTitle('<div style="width:'+this.headerWidth+'px;">'+d.title+"</div>");this.tpl.overwrite(this.body,d)},method:"POST",params:{id:this.rowId},scope:this})}});Genapp.DocSearchPage=Ext.extend(Ext.Panel,{title:"Documents",frame:true,layout:"border",cls:"genapp-doc-search-page",border:false,id:"doc_search_page",ref:"docSearchPage",initComponent:function(){this.westSearchPanel=new Ext.Panel({title:"Filtre(s)",frame:true,items:{xtype:"form",ref:"formPanel",labelWidth:130,bodyStyle:"padding:5px 10px 0",defaults:{width:230},defaultType:"textfield",items:[{xtype:"combo",fieldLabel:"Titre",mode:"local",store:new Ext.data.ArrayStore({id:0,fields:["myId","displayText"],data:[[1,"Titre 1"],[2,"Titre 2"],[3,"..."]]}),valueField:"myId",displayField:"displayText"},{xtype:"combo",fieldLabel:"Auteur"},{xtype:"combo",fieldLabel:"Sujet"},{xtype:"combo",fieldLabel:"Année de Parution"},{xtype:"combo",fieldLabel:"Publication"},{xtype:"combo",fieldLabel:"Référence"},{xtype:"textfield",fieldLabel:"Texte"}],buttons:[{xtype:"button",text:"Effacer filtres",handler:function(){this.westSearchPanel.formPanel.form.reset()},scope:this},{xtype:"button",text:"Filtrer",handler:function(){this.westBottomPanel.expand()},scope:this}]}});var a=[["RENECOFOR - Manuel de référence n°5 pour la collecte de la litière et le traitement des échantillons","litière, fruit, aiguille, gland, faîne, méthodologie, manuel","",2008,"Publications lors de congrès, colloques et séminaires","09-38"],["RENECOFOR - Manuel de référence n°5 pour la collecte de la litière et le traitement des échantillons","litière, fruit, aiguille, gland, faîne, méthodologie, manuel","Ulrich E, Lanier M, Roulet P",1994,"Manuels de référence","17-06"],["RENECOFOR - Manuel de référence n°6 pour l'échantillonnage foliaire, la préparation des échantillons et l'analyse, placette de niveau 1","échantillonnage foliaire, analyse foliaire, aiguille, manuel, méthodologie","Bonneau M, Ulrich E, Adrian M, Lanier M",1993,"Manuels de référence","17-07"],["RENECOFOR - Manuel de référence n°6 pour l'échantillonnage foliaire, la préparation des échantillons et l'analyse, placette de niveau 1","échantillonnage foliaire, analyse foliaire, aiguille, manuel, méthodologie","Croisé L, Bonneau M, Ulrich E, Adrian M, Lanier M",2005,"Manuels de référence","17-08"]];this.westgridPanel=new Ext.grid.GridPanel({region:"center",store:new Ext.data.ArrayStore({autoDestroy:true,data:a,autoLoad:true,idIndex:5,fields:[{name:"title"},{name:"subject"},{name:"authors"},{name:"publication_date",type:"int"},{name:"publication"},{name:"reference"}]}),colModel:new Ext.grid.ColumnModel({defaults:{width:120,sortable:true},columns:[{header:"Titre",width:200,dataIndex:"title"},{header:"Sujet",width:200,dataIndex:"subject"},{header:"Auteurs",dataIndex:"authors"},{header:"Parution",width:50,dataIndex:"publication_date"},{header:"Publication",dataIndex:"publication"},{id:"reference",header:"Référence",width:50,dataIndex:"reference"}]}),sm:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{rowselect:function(d,c,b){this.pdf.reset();this.westDocSlipPanel.update(b.data)},scope:this}}),listeners:{keydown:function(b){if(b.keyCode===b.ENTER){this.onEnter()}},rowdblclick:function(b,d,c){this.onEnter()},scope:this}});this.westDocSlipPanel=new Ext.form.FieldSet({region:"south",data:{title:"-",subject:"-",authors:"-",publication_date:"-",publication:"-",reference:"-"},margins:{top:5,right:0,bottom:0,left:0},tpl:new Ext.Template('<div class="doc-search-page-doc-slip-panel-div">',"<p><b>Titre :</b> {title}</p>","<p><b>Auteurs :</b> {authors}</p>","<p><b>Sujet :</b> {subject}</p>","<p><b>Année de publication :</b> {publication_date}</p>","<p><b>Publication :</b> {publication}</p>","<p><b>Référence :</b> {reference}</p>","</div>",{compiled:true,disableFormats:true})});this.westBottomPanel=new Ext.Panel({title:"Resultat(s)",frame:true,layout:"border",items:[this.westgridPanel,this.westDocSlipPanel]});this.westBottomPanel.on("expand",function(){this.westgridPanel.getSelectionModel().selectFirstRow.defer(300,this.westgridPanel.getSelectionModel())},this,{single:true});this.westPanel=new Ext.Panel({region:"west",layout:"accordion",width:"400px",items:[this.westSearchPanel,this.westBottomPanel]});this.pdf=new Genapp.PDFComponent({xtype:"pdf",url:"pdf"});this.centerPanel=new Ext.Panel({title:"Document",region:"center",frame:true,margins:{top:0,right:0,bottom:0,left:5},items:this.pdf});if(!this.items){this.items=[this.westPanel,this.centerPanel]}Genapp.ConsultationPanel.superclass.initComponent.call(this)},onEnter:function(){var b=this.westgridPanel;var c=b.getSelectionModel();var a=c.getSelections();this.pdf.updateUrl("pdf/"+a[0].data.reference+".pdf")}});Ext.reg("docsearchpage",Genapp.DocSearchPage);Genapp.EditionPanel=Ext.extend(Ext.Panel,{title:"Edition",cls:"genapp_edition_panel",id:"edition_panel",ref:"editionPage",width:500,height:500,items:[{fieldLabel:"First Name",name:"first",allowBlank:false}],initComponent:function(){this.formDS=new Ext.data.JsonStore({url:Genapp.base_url+"dataedition/ajaxgeteditform/SCHEMA/RAW_DATA/FORMAT/SPECIES_DATA/PROVIDER_ID/1/PLOT_CODE/21573-F1000-6-6T/CYCLE/5/SPECIES_CODE/031.001.041",method:"POST",autoLoad:true,fields:[{name:"name",mapping:"name"},{name:"data",mapping:"data"},{name:"format",mapping:"format"},{name:"label",mapping:"label"},{name:"inputType",mapping:"inputType"},{name:"unit",mapping:"unit"},{name:"type",mapping:"type"},{name:"subtype",mapping:"subtype"},{name:"definition",mapping:"definition"},{name:"decimals",mapping:"decimals"},{name:"value",mapping:"value"},{name:"editable",mapping:"editable"},{name:"params",mapping:"params"}],idProperty:"name",listeners:{load:{fn:function(b,a,c){var d;for(d=0;d<a.length;d++){}}},scope:this}});Genapp.EditionPanel.superclass.initComponent.call(this)},getEditFormConfig:function(a){var b={};b.name=a.name;switch(a.inputType){case"SELECT":b.xtype="combo";b.itemCls="trigger-field";b.hiddenName=b.name;b.triggerAction="all";b.typeAhead=true;b.mode="local";b.displayField="label";b.valueField="code";b.emptyText=Genapp.FieldForm.prototype.criteriaPanelTbarComboEmptyText;b.disableKeyFilter=true;if(a.subtype==="DYNAMIC"){b.store=new Ext.data.JsonStore({autoLoad:true,root:"codes",fields:[{name:"code",mapping:"code"},{name:"label",mapping:"label"}],url:"ajaxgetdynamiccodes/unit/"+a.unit})}else{b.store=new Ext.data.ArrayStore({fields:["code","label"],data:a.params.options})}break;case"MULTIPLE":b.xtype="combo";b.itemCls="trigger-field";b.hiddenName=b.name;b.triggerAction="all";b.typeAhead=true;b.mode="local";b.displayField="label";b.valueField="code";b.emptyText=Genapp.FieldForm.prototype.criteriaPanelTbarComboEmptyText;b.disableKeyFilter=true;if(a.subtype==="DYNAMIC"){b.store=new Ext.data.JsonStore({autoLoad:true,root:"codes",fields:[{name:"code",mapping:"code"},{name:"label",mapping:"label"}],url:"ajaxgetdynamiccodes/unit/"+a.unit})}else{b.store=new Ext.data.ArrayStore({fields:["code","label"],data:a.params.options})}break;case"DATE":b.xtype="daterangefield";b.itemCls="trigger-field";b.format=Genapp.FieldForm.prototype.dateFormat;break;case"NUMERIC":b.xtype="numberrangefield";b.itemCls="trigger-field";if(a.type==="RANGE"){b.minValue=a.params.min;b.maxValue=a.params.max}if(a.type==="INTEGER"){b.allowDecimals=false;b.decimalPrecision=0}break;case"CHECKBOX":b.xtype="switch_checkbox";b.ctCls="improvedCheckbox";switch(a.default_value){case 1:case"1":case true:case"true":b.inputValue="1";break;default:b.inputValue="0";break}break;case"RADIO":case"TEXT":switch(a.type){case"INTEGER":b.xtype="numberfield";b.allowDecimals=false;break;case"NUMERIC":b.xtype="numberfield";break;default:b.xtype="textfield";break}break;case"GEOM":b.xtype="geometryfield";b.itemCls="trigger-field";break;case"TREE":b.xtype="treeselectfield";b.enableDD=false;b.animate=true;b.border=false;b.rootVisible=false;b.useArrows=true;b.autoScroll=true;b.containerScroll=true;b.frame=false;b.dataUrl="ajaxgettreenodes/unit/"+a.unit+"/depth/1";b.root={nodeType:"async",text:"Tree Root",id:"*",draggable:false};break;default:b.xtype="field";break}b.value=a.value;b.fieldLabel=a.label;return b}});Ext.reg("editionpage",Genapp.EditionPanel);Genapp.FieldForm=Ext.extend(Ext.Panel,{frame:true,cls:"genapp-query-field-form-panel",criteriaPanelTbarLabel:"Criteria",criteriaPanelTbarComboLoadingText:"searching...",columnsPanelTbarLabel:"Columns",columnsPanelTbarComboEmptyText:"Select...",columnsPanelTbarComboLoadingText:"searching...",columnsPanelTbarAddAllButtonTooltip:"Add all the columns",columnsPanelTbarRemoveAllButtonTooltip:"Remove all the columns",criteriaLabelWidth:120,initComponent:function(){this.criteriaDS=new Ext.data.JsonStore({idProperty:"name",fields:[{name:"name",mapping:"name"},{name:"label",mapping:"label"},{name:"inputType",mapping:"inputType"},{name:"unit",mapping:"unit"},{name:"type",mapping:"type"},{name:"subtype",mapping:"subtype"},{name:"definition",mapping:"definition"},{name:"is_default",mapping:"is_default"},{name:"default_value",mapping:"default_value"},{name:"decimals",mapping:"decimals"},{name:"params",mapping:"params"}],data:this.criteria});this.columnsDS=new Ext.data.JsonStore({idProperty:"name",fields:[{name:"name",mapping:"name"},{name:"label",mapping:"label"},{name:"definition",mapping:"definition"},{name:"is_default",mapping:"is_default"},{name:"decimals",mapping:"decimals"},{name:"params",mapping:"params"}],data:this.columns});this.criteriaPanel=new Ext.Panel({layout:"form",hidden:Ext.isEmpty(this.criteria)?true:false,hideMode:"offsets",labelWidth:this.criteriaLabelWidth,cls:"genapp-query-criteria-panel",defaults:{labelStyle:"padding: 0; margin-top:3px",width:180},listeners:{add:function(b,g,e){var c=g.name,d=0,j,a="",h=g.ownerCt,f="first-child";if(b.defaultType==="panel"){if(e===0){if(g.rendered){g.getEl().addClass(f)}else{if(g.itemCls){g.itemCls+=" "+f}else{g.itemCls=f}}}do{a=c+"["+d+++"]"}while(h.items.findIndex("name",a)!==-1);g.name=g.hiddenName=a}},scope:this},items:this.getDefaultCriteriaConfig(),tbar:[{xtype:"tbfill"},new Ext.Toolbar.TextItem(this.criteriaPanelTbarLabel),{xtype:"tbspacer"},{xtype:"combo",hiddenName:"Criteria",store:this.criteriaDS,editable:false,displayField:"label",valueField:"name",mode:"local",width:220,maxHeight:100,triggerAction:"all",emptyText:this.criteriaPanelTbarComboEmptyText,loadingText:this.criteriaPanelTbarComboLoadingText,listeners:{scope:this,select:{fn:this.addSelectedCriteria,scope:this}}},{xtype:"tbspacer"}]});this.columnsPanel=new Ext.Panel({layout:"form",hidden:Ext.isEmpty(this.columns)?true:false,hideMode:"offsets",cls:"genapp-query-columns-panel",items:this.getDefaultColumnsConfig(),tbar:[{xtype:"tbbutton",tooltip:this.columnsPanelTbarAddAllButtonTooltip,ctCls:"genapp-tb-btn",iconCls:"genapp-tb-btn-add",handler:this.addAllColumns,scope:this},{xtype:"tbbutton",tooltip:this.columnsPanelTbarRemoveAllButtonTooltip,ctCls:"genapp-tb-btn",iconCls:"genapp-tb-btn-remove",handler:this.removeAllColumns,scope:this},{xtype:"tbfill"},new Ext.Toolbar.TextItem(this.columnsPanelTbarLabel),{xtype:"tbspacer"},{xtype:"combo",fieldLabel:"Columns",hiddenName:"Columns",store:this.columnsDS,editable:false,displayField:"label",valueField:"name",mode:"local",width:220,maxHeight:100,triggerAction:"all",emptyText:this.columnsPanelTbarComboEmptyText,loadingText:this.columnsPanelTbarComboLoadingText,listeners:{scope:this,select:{fn:this.addColumn,scope:this}}},{xtype:"tbspacer"}]});if(!this.items){this.items=[this.criteriaPanel,this.columnsPanel]}this.collapsible=true;this.titleCollapse=true;Genapp.FieldForm.superclass.initComponent.call(this);this.doLayout()},addSelectedCriteria:function(c,a,b){if(c!==null){c.clearValue();c.collapse()}this.criteriaPanel.add(this.getCriteriaConfig(a.data,false));this.criteriaPanel.doLayout()},addCriteria:function(c,b){var a=this.criteriaDS.getById(c);a.data.default_value=b;this.criteriaPanel.add(this.getCriteriaConfig(a.data,false));this.criteriaPanel.doLayout()},getDefaultCriteriaConfig:function(){var a=[];this.criteriaDS.each(function(c){if(c.data.is_default){var b=c.data.default_value;if(!Ext.isEmpty(b)){var h=b.split(";"),g=Ext.isEmpty(this.form.criteriaValues),e;for(e=0;e<h.length;e++){var d=c.copy();if(g){d.data.default_value=h[e]}else{var f=this.form.criteriaValues["criteria__"+d.data.name];if(!Ext.isEmpty(f)){if(Ext.isArray(f)){d.data.default_value=f[e]}else{d.data.default_value=f}}else{d.data.default_value=h[e]}}this.items.push(this.form.getCriteriaConfig(d.data,false))}}else{this.items.push(this.form.getCriteriaConfig(c.data))}}},{form:this,items:a});return a},addColumn:function(c,a,b){if(c!==null){c.clearValue();c.collapse()}if(this.columnsPanel.find("name","column__"+a.data.name).length===0){this.columnsPanel.add(this.getColumnConfig(a.data));this.columnsPanel.doLayout()}},getColumnConfig:function(a){var b={xtype:"container",autoEl:"div",cls:"genapp-query-column-item",items:[{xtype:"box",autoEl:{tag:"div",cls:"columnLabelBin",html:"&nbsp;&nbsp;&nbsp;&nbsp;"},listeners:{render:function(c){c.getEl().on("click",function(f,e,d){this.columnsPanel.remove(c.ownerCt)},this,{single:true})},scope:this}},{xtype:"box",autoEl:{tag:"span",cls:"columnLabel","ext:qtitle":Genapp.util.htmlStringFormat(a.label),"ext:qwidth":200,"ext:qtip":Genapp.util.htmlStringFormat(a.definition),html:a.label}},{xtype:"hidden",name:"column__"+a.name,value:"1"}]};return b},getDefaultColumnsConfig:function(){var a=[];this.columnsDS.each(function(b){if(b.data.is_default){this.items.push(this.form.getColumnConfig(b.data))}},{form:this,items:a});return a},addAllColumns:function(){this.columnsDS.each(function(a){this.addColumn(null,a)},this)},removeAllColumns:function(){this.columnsPanel.removeAll()}});Ext.apply(Genapp.FieldForm.prototype,{criteriaPanelTbarComboEmptyText:"Select...",dateFormat:"Y/m/d",getCriteriaConfig:function(b,d){if(!Ext.isEmpty(b.default_value)&&Ext.isString(b.default_value)&&b.default_value.indexOf(";")!==-1){var a=[];var f=b.default_value.split(";"),c;for(c=0;c<f.length;c++){b.default_value=f[c];a.push(Genapp.FieldForm.prototype.getCriteriaConfig(b,d))}return a}var e={};e.name="criteria__"+b.name;switch(b.inputType){case"SELECT":e.xtype="combo";e.itemCls="trigger-field";e.hiddenName=e.name;e.triggerAction="all";e.typeAhead=true;e.displayField="label";e.valueField="code";e.emptyText=Genapp.FieldForm.prototype.criteriaPanelTbarComboEmptyText;if(b.subtype==="DYNAMIC"){e.mode="remote";e.store=new Ext.data.JsonStore({root:"codes",idProperty:"code",fields:[{name:"code",mapping:"code"},{name:"label",mapping:"label"}],url:"ajaxgetdynamiccodes",baseParams:{unit:b.unit}})}else{e.mode="local";e.store=new Ext.data.ArrayStore({fields:["code","label"],data:b.params.options})}break;case"DATE":e.xtype="daterangefield";e.itemCls="trigger-field";e.format=Genapp.FieldForm.prototype.dateFormat;break;case"NUMERIC":e.xtype="numberrangefield";e.itemCls="trigger-field";if(b.type==="RANGE"){e.minValue=b.params.min;e.maxValue=b.params.max}if(b.type==="INTEGER"){e.allowDecimals=false;e.decimalPrecision=0}break;case"CHECKBOX":e.xtype="switch_checkbox";e.ctCls="improvedCheckbox";switch(b.default_value){case 1:case"1":case true:case"true":e.inputValue="1";break;default:e.inputValue="0";break}break;case"RADIO":case"TEXT":switch(b.type){case"INTEGER":e.xtype="numberfield";e.allowDecimals=false;break;case"NUMERIC":e.xtype="numberfield";break;default:e.xtype="textfield";break}break;case"GEOM":e.xtype="geometryfield";e.itemCls="trigger-field";break;case"TREE":e.xtype="treefield";e.dataUrl="ajaxgettreenodes/unit/"+b.unit+"/depth/1";break;default:e.xtype="field";break}if(!Ext.isEmpty(b.default_value)){e.value=b.default_value}if(!Ext.isEmpty(b.fixed)){e.disabled=b.fixed}e.fieldLabel=b.label;if(!d){e.listeners={render:function(j){var h=Ext.get("x-form-el-"+j.id).parent();var k=h.child(".x-form-item-label");k.set({"ext:qtitle":b.label,"ext:qwidth":200,"ext:qtip":b.definition});k.addClass("labelNextBin");var g=h.createChild({tag:"div",cls:"filterBin"},k);g.insertHtml("afterBegin","&nbsp;&nbsp;&nbsp;");g.on("click",function(n,m,l){j.ownerCt.remove(j)},this,{single:true})},scope:this}}return e}});Genapp.GridDetailsPanel=Ext.extend(Ext.grid.GridPanel,{headerWidth:95,closable:true,autoScroll:true,cls:"genapp-query-grid-details-panel",loadingMsg:"Loading...",layout:"fit",openDetailsButtonTitle:"See the details",openDetailsButtonTip:"Display the row details into the details panel.",getChildrenButtonTitle:"Switch to the children",getChildrenButtonTip:"Display the children of the data.",getParentButtonTitle:"Return to the parent",getParentButtonTip:"Display the parent of the data.",tipDefaultWidth:300,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),renderLeftTools:function(f,e,a,g,d,b){var c="";if(!this.hideDetails){c='<div class="genapp-query-grid-details-panel-slip" onclick="Genapp.cardPanel.consultationPage.openDetails(\'{0}\', \'getdetails\');"ext:qtitle="'+this.openDetailsButtonTitle+'"ext:qwidth="'+this.tipDefaultWidth+'"ext:qtip="'+this.openDetailsButtonTip+'"></div>'}if(this.hasChild){c+='<div class="genapp-query-grid-details-panel-get-children" onclick="Genapp.cardPanel.consultationPage.getChildren(\'{1}\',\'{0}\');"ext:qtitle="'+this.getChildrenButtonTitle+'"ext:qwidth="'+this.tipDefaultWidth+'"ext:qtip="'+this.getChildrenButtonTip+'"></div>'}return String.format(c,a.data.id,this.ownerCt.getId(),a.data.LOCATION_COMPL_DATA__SIT_NO_CLASS)},initComponent:function(){this.itemId=this.initConf.id;this.hasChild=this.initConf.hasChild;this.title=this.initConf.title;this.parentItemId=this.initConf.parentItemId;this.ownerCt=this.initConf.ownerCt;this.store=new Ext.data.ArrayStore({autoDestroy:true,idIndex:0,fields:this.initConf.fields,data:this.initConf.data});var b;var a=this.initConf.columns;for(b=0;b<a.length;b++){a[b].header=Genapp.util.htmlStringFormat(a[b].header);a[b].tooltip=Genapp.util.htmlStringFormat(a[b].tooltip)}var c="";if(!Ext.isEmpty(this.parentItemId)){c='<div class="genapp-query-grid-details-panel-get-parent" onclick="Genapp.cardPanel.consultationPage.getParent(\''+this.ownerCt.getId()+'\');"ext:qtitle="'+this.getParentButtonTitle+'"ext:qwidth="'+this.tipDefaultWidth+'"ext:qtip="'+this.getParentButtonTip+'"></div>'}this.initConf.columns.unshift({dataIndex:"leftTools",header:c,renderer:this.renderLeftTools.createDelegate(this),sortable:false,fixed:true,menuDisabled:true,align:"center",width:70});this.colModel=new Ext.grid.ColumnModel({defaults:{width:100,sortable:true},columns:a});Genapp.GridDetailsPanel.superclass.initComponent.call(this)}});Genapp.MapPanel=Ext.extend(Ext.Panel,{frame:true,collapsible:true,titleCollapse:true,title:"Map",header:false,layout:"border",isDrawingMap:false,featureWKT:null,tabTip:"The map with the request's results's location",hideLayersAndLegendVerticalLabel:false,rightPanelCollapsed:false,rightPanelWidth:170,layerPanelTitle:"Layers",layerPanelTabTip:"The layers's tree",legendPanelTitle:"Legends",legendPanelTabTip:"The layers's legends",panZoomBarControlTitle:"Zoom",navigationControlTitle:"Drag the map",selectFeatureControlTitle:"Select Feature",invalidWKTMsg:"The feature cannot be displayed",zoomToFeaturesControlTitle:"Zoom to the features",drawFeatureControlTitle:"Draw a polygon",modifyFeatureControlTitle:"Update the feature",tbarDeleteFeatureButtonTooltip:"Delete the feature",tbarPreviousButtonTooltip:"Previous Position",tbarNextButtonTooltip:"Next Position",zoomBoxInControlTitle:"Zoom in",zoomBoxOutControlTitle:"Zoom out",zoomToMaxExtentControlTitle:"Zoom to max extend",featureInfoControlTitle:"Get the plot location information",hideLegalMentions:true,legalMentionsLinkHref:Genapp.base_url+"map/show-legal-mentions",legalMentionsLinkText:"Legal Mentions",minZoomLevel:0,resultsBBox:null,layersActivation:{},projectionLabel:" m (L2e)",initComponent:function(){this.addEvents("afterinit");this.toolbar=new mapfish.widgets.toolbar.Toolbar({configurable:false});this.layersAndLegendsPanel=new Ext.TabPanel({region:"east",width:this.rightPanelWidth,collapsed:this.rightPanelCollapsed,collapsible:true,titleCollapse:false,cls:"genapp-query-map-right-panel",activeItem:0,split:true,items:[this.layerPanel=new Ext.Panel({layout:"fit",cls:"genapp-query-layer-tree-panel",title:this.layerPanelTitle,tabTip:this.layerPanelTabTip,frame:true,layoutConfig:{animate:true}}),this.legendPanel=new Ext.Panel({cls:"genapp-query-legend-panel",title:this.legendPanelTitle,tabTip:this.legendPanelTabTip,frame:true,layoutConfig:{animate:true}})]});if(!this.hideLayersAndLegendVerticalLabel){this.layersAndLegendsPanel.on("collapse",function(a){Ext.get(a.id+"-xcollapsed").createChild({tag:"div",cls:"genapp-query-map-right-panel-xcollapsed-vertical-label-div"})},this,{single:true})}this.items=[this.mapPanel=new Ext.Panel({region:"center",cls:"genapp_query_mappanel",frame:true,layout:"fit",tbar:this.toolbar,xtype:"panel",listeners:{render:function(a){a.body.setStyle("width","100%");a.body.setStyle("height","100%");Ext.Ajax.request({url:Genapp.base_url+"map/getLayers",success:function(c,e){var d=Ext.decode(c.responseText),f;this.layersList=[];this.layersActivation={};for(f=0;f<d.layers.length;f++){var h;if(d.layers[f].untiled){h=new OpenLayers.Layer.WMS.Untiled(d.layers[f].name,d[d.layers[f].url],d.layers[f].params,d.layers[f].options)}else{h=new OpenLayers.Layer.WMS(d.layers[f].name,d[d.layers[f].url],d.layers[f].params,d.layers[f].options)}this.layersList.push(h);var b=d.layers[f].params.activateType.toLowerCase();if(Ext.isEmpty(this.layersActivation[b])){this.layersActivation[b]=[d.layers[f].name]}else{this.layersActivation[b].push(d.layers[f].name)}if(d.layers[f].hasLegend){var g=a.ownerCt.items.get(1).items.get(1).add(new Ext.BoxComponent({id:this.id+d.layers[f].name,autoEl:{tag:"div",children:[{tag:"span",html:d.layers[f].options.label,cls:"x-form-item x-form-item-label"},{tag:"img",src:Genapp.base_url+"proxy/getlegendimage?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetLegendGraphic&Format=image/png&WIDTH=160&LAYER="+d.layers[f].params.layers+"&HASSLD="+(d.layers[f].params.hasSLD?"true":"false")}]}}));if(d.layers[f].params.isDisabled||d.layers[f].params.isHidden||!d.layers[f].params.isChecked){g.on("render",function(j){j.hide()});g.on("show",(function(j,k){if(j.rendered){j.getEl().child("img").dom.src=Genapp.base_url+"proxy/getlegendimage?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetLegendGraphic&Format=image/png&WIDTH=160&LAYER="+k.layers+"&HASSLD="+(k.hasSLD?"true":"false")+"&dc="+(new Date()).getTime()}}).createCallback(g,d.layers[f].params))}}}a.ownerCt.items.get(1).items.get(1).doLayout();this.initMap(a.body.id);a.on("bodyresize",this.map.updateSize,this.map);if(!this.hideLegalMentions){a.el.createChild({tag:"div",cls:"genapp-map-panel-legal-mentions",children:[{tag:"a",target:"_blank",href:this.legalMentionsLinkHref,html:this.legalMentionsLinkText}]},a.el.child(".olMapViewport",true)).on("click",Ext.emptyFn,null,{stopPropagation:true})}Ext.Ajax.request({url:Genapp.base_url+"map/get-tree-layers",success:function(j,k){this.layerTreeModel=Ext.decode(j.responseText);this.initLayerTree();a.ownerCt.items.get(1).items.get(0).add(this.layertree);a.ownerCt.items.get(1).items.get(0).doLayout();this.initToolbar();a.ownerCt.items.get(0).getTopToolbar().doLayout();this.fireEvent("afterinit",this)},scope:this})},scope:this})},scope:this}}),this.layersAndLegendsPanel];Genapp.MapPanel.superclass.initComponent.call(this)},initMap:function(d){var a=[],f;for(f=this.minZoomLevel;f<Genapp.map.resolutions.length;f++){a.push(Genapp.map.resolutions[f])}this.map=new OpenLayers.Map(d,{controls:[],resolutions:a,projection:Genapp.map.projection,units:"m",tileSize:new OpenLayers.Size(Genapp.map.tilesize,Genapp.map.tilesize),maxExtent:new OpenLayers.Bounds(Genapp.map.x_min,Genapp.map.y_min,Genapp.map.x_max,Genapp.map.y_max),eventListeners:{changelayer:function(h){if(h.property==="visibility"){this.toggleLayersAndLegendsForZoom(h.layer)}},scope:this}});this.wktFormat=new OpenLayers.Format.WKT();this.vectorLayer=new OpenLayers.Layer.Vector("Vector Layer",{printable:false});var c=new OpenLayers.Layer("Empty baselayer",{isBaseLayer:true,printable:false});this.map.addLayer(c);for(f=0;f<this.layersList.length;f++){this.map.addLayer(this.layersList[f])}this.map.addLayer(this.vectorLayer);this.map.addControl(new OpenLayers.Control.PanZoomBar({title:this.panZoomBarControlTitle}));this.map.addControl(new OpenLayers.Control.MousePosition({prefix:"X: ",separator:" - Y: ",suffix:this.projectionLabel,numDigits:0,title:"MousePosition"}));this.map.addControl(new OpenLayers.Control.Scale());this.map.addControl(new OpenLayers.Control.ScaleLine({title:"ScaleLine",bottomOutUnits:"",bottomInUnits:""}));this.map.setCenter(new OpenLayers.LonLat(Genapp.map.x_center,Genapp.map.y_center),Genapp.map.defaultzoom);if(this.isDrawingMap){this.vectorLayer.preFeatureInsert=function(h){if(this.features.length>1){this.removeFeatures([this.features[0]])}};var b=new OpenLayers.Control.SelectFeature(this.vectorLayer,{multiple:false,clickout:true,toggle:true,title:this.selectFeatureControlTitle});this.map.addControl(b);b.activate();if(this.featureWKT){var e=this.wktFormat.read(this.featureWKT);if(e){this.vectorLayer.addFeatures([e])}else{alert(this.invalidWKTMsg)}}}else{var g=new OpenLayers.Control.SelectFeature(this.vectorLayer,{hover:true});this.map.addControl(g);g.activate()}},initLayerTree:function(){var a;this.layertree=new mapfish.widgets.LayerTree({title:"",border:false,map:this.map,model:this.layerTreeModel,enableDD:true,listeners:{afterrender:function(){for(a=0;a<this.map.layers.length;a++){this.toggleLayersAndLegendsForZoom(this.map.layers[a])}},scope:this},plugins:[{init:function(b){b.getRootNode().cascade(function(c){if(c.attributes.disabled===true){c.forceDisable=true}else{c.forceDisable=false}})}},mapfish.widgets.LayerTree.createContextualMenuPlugin(["opacitySlide"])],ascending:false});this.map.setLayerIndex(this.vectorLayer,100)},initToolbar:function(){this.toolbar.map=this.map;if(this.isDrawingMap){this.toolbar.addControl(new OpenLayers.Control.ZoomToFeatures(this.vectorLayer,{title:this.zoomToFeaturesControlTitle,maxZoomLevel:9,ratio:1.05,autoActivate:true}),{iconCls:"zoomstations"});this.toolbar.addControl(new OpenLayers.Control.DrawFeature(this.vectorLayer,OpenLayers.Handler.Polygon),{iconCls:"drawpolygon",tooltip:this.drawFeatureControlTitle});this.toolbar.addControl(new OpenLayers.Control.ModifyFeature(this.vectorLayer,{displayClass:"olControlModifyFeature",deleteCodes:[46,100],type:OpenLayers.Control.TYPE_TOOL,title:this.modifyFeatureControlTitle}),{iconCls:"modifyfeature",disabled:false});var b=new Ext.Toolbar.Button({iconCls:"deletefeature",tooltip:this.tbarDeleteFeatureButtonTooltip,disabled:false,handler:OpenLayers.Function.bind(function(){if(this.vectorLayer.features.length){var e=this.map.getControlsBy("title",this.selectFeatureControlTitle);if(this.vectorLayer.selectedFeatures.length){e[0].unselect(this.vectorLayer.selectedFeatures[0])}this.vectorLayer.removeFeatures(this.vectorLayer.features)}else{}},this)});this.toolbar.add(b)}this.toolbar.addFill();var c=new OpenLayers.Control.NavigationHistory({});this.map.addControl(c);c.activate();var d=new Ext.Toolbar.Button({iconCls:"back",tooltip:this.tbarPreviousButtonTooltip,disabled:true,handler:c.previous.trigger});var a=new Ext.Toolbar.Button({iconCls:"next",tooltip:this.tbarNextButtonTooltip,disabled:true,handler:c.next.trigger});this.toolbar.add(d);this.toolbar.add(a);c.previous.events.register("activate",d,function(){this.setDisabled(false)});c.previous.events.register("deactivate",d,function(){this.setDisabled(true)});c.next.events.register("activate",a,function(){this.setDisabled(false)});c.next.events.register("deactivate",a,function(){this.setDisabled(true)});this.toolbar.addSeparator();if(!this.hideMapDetails){this.toolbar.addControl(new OpenLayers.Control.FeatureInfoControl(),{iconCls:"feature-info",tooltip:this.featureInfoControlTitle})}this.toolbar.addControl(new OpenLayers.Control.ZoomBox({title:this.zoomBoxInControlTitle}),{iconCls:"zoomin"});this.toolbar.addControl(new OpenLayers.Control.ZoomBox({out:true,title:this.zoomBoxOutControlTitle}),{iconCls:"zoomout"});this.toolbar.addControl(new OpenLayers.Control.Navigation({isDefault:true,title:this.navigationControlTitle,mouseWheelOptions:{interval:100}}),{iconCls:"pan"});this.toolbar.addSeparator();this.toolbar.addButton({handler:this.zoomOnResultsBBox,scope:this,iconCls:"zoomstations",tooltip:this.zoomToFeaturesControlTitle});this.toolbar.addControl(new OpenLayers.Control.ZoomToMaxExtent({map:this.map,active:true,title:this.zoomToMaxExtentControlTitle}),{iconCls:"zoomfull"});this.toolbar.activate()},clean:function(){this.vectorLayer.destroyFeatures(this.vectorLayer.features)},zoomToFeature:function(c,b){var a=this.wktFormat.read(b);a.attributes.id=c.substring(c.lastIndexOf("__")+2);this.vectorLayer.destroyFeatures(this.vectorLayer.features);this.map.setLayerIndex(this.vectorLayer,100);if(a){this.vectorLayer.addFeatures([a])}else{alert(this.invalidWKTMsg)}this.map.setCenter(new OpenLayers.LonLat(a.geometry.x,a.geometry.y),7)},zoomOnBBox:function(g){if(!Ext.isEmpty(g)){var h=this.map;var d=1;var a=h.numZoomLevels-1;var c=this.wktFormat.read(g);var f=c.geometry.getBounds();f=f.scale(d);if((f.getWidth()===0)&&(f.getHeight()===0)){var e=a}else{var b=h.getZoomForExtent(f);var e=(b>a)?a:b}h.setCenter(f.getCenterLonLat(),e)}},zoomOnResultsBBox:function(){this.zoomOnBBox(this.resultsBBox)},toggleLayersAndLegends:function(e){var f=[],c=[],d=[],a=[],b;for(b in e){if(e.hasOwnProperty(b)){switch(e[b]){case"checked":f.push(b);break;case"unchecked":c.push(b);break;case"disable":d.push(b);break;case"hide":a.push(b);break;default:break}}}this.enableLayersAndLegends(f,true,true);this.enableLayersAndLegends(c,false,true);this.disableLayersAndLegends(d,true,false,true);this.disableLayersAndLegends(a,true,true,true)},enableLayersAndLegends:function(g,b,f){var a=this.layerPanel.isVisible(),c;this.layersAndLegendsPanel.activate(this.layerPanel);for(c=0;c<g.length;c++){var e=this.layertree.layerToNodeIds[g[c]];if(!Ext.isEmpty(e)){if(f!==false){this.layertree.getNodeById(e).forceDisable=false}if(this.layertree.getNodeById(e).zoomDisable!==true){this.layertree.getNodeById(e).enable()}this.layertree.getNodeById(e).getUI().show();if(b===true){var d=this.map.getLayersByName(g[c]);d[0].redraw(true);this.layertree.setNodeChecked(e,true)}}}this.layersAndLegendsPanel.activate(this.legendPanel);this.setLegendsVisible(g,true);if(a){this.layersAndLegendsPanel.activate(this.layerPanel)}},disableLayersAndLegends:function(g,a,c,f){var b;if(!Ext.isEmpty(g)){for(b=0;b<g.length;b++){var e=this.layertree.layerToNodeIds[g[b]];if(!Ext.isEmpty(e)){if(a===true){this.layertree.setNodeChecked(e,false)}var d=this.layertree.getNodeById(e);if(c===true){d.getUI().hide()}d.disable();if(f!==false){d.forceDisable=true}}this.setLegendsVisible([g[b]],false)}}},toggleLayersAndLegendsForZoom:function(a){if(!Ext.isEmpty(this.layertree)){var c=this.layertree.layerToNodeIds[a.name];if(!Ext.isEmpty(c)){var b=this.layertree.getNodeById(c);if(!Ext.isEmpty(b)&&!b.hidden){if(!a.calculateInRange()){b.zoomDisable=true;this.disableLayersAndLegends([a.name],false,false,false)}else{b.zoomDisable=false;if(b.forceDisable!==true){this.enableLayersAndLegends([a.name],false,false)}}}}}},setLegendsVisible:function(e,d){var b;for(b=0;b<e.length;b++){var a=this.legendPanel.findById(this.id+e[b]);if(!Ext.isEmpty(a)){if(d===true){var c=this.map.getLayersByName(e[b]);if(c[0].calculateInRange()&&c[0].getVisibility()){a.show()}else{a.hide()}}else{a.hide()}}}},beforeDestroy:function(){if(this.map){this.map.destroy()}Genapp.MapPanel.superclass.beforeDestroy.call(this)}});Genapp.PDFComponent=Ext.extend(Ext.BoxComponent,{mimeType:"application/pdf",url:null,initComponent:function(){Ext.Panel.superclass.initComponent.call(this);this.on("render",function(a){if(Ext.isEmpty(this.url)){this.updateElement()}else{this.el=Ext.get(Ext.DomHelper.overwrite(this.ownerCt.body.dom,{tag:"span",html:"Veuillez selectionner un document..."}))}},this)},updateUrl:function(a){this.url=a;this.updateElement()},updateElement:function(){this.el=Ext.get(Ext.DomHelper.overwrite(this.ownerCt.body.dom,{tag:"object",data:this.url,type:this.mimeType,width:"100%",height:"100%",html:'<h4>Content on this page requires Adobe Acrobat Reader.</h4>                 <p>You must have the free Adobe Reader program installed on your computer                 to view the documents marked &quot;(PDF).&quot;                 <p>Download the <a href="http://www.adobe.com/products/acrobat/readstep2.html">                 free Adobe Reader program</a>.</p>                 <p><a href="http://www.adobe.com/products/acrobat/readstep2.html">                <img src="http://www.adobe.com/images/shared/download_buttons/get_adobe_reader.gif"                 width="88" height="31" border="0" alt="Get Adobe Reader." />                </a></p></p>Direct link to the document: <a href="'+this.url+'">'+this.url+"</a>"}))},reset:function(){if(this.url!==null){this.el=Ext.get(Ext.DomHelper.overwrite(this.ownerCt.body.dom,{tag:"span",html:"Veuillez selectionner un document..."}));this.url=null}}});Ext.reg("pdf",Genapp.PDFComponent);Genapp.PredefinedRequestPanel=Ext.extend(Ext.Panel,{id:"predefined_request",ref:"predefinedRequestPage",frame:true,title:"Predefined Request",layout:"border",consultationButtonText:"Consultation",consultationButtonTooltip:"Go to the consultation page",descriptionTitle:"",nameColumnHeader:"Name",labelColumnHeader:"Label",descriptionColumnHeader:"Description",dateColumnHeader:"Date",clickColumnHeader:"Click(s)",positionColumnHeader:"Rank",groupNameColumnHeader:"Group name",groupLabelColumnHeader:"Group label",groupPositionColumnHeader:"Group Rank",groupTextTpl:"{group} ({[values.rs.length]})",resetButtonText:"Reset",resetButtonTooltip:"Reset the form with the default values",launchRequestButtonText:"Launch the request",launchRequestButtonTooltip:"Launch the request in the consultation page",loadingText:"Loading...",defaultCardPanelText:"Please select a request...",defaultErrorCardPanelText:"Sorry, the loading failed...",criteriaPanelTitle:"Request criteria",initComponent:function(){var e=new Ext.data.ArrayReader({root:"rows",totalProperty:"total"},[{name:"request_name",type:"string"},{name:"label",type:"string"},{name:"definition",type:"string"},{name:"click",type:"int"},{name:"date",type:"date",dateFormat:"Y-m-d"},{name:"criteria_hint",type:"string"},{name:"position",type:"int"},{name:"group_name",type:"string"},{name:"group_label",type:"string"},{name:"group_position",type:"int"},{name:"dataset_id",type:"string"}]);var d=new Ext.data.GroupingStore({reader:e,autoDestroy:true,url:Genapp.ajax_query_url+"ajaxgetpredefinedrequestlist",remoteSort:false,sortInfo:{field:"position",direction:"ASC"},groupField:"group_position"});var c=[];if(!Ext.isEmpty(this.descriptionTitle)){c.push('<h4 class="genapp-predefined-request-grid-panel-description-title">'+this.descriptionTitle+":</h4>")}c.push('<p class="genapp-predefined-request-grid-panel-description-text">{definition}</p>');var f=new Ext.ux.grid.RowExpander({tpl:new Ext.Template(c)});var b=function(j,h,l,n,k,m,g){return l.data[g]};var a=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{id:"request_name",header:this.nameColumnHeader,dataIndex:"request_name",width:30,groupable:false,hidden:true},{header:this.labelColumnHeader,dataIndex:"label",groupable:false},{header:this.descriptionColumnHeader,dataIndex:"definition",groupable:false,hidden:true},{header:this.dateColumnHeader,dataIndex:"date",format:"Y/m/d",xtype:"datecolumn",width:20,groupable:false,hidden:true},{header:this.clickColumnHeader,dataIndex:"click",width:10,groupable:false,hidden:true},{header:this.positionColumnHeader,dataIndex:"position",width:10,groupable:false,hidden:true},{header:this.groupNameColumnHeader,dataIndex:"group_name",hidden:true,groupRenderer:b.createDelegate(this,["group_label"],true)},{header:this.groupLabelColumnHeader,dataIndex:"group_label",hidden:true},{header:this.groupPositionColumnHeader,dataIndex:"group_position",width:10,hidden:true,groupRenderer:b.createDelegate(this,["group_label"],true)}]});this.grid=new Ext.grid.GridPanel({region:"center",autoExpandColumn:1,border:true,plugins:f,ds:d,cm:a,view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:this.groupTextTpl}),sm:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{rowselect:this.onGridRowSelect,scope:this}})});this.requestCriteriaCardPanel=new Ext.form.FieldSet({cls:"genapp-predefined-request-criteria-card-panel",layout:"card",autoScroll:true,activeItem:2,labelWidth:90,title:" ",defaults:{width:140,border:false},width:350,border:true,fbar:this.requestCriteriaCardPanelFooterTBar=new Ext.Toolbar({hidden:true,cls:"genapp-predefined-request-criteria-panel-footerTBar",items:[this.resetButton=new Ext.Button({text:this.resetButtonText,listeners:{render:function(g){new Ext.ToolTip({anchor:"left",target:g.getEl(),html:this.resetButtonTooltip,showDelay:Ext.QuickTips.getQuickTip().showDelay,dismissDelay:Ext.QuickTips.getQuickTip().dismissDelay})},scope:this},handler:function(g,j){var h=this.grid.getSelectionModel().getSelected();this.requestCriteriaCardPanel.getComponent(h.data.request_name).getForm().reset()},scope:this}),this.launchRequestButton=new Ext.Button({text:this.launchRequestButtonText,listeners:{render:function(g){new Ext.ToolTip({anchor:"left",target:g.getEl(),html:this.launchRequestButtonTooltip,showDelay:Ext.QuickTips.getQuickTip().showDelay,dismissDelay:Ext.QuickTips.getQuickTip().dismissDelay})},scope:this},handler:function(g,k){var l=this.grid.getSelectionModel().getSelected().data;var j=this.requestCriteriaCardPanel.getComponent(l.request_name).getForm().getValues();var h=Ext.getCmp("consultation_panel");h.loadRequest({datasetId:l.dataset_id,name:l.request_name,fieldValues:j});Genapp.cardPanel.activate("consultation_panel")},scope:this})]}),items:[{xtype:"box",autoEl:{tag:"div",cls:"loading-indicator",html:this.loadingText}},{xtype:"box",autoEl:{tag:"div",cls:"genapp-predefined-request-criteria-panel-error-msg",html:this.defaultErrorCardPanelText}},{xtype:"box",autoEl:{tag:"div",cls:"genapp-predefined-request-criteria-panel-intro",html:this.defaultCardPanelText}}]});this.eastPanel=new Ext.Panel({region:"east",width:"350px",cls:"genapp-predefined-request-east-panel",margins:{top:0,right:0,bottom:0,left:5},items:this.requestCriteriaCardPanel});this.items=[this.grid,this.eastPanel];this.listeners={activate:function(){var g=this.grid.getSelectionModel().getSelected();this.grid.getStore().reload({callback:function(j,k,l){if(l){if(!Ext.isEmpty(g)){var h=this.grid.getStore().findExact("request_name",g.data.request_name);this.grid.getSelectionModel().selectRow(h);this.grid.plugins.expandRow(h)}}else{console.log("Request failure: ");console.log("records:",j,"options:",k);this.requestCriteriaCardPanel.getLayout().setActiveItem(1)}},scope:this})},scope:this};Genapp.PredefinedRequestPanel.superclass.initComponent.call(this)},onGridRowSelect:function(c,b,a){this.requestCriteriaCardPanel.setTitle("");this.requestCriteriaCardPanelFooterTBar.hide();this.requestCriteriaCardPanel.getLayout().setActiveItem(0);if(Ext.isEmpty(this.requestCriteriaCardPanel.getComponent(a.data.request_name))){Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetpredefinedrequestcriteria",success:function(f,h){var g;var e=new Ext.data.ArrayReader({root:"criteria",fields:["name","format","data","default_value","fixed","inputType","type","label","definition","params"]});var d=e.readRecords(Ext.decode(f.responseText));var j=new Ext.form.FormPanel({itemId:a.data.request_name,labelWidth:130,autoHeight:true,defaults:{labelStyle:"padding: 0; margin-top:3px",width:180},items:{xtype:"box",autoEl:{tag:"div",cls:"genapp-predefined-request-criteria-panel-criteria-hint",style:"width:200px;",html:a.data.criteria_hint}}});for(g=0;g<d.records.length;g++){j.add(Genapp.FieldForm.prototype.getCriteriaConfig(d.records[g].data,true))}this.requestCriteriaCardPanel.add(j);this.showCriteriaPanel(a.data.request_name);this.requestCriteriaCardPanel.doLayout()},failure:function(d,e){console.log("Request failure: "+d.statusText);console.log("Response:",d,"Options:",e);this.requestCriteriaCardPanel.getLayout().setActiveItem(1)},params:{request_name:a.data.request_name},scope:this})}else{this.showCriteriaPanel(a.data.request_name)}},showCriteriaPanel:function(a){this.requestCriteriaCardPanel.setTitle(this.criteriaPanelTitle);this.requestCriteriaCardPanelFooterTBar.show();this.requestCriteriaCardPanel.getLayout().setActiveItem(a)}});Ext.reg("predefinedrequestpage",Genapp.PredefinedRequestPanel);Ext.namespace("Genapp.form");Genapp.form.DateRangeField=Ext.extend(Ext.form.DateField,{minText:"The dates in this field must be equal to or after {0}",maxText:"The dates in this field must be equal to or before {0}",reverseText:"The end date must be posterior to the start date",notEqualText:"The end date can't be equal to the start date",dateSeparator:" - ",endDatePrefix:"<= ",startDatePrefix:">= ",usePrefix:true,hideValidationButton:false,authorizeEqualValues:true,mergeEqualValues:true,autoReverse:true,minValue:new Date(0),maxValue:new Date(2999,11,31),minDefaultValue:new Date(),maxDefaultValue:new Date(),setDisabledDates:function(a){this.disabledDates=a;this.initDisabledDays();if(this.menu){this.menu.rangePicker.startDatePicker.setDisabledDates(this.disabledDatesRE);this.menu.rangePicker.endDatePicker.setDisabledDates(this.disabledDatesRE)}},setDisabledDays:function(a){this.disabledDays=a;if(this.menu){this.menu.rangePicker.startDatePicker.setDisabledDays(a);this.menu.rangePicker.endDatePicker.setDisabledDays(a)}},setMinValue:function(a){this.minValue=(typeof a==="string"?this.parseDate(a):a);if(this.menu){this.menu.rangePicker.startDatePicker.setMinDate(this.minValue);this.menu.rangePicker.endDatePicker.setMinDate(this.minValue)}},setMaxValue:function(a){this.maxValue=(typeof a==="string"?this.parseDate(a):a);if(this.menu){this.menu.rangePicker.startDatePicker.setMaxDate(this.maxValue);this.menu.rangePicker.endDatePicker.setMaxDate(this.maxValue)}},getErrors:function(c){var e=Ext.form.DateField.superclass.getErrors.apply(this,arguments);c=this.formatDate(c||this.processValue(this.getRawValue()));if(c.length<1){return e}var a=c.split(this.dateSeparator);if(a.length!==1&&a.length!==2){e.push(String.format(this.invalidText,c,this.format+this.dateSeparator+this.format));return e}var d=this.parseRangeDate(c);if(a.length===1){if(!d){e.push(String.format(this.invalidText,c,this.format));return e}var b=Ext.form.DateField.superclass.getErrors.call(this,c);if(!Ext.isEmpty(b)){e.push(String.format(this.invalidText,c,this.format));return e}}else{if(a.length===2){if(!d){e.push(String.format(this.invalidText,c,this.format+this.dateSeparator+this.format));return e}var b=Ext.form.DateField.superclass.getErrors.call(this,c);if(!Ext.isEmpty(b)){e.push(String.format(this.invalidText,c,this.format+this.dateSeparator+this.format));return e}if(d.endDate.getTime()-d.startDate.getTime()<0){e.push(this.reverseText);return e}if(!this.authorizeEqualValues&&d.endDate.getElapsed(d.startDate)===0){e.push(this.notEqualText);return e}}}if(d.startDate!==null){if(d.startDate.getTime()-this.minValue.getTime()<0){e.push(String.format(this.minText,this.formatDate(this.minValue)));return e}if(this.maxValue.getTime()-d.startDate.getTime()<0){e.push(String.format(this.maxText,this.formatDate(this.maxValue)));return e}}if(d.endDate!==null){if(d.endDate.getTime()-this.minValue.getTime()<0){e.push(String.format(this.minText,this.formatDate(this.minValue)));return e}if(this.maxValue.getTime()-d.endDate.getTime()<0){e.push(String.format(this.maxText,this.formatDate(this.maxValue)));return e}}return e},parseRangeDate:function(j){if(!j){return null}if(this.isRangeDate(j)){return j}if(Ext.isDate(j)){return{startDate:j,endDate:j}}var k=j.split(this.dateSeparator);if(k.length===1){var c=j.indexOf(this.startDatePrefix,0);var h=j.indexOf(this.endDatePrefix,0);if(c!==-1){var a=this.parseDate.call(this,j.substring(c+this.startDatePrefix.length));if(a){return{startDate:a,endDate:null}}else{return null}}else{if(h!==-1){var e=this.parseDate.call(this,j.substring(h+this.endDatePrefix.length));if(e){return{startDate:null,endDate:e}}else{return null}}else{var b=this.parseDate.call(this,j);if(b){return{startDate:b,endDate:b}}else{return null}}}}else{if(k.length===2){var l=Date.parseDate(k[0],this.format);var g=Date.parseDate(k[1],this.format);if((!l||!g)&&this.altFormats){if(!this.altFormatsArray){this.altFormatsArray=this.altFormats.split("|")}var d,f;if(!l){for(d=0,f=this.altFormatsArray.length;d<f&&!l;d++){l=Date.parseDate(k[0],this.altFormatsArray[d])}}if(!g){for(d=0,f=this.altFormatsArray.length;d<f&&!g;d++){g=Date.parseDate(k[1],this.altFormatsArray[d])}}}if(!l||!g){return null}else{return{startDate:l,endDate:g}}}else{return null}}},formatDate:function(a){if(Ext.isDate(a)){return Genapp.form.DateRangeField.superclass.formatDate.call(this,a)}if(this.isRangeDate(a)){if(a.startDate===null&&a.endDate!==null){if(this.usePrefix){return this.endDatePrefix+a.endDate.format(this.format)}else{return this.minValue.format(this.format)+this.dateSeparator+a.endDate.format(this.format)}}else{if(a.startDate!==null&&a.endDate===null){if(this.usePrefix){return this.startDatePrefix+a.startDate.format(this.format)}else{return a.startDate.format(this.format)+this.dateSeparator+this.maxValue.format(this.format)}}else{if(a.startDate!==null&&a.endDate!==null){if(this.mergeEqualValues&&a.endDate.getElapsed(a.startDate)===0){return a.startDate.format(this.format)}else{if(this.autoReverse&&a.endDate.getTime()-a.startDate.getTime()<0){return a.endDate.format(this.format)+this.dateSeparator+a.startDate.format(this.format)}else{return a.startDate.format(this.format)+this.dateSeparator+a.endDate.format(this.format)}}}else{return""}}}}else{return a}},onTriggerClick:function(){if(this.disabled){return}if(!this.menu){this.menu=new Genapp.form.menu.DateRangeMenu({hideOnClick:false,hideValidationButton:this.hideValidationButton,showToday:this.showToday})}this.onFocus();if(typeof this.minDefaultValue==="string"){this.minDefaultValue=new Date(this.minDefaultValue)}if(typeof this.maxDefaultValue==="string"){this.maxDefaultValue=new Date(this.maxDefaultValue)}Ext.apply(this.menu.rangePicker.startDatePicker,{minDate:this.minValue,maxDate:this.maxValue,defaultValue:this.minDefaultValue,disabledDatesRE:this.disabledDatesRE,disabledDatesText:this.disabledDatesText,disabledDays:this.disabledDays,disabledDaysText:this.disabledDaysText,format:this.format,showToday:this.showToday,minText:String.format(this.minText,this.formatDate(this.minValue)),maxText:String.format(this.maxText,this.formatDate(this.maxValue))});Ext.apply(this.menu.rangePicker.endDatePicker,{minDate:this.minValue,maxDate:this.maxValue,defaultValue:this.maxDefaultValue,disabledDatesRE:this.disabledDatesRE,disabledDatesText:this.disabledDatesText,disabledDays:this.disabledDays,disabledDaysText:this.disabledDaysText,format:this.format,showToday:this.showToday,minText:String.format(this.minText,this.formatDate(this.minValue)),maxText:String.format(this.maxText,this.formatDate(this.maxValue))});var b=this.getValue();var c=this.minDefaultValue;var a=this.maxDefaultValue;if(Ext.isDate(b)){c=b;a=b}else{if(this.isRangeDate(b)){if(b.startDate!==null){c=b.startDate}if(b.endDate!==null){a=b.endDate}}}this.menu.rangePicker.startDatePicker.setValue(c);this.menu.rangePicker.endDatePicker.setValue(a);this.menu.show(this.el,"tl-bl?");this.menuEvents("on")},isRangeDate:function(a){return(Ext.isObject(a)&&(Ext.isDate(a.startDate)||a.startDate===null)&&(Ext.isDate(a.endDate)||a.endDate===null))},getValue:function(){return this.parseRangeDate(Ext.form.DateField.superclass.getValue.call(this))||""},setValue:function(a){return Ext.form.DateField.superclass.setValue.call(this,this.formatDate(this.parseRangeDate(a)))},beforeBlur:function(){var a=this.parseRangeDate(this.getRawValue());if(a){this.setValue(a)}}});Ext.reg("daterangefield",Genapp.form.DateRangeField);Ext.namespace("Genapp.form");Genapp.form.GeometryField=Ext.extend(Ext.form.TriggerField,{fieldLabel:"Location",mapWindowTitle:"Draw the search zone on the map :",mapWindowValidateButtonText:"Validate",mapWindowValidateAndSearchButtonText:"Validate and search",mapWindowCancelButtonText:"Cancel",triggerClass:"x-form-map-trigger",editable:false,hideMapDetails:true,mapWindowMaximizable:true,mapWindowMaximized:false,mapWindowHeight:500,mapWindowWidth:850,mapWindowMinZoomLevel:0,initComponent:function(){Genapp.form.GeometryField.superclass.initComponent.call(this);if(!this.hideTrigger){this.onTriggerClick=function(){if(this.disabled){return}if(!(this.mapWindow instanceof Ext.Window)){this.openMap(this)}else{this.mapWindow.show()}}}},openMap:function(){if(!this.mapWindow){this.mapWindow=new Ext.Window({layout:"fit",maximizable:this.mapWindowMaximizable,maximized:this.mapWindowMaximized,title:this.mapWindowTitle,width:this.mapWindowWidth,height:this.mapWindowHeight,closeAction:"destroy",draggable:false,resizable:false,modal:true,scope:true,items:this.mapPanel=new Genapp.MapPanel({title:"",isDrawingMap:true,featureWKT:this.getRawValue(),hideMapDetails:this.hideMapDetails,minZoomLevel:this.mapWindowMinZoomLevel,resultsBBox:Ext.getCmp("consultation_panel").mapPanel.resultsBBox}),buttons:[{text:this.mapWindowCancelButtonText,handler:function(){this.mapWindow.destroy()},scope:this},{text:this.mapWindowValidateButtonText,handler:this.onWindowValidate,scope:this},{text:this.mapWindowValidateAndSearchButtonText,handler:this.onWindowValidate.createDelegate(this,[true])}]});this.mapWindow.on("destroy",function(){delete this.mapWindow;if(this.submitRequest===true){Ext.getCmp("consultation_panel").submitRequest();this.submitRequest=false}},this);this.mapPanel.on("afterinit",function(b){var a=Ext.getCmp("consultation_panel");b.map.setCenter(a.mapPanel.map.getCenter());b.map.zoomTo(a.mapPanel.map.getZoom()-this.mapWindowMinZoomLevel);b.enableLayersAndLegends(this.mapPanel.layersActivation.request,true,true)},this)}this.mapWindow.show()},onWindowValidate:function(a){var b=this.mapPanel.vectorLayer.features.length?this.mapPanel.wktFormat.write(this.mapPanel.vectorLayer.features[0]):"";this.setValue(b);if(a===true){this.submitRequest=true}this.mapWindow.destroy();this.el.highlight()}});Ext.reg("geometryfield",Genapp.form.GeometryField);Ext.namespace("Genapp.form");Genapp.form.NumberRangeField=Ext.extend(Ext.form.TriggerField,{numberSeparator:" - ",minText:"The minimum value for this field is {0}",maxText:"The maximum value for this field is {0}",reverseText:"The max number must be superior to the min number",formatText:"The correct format is '{0}'",allowDecimals:true,decimalSeparator:".",decimalPrecision:2,allowNegative:true,minValue:-Number.MAX_VALUE,maxValue:Number.MAX_VALUE,nanText:"'{0}' is not a valid number",baseChars:"0123456789 ",hideValidationButton:false,setEmptyText:false,initEvents:function(){var a=this.baseChars+"";if(this.allowDecimals){a+=this.decimalSeparator}if(this.allowNegative){a+="-"}this.maskRe=new RegExp("["+Ext.escapeRe(a)+"]");Genapp.form.NumberRangeField.superclass.initEvents.call(this)},initComponent:function(){Genapp.form.NumberRangeField.superclass.initComponent.call(this);this.addEvents("select");if(this.setEmptyText){this.emptyText=this.minValue+this.numberSeparator+this.maxValue}var a=0;if(this.decimalPrecision>0){a=a+this.decimalSeparator;for(i=0;i<this.decimalPrecision;i++){a=a+"0"}}a=a+this.numberSeparator+a;this.formatText=String.format(this.formatText,a)},validateValue:function(e){if(!Genapp.form.NumberRangeField.superclass.validateValue.call(this,e)){return false}if(e.length<1){return true}var c=e.split(this.numberSeparator);if(c.length===1){var b=this.parseValue(c[0]);if(isNaN(b)){this.markInvalid(String.format(this.nanText,b));return false}else{return true}}else{if(c.length===2){var d=this.parseValue(c[0]);var a=this.parseValue(c[1]);if(a===""||d===""){this.markInvalid(this.formatText);return false}if(isNaN(d)){this.markInvalid(String.format(this.nanText,d));return false}if(isNaN(a)){this.markInvalid(String.format(this.nanText,a));return false}if(d<this.minValue){this.markInvalid(String.format(this.minText,this.minValue));return false}if(a>this.maxValue){this.markInvalid(String.format(this.maxText,this.maxValue));return false}if((a-d)<0){this.markInvalid(this.reverseText);return false}return true}else{this.markInvalid(this.formatText);return false}}},getValue:function(){var b=Genapp.form.NumberRangeField.superclass.getValue.call(this);var a=b.split(this.numberSeparator);if(a.length===1){return String(this.fixPrecision(this.parseValue(a[0]))).replace(".",this.decimalSeparator)}else{if(a.length===2){return String(this.fixPrecision(this.parseValue(a[0]))).replace(".",this.decimalSeparator)+this.numberSeparator+String(this.fixPrecision(this.parseValue(a[1]))).replace(".",this.decimalSeparator)}else{return""}}},setValue:function(c){var d=null;var a=null;if(Ext.isObject(c)){if(typeof c.minValue!=="undefined"&&typeof c.maxValue!=="undefined"){d=c.minValue;a=c.maxValue}else{return""}}else{if(typeof c==="string"){var b=c.split(this.numberSeparator);if(b.length===1){d=a=this.parseValue(b[0])}else{if(b.length===2){d=this.parseValue(b[0]);a=this.parseValue(b[1])}else{return""}}}else{return""}}min=typeof d==="number"?d:parseFloat(String(d).replace(this.decimalSeparator,"."));max=typeof a==="number"?a:parseFloat(String(a).replace(this.decimalSeparator,"."));mins=isNaN(min)?"":String(this.fixPrecision(min)).replace(".",this.decimalSeparator);maxs=isNaN(max)?"":String(this.fixPrecision(max)).replace(".",this.decimalSeparator);if(min===max){c=mins}else{if(min<max){c=mins+this.numberSeparator+maxs}else{c=maxs+this.numberSeparator+mins}}return Genapp.form.NumberRangeField.superclass.setValue.call(this,c)},parseValue:function(a){a=parseFloat(String(a).replace(this.decimalSeparator,"."));return isNaN(a)?"":a},fixPrecision:function(b){var a=isNaN(b);if(!this.allowDecimals||this.decimalPrecision===-1||a||!b){return a?"":b}return parseFloat(parseFloat(b).toFixed(this.decimalPrecision))},onTriggerClick:function(){if(this.disabled){return}if(!this.menu){this.menu=new Genapp.form.menu.NumberRangeMenu({hideOnClick:false,hideValidationButton:this.hideValidationButton})}this.onFocus();Ext.apply(this.menu.rangePicker.minField,{emptyText:this.setEmptyText?this.minValue:null,allowDecimals:this.allowDecimals,decimalSeparator:this.decimalSeparator,decimalPrecision:this.decimalPrecision,allowNegative:this.allowNegative,minValue:this.minValue,maxValue:this.maxValue,baseChars:this.baseChars});Ext.apply(this.menu.rangePicker.maxField,{emptyText:this.setEmptyText?this.maxValue:null,allowDecimals:this.allowDecimals,decimalSeparator:this.decimalSeparator,decimalPrecision:this.decimalPrecision,allowNegative:this.allowNegative,minValue:this.minValue,maxValue:this.maxValue,baseChars:this.baseChars});var b=this.getValue().split(this.numberSeparator);if(b.length===1){var c=this.parseValue(b[0]);var a=c}else{if(b.length===2){var c=this.parseValue(b[0]);var a=this.parseValue(b[1])}else{return}}this.menu.rangePicker.minField.setValue(c);this.menu.rangePicker.maxField.setValue(a);this.menu.show(this.el,"tl-bl?");this.menuEvents("on")},menuEvents:function(a){this.menu[a]("select",this.onSelect,this);this.menu[a]("hide",this.onMenuHide,this);this.menu[a]("show",this.onFocus,this)},onSelect:function(a,b){this.fireEvent("select",this,b);this.menu.hide()},onMenuHide:function(){this.focus(false,60);this.menuEvents("un");this.setValue({minValue:this.menu.rangePicker.minField.getValue(),maxValue:this.menu.rangePicker.maxField.getValue()})},validateBlur:function(){return !this.menu||!this.menu.isVisible()},onDestroy:function(){Ext.destroy(this.menu,this.wrap);Genapp.form.NumberRangeField.superclass.onDestroy.call(this)},beforeBlur:function(){var a=this.getRawValue();if(a){this.setValue(a)}}});Ext.reg("numberrangefield",Genapp.form.NumberRangeField);Ext.namespace("Genapp.form");Genapp.form.TreeField=Ext.extend(Ext.form.ComboBox,{hideValidationButton:false,store:new Ext.data.ArrayStore({autoDestroy:true,idIndex:0,fields:["id","text"]}),valueField:"id",displayField:"text",initComponent:function(){Genapp.form.TreeField.superclass.initComponent.call(this)},onTriggerClick:function(){if(this.disabled){return}if(!this.menu){this.menu=new Genapp.form.menu.TreeMenu({hideOnClick:false,hideValidationButton:this.hideValidationButton,dataUrl:this.dataUrl})}this.onFocus();this.menu.show(this.el,"tl-bl?");this.menuEvents("on")},menuEvents:function(a){this.menu[a]("select",this.onSelect,this);this.menu[a]("hide",this.onMenuHide,this);this.menu[a]("show",this.onFocus,this)},onSelect:function(a){this.menu.hide();if(a!==null){this.getStore().add([new Ext.data.Record({id:a.id,text:a.text})]);this.setValue(a.id)}},onMenuHide:function(){this.focus(false,60);this.menuEvents("un")},validateBlur:function(){return !this.menu||!this.menu.isVisible()},onDestroy:function(){Ext.destroy(this.menu,this.wrap);Genapp.form.TreeField.superclass.onDestroy.call(this)}});Ext.reg("treefield",Genapp.form.TreeField);Ext.namespace("Genapp.form");Genapp.form.TwinNumberField=Ext.extend(Ext.form.TwinTriggerField,{fieldClass:"x-form-field x-form-num-field",allowDecimals:true,decimalSeparator:".",decimalPrecision:2,allowNegative:true,minValue:-Number.MAX_VALUE,maxValue:Number.MAX_VALUE,minText:"The minimum value for this field is {0}",maxText:"The maximum value for this field is {0}",nanText:"{0} is not a valid number",baseChars:"0123456789",trigger1Class:"x-form-clear-trigger",hideTrigger1:true,hideTrigger2:true,initComponent:function(){this.on("change",this.onChange,this);Genapp.form.TwinNumberField.superclass.initComponent.call(this)},onTrigger1Click:function(){this.reset();this.triggers[0].hide()},onChange:function(b){var a=this.getValue();if(a!==""&&a!==null){this.triggers[0].show()}else{this.triggers[0].hide()}},initEvents:function(){var a=this.baseChars+"";if(this.allowDecimals){a+=this.decimalSeparator}if(this.allowNegative){a+="-"}this.maskRe=new RegExp("["+Ext.escapeRe(a)+"]");Ext.form.NumberField.superclass.initEvents.call(this)},validateValue:function(b){if(!Ext.form.NumberField.superclass.validateValue.call(this,b)){return false}if(b.length<1){return true}b=String(b).replace(this.decimalSeparator,".");if(isNaN(b)){this.markInvalid(String.format(this.nanText,b));return false}var a=this.parseValue(b);if(a<this.minValue){this.markInvalid(String.format(this.minText,this.minValue));return false}if(a>this.maxValue){this.markInvalid(String.format(this.maxText,this.maxValue));return false}return true},getValue:function(){return this.fixPrecision(this.parseValue(Ext.form.NumberField.superclass.getValue.call(this)))},setValue:function(a){a=typeof a==="number"?a:parseFloat(String(a).replace(this.decimalSeparator,"."));a=isNaN(a)?"":String(a).replace(".",this.decimalSeparator);if(this.triggers){if(a!==""&&a!==null&&a!==this.minValue&&a!==this.maxValue){this.triggers[0].show()}else{this.triggers[0].hide()}}return Ext.form.NumberField.superclass.setValue.call(this,a)},parseValue:function(a){a=parseFloat(String(a).replace(this.decimalSeparator,"."));return isNaN(a)?"":a},fixPrecision:function(b){var a=isNaN(b);if(!this.allowDecimals||this.decimalPrecision===-1||a||!b){return a?"":b}return parseFloat(parseFloat(b).toFixed(this.decimalPrecision))},beforeBlur:function(){var a=this.parseValue(this.getRawValue());if(a!==""&&a!==null){this.setValue(this.fixPrecision(a))}}});Ext.reg("twinnumberfield",Genapp.form.TwinNumberField);Ext.namespace("Genapp.form.menu");Genapp.form.menu.DateRangeMenu=Ext.extend(Ext.menu.DateMenu,{layout:"table",cls:"x-date-range-menu",initComponent:function(){this.on("beforeshow",this.onBeforeShow,this);Ext.apply(this,{plain:true,showSeparator:false,items:[this.rangePicker=new Genapp.form.picker.DateRangePicker(this.initialConfig)]});this.rangePicker.purgeListeners();Ext.menu.DateMenu.superclass.initComponent.call(this);this.relayEvents(this.rangePicker,["select"])},onBeforeShow:function(){if(this.rangePicker){this.rangePicker.startDatePicker.hideMonthPicker(true);this.rangePicker.endDatePicker.hideMonthPicker(true)}}});Ext.reg("daterangemenu",Genapp.form.menu.DateRangeMenu);Ext.namespace("Genapp.form.menu");Genapp.form.menu.NumberRangeMenu=Ext.extend(Ext.menu.Menu,{layout:"auto",cls:"x-number-range-menu",initComponent:function(){Ext.apply(this,{plain:true,showSeparator:false,items:[this.rangePicker=new Genapp.form.picker.NumberRangePicker(this.initialConfig)]});this.rangePicker.purgeListeners();Genapp.form.menu.NumberRangeMenu.superclass.initComponent.call(this);this.relayEvents(this.rangePicker,["select"])}});Ext.reg("numberrangemenu",Genapp.form.menu.NumberRangeMenu);Ext.namespace("Genapp.form.menu");Genapp.form.menu.TreeMenu=Ext.extend(Ext.menu.Menu,{layout:"auto",cls:"x-tree-menu",initComponent:function(){Ext.apply(this,{plain:true,showSeparator:false,items:[this.treePicker=new Genapp.form.picker.TreePicker(this.initialConfig)]});Genapp.form.menu.TreeMenu.superclass.initComponent.call(this);this.relayEvents(this.treePicker,["select"])}});Ext.reg("treemenu",Genapp.form.menu.TreeMenu);Ext.namespace("Genapp.form.picker");Genapp.form.picker.DateRangePicker=Ext.extend(Ext.Panel,{layout:"column",cls:"x-menu-date-range-item",buttonAlign:"center",hideValidationButton:false,tbarStartDateButtonText:"Start Date ...",tbarRangeDateButtonText:"Range Date",tbarEndDateButtonText:"... End Date",fbarOkButtonText:"ok",selectedDate:{startDate:null,endDate:null},initComponent:function(){this.items=[this.startDatePicker=new Ext.DatePicker(Ext.apply({internalRender:this.strict||!Ext.isIE,ctCls:"x-menu-date-item",columnWidth:0.5},this.initialConfig)),{xtype:"spacer",width:5,html:"&nbsp;"},this.endDatePicker=new Ext.DatePicker(Ext.apply({internalRender:this.strict||!Ext.isIE,ctCls:"x-menu-date-item",columnWidth:0.5},this.initialConfig))];this.startDatePicker.on("select",this.startDateSelect,this);this.endDatePicker.on("select",this.endDateSelect,this);this.tbar=new Ext.Toolbar({items:[this.startDateButton=new Ext.Button({text:this.tbarStartDateButtonText,cls:"x-menu-date-range-item-start-date-button",enableToggle:true,allowDepress:false,toggleGroup:"DateButtonsGroup",toggleHandler:this.onStartDatePress.createDelegate(this)}),this.rangeDateButton=new Ext.Button({text:this.tbarRangeDateButtonText,cls:"x-menu-date-range-item-range-date-button",pressed:true,enableToggle:true,allowDepress:false,toggleGroup:"DateButtonsGroup",toggleHandler:this.onRangeDatePress.createDelegate(this)}),"->",this.endDateButton=new Ext.Button({text:this.tbarEndDateButtonText,cls:"x-menu-date-range-item-end-date-button",enableToggle:true,allowDepress:false,toggleGroup:"DateButtonsGroup",toggleHandler:this.onEndDatePress.createDelegate(this)})]});if(!this.hideValidationButton){this.fbar=new Ext.Toolbar({cls:"x-date-bottom",items:[{xtype:"button",text:this.fbarOkButtonText,width:"auto",handler:this.onOkButtonPress.createDelegate(this)}]})}Genapp.form.picker.DateRangePicker.superclass.initComponent.call(this)},onRangeDatePress:function(a,b){if(b){this.startDatePicker.enable();this.endDatePicker.enable();this.resetDates()}},onStartDatePress:function(a,b){if(b){this.startDatePicker.enable();this.endDatePicker.disable();this.resetDates()}},onEndDatePress:function(a,b){if(b){this.startDatePicker.disable();this.endDatePicker.enable();this.resetDates()}},startDateSelect:function(b,a){this.selectedDate.startDate=a;if(this.startDateButton.pressed){this.returnSelectedDate()}else{if(this.selectedDate.endDate!==null){this.returnSelectedDate()}}},endDateSelect:function(b,a){this.selectedDate.endDate=a;if(this.endDateButton.pressed){this.returnSelectedDate()}else{if(this.selectedDate.startDate!==null){this.returnSelectedDate()}}},resetselectedDate:function(){this.selectedDate={startDate:null,endDate:null}},resetDates:function(){this.resetselectedDate();this.startDatePicker.setValue(this.startDatePicker.defaultValue);this.endDatePicker.setValue(this.endDatePicker.defaultValue)},returnSelectedDate:function(){this.fireEvent("select",this,this.selectedDate);this.resetselectedDate()},isEnabledDate:function(a){if((a.activeDate.getTime()-a.minDate.getTime()>=0)&&(a.maxDate.getTime()-a.activeDate.getTime()>=0)){return true}else{return false}},onOkButtonPress:function(a,b){if(b){if(this.startDateButton.pressed){if(this.isEnabledDate(this.startDatePicker)){this.selectedDate={startDate:this.startDatePicker.activeDate,endDate:null};this.returnSelectedDate()}}else{if(this.endDateButton.pressed){if(this.isEnabledDate(this.endDatePicker)){this.selectedDate={startDate:null,endDate:this.endDatePicker.activeDate};this.returnSelectedDate()}}else{if(this.isEnabledDate(this.startDatePicker)&&this.isEnabledDate(this.endDatePicker)){this.selectedDate={startDate:this.startDatePicker.activeDate,endDate:this.endDatePicker.activeDate};this.returnSelectedDate()}}}}}});Ext.reg("daterangepicker",Genapp.form.picker.DateRangePicker);Ext.namespace("Genapp.form.picker");Genapp.form.picker.NumberRangePicker=Ext.extend(Ext.Panel,{layout:"form",height:59,width:176,labelWidth:30,buttonAlign:"center",cls:"x-menu-number-range-item",minFieldLabel:"Min",maxFieldLabel:"Max",okButtonText:"ok",hideValidationButton:true,initComponent:function(){Ext.apply(this,{items:[this.minField=new Genapp.form.TwinNumberField({fieldLabel:this.minFieldLabel}),this.maxField=new Genapp.form.TwinNumberField({fieldLabel:this.maxFieldLabel})]});if(!this.hideValidationButton){this.buttons=[{xtype:"button",text:this.okButtonText,width:"auto",handler:this.onOkButtonPress.createDelegate(this)}];this.height=this.height+28}Genapp.form.picker.NumberRangePicker.superclass.initComponent.call(this)},onOkButtonPress:function(a,b){if(b){this.fireEvent("select",this,{minValue:this.minField.getValue(),maxValue:this.maxField.getValue()})}}});Ext.reg("numberrangepicker",Genapp.form.picker.NumberRangePicker);Ext.namespace("Genapp.form.picker");Genapp.form.picker.TreePicker=Ext.extend(Ext.tree.TreePanel,{height:300,width:300,buttonAlign:"center",cls:"x-menu-tree-item",okButtonText:"ok",hideValidationButton:true,padding:5,enableDD:false,animate:true,border:false,rootVisible:false,useArrows:true,autoScroll:true,containerScroll:true,frame:false,baseAttr:{singleClickExpand:true},root:{nodeType:"async",text:"Tree Root",id:"*",draggable:false},listeners:{load:{fn:function(a){if(a.getDepth()===0){a.expandChildNodes()}},single:true},dblclick:{fn:function(b,a){this.fireEvent("select",b.attributes)}}},initComponent:function(){if(!this.hideValidationButton){this.buttons=[{xtype:"button",text:this.okButtonText,width:"auto",handler:this.onOkButtonPress.createDelegate(this)}];this.height=this.height+28}Genapp.form.picker.TreePicker.superclass.initComponent.call(this)},onOkButtonPress:function(a,c){if(c){var b=this.getSelectionModel().getSelectedNode();this.fireEvent("select",b===null?null:b.attributes)}}});Ext.reg("treepicker",Genapp.form.picker.TreePicker);Ext.namespace("Ext.ux.form");Ext.ux.form.BasicCheckbox=Ext.extend(Ext.form.Field,{focusClass:undefined,fieldClass:"x-form-field",checked:false,mode:"compat",themedCompat:false,defaultAutoCreate:{tag:"input",type:"checkbox",autocomplete:"off"},boxLabel:undefined,inputValue:undefined,markEl:"wrap",mustCheck:false,mustCheckText:"This field is required",compatConfig:{enabled:{no:"checkbox_off",on:"checkbox_on"},disabled:{no:"checkbox_off_dled",on:"checkbox_on_dled"},width:14,height:16},switchConfig:{enabled:{"0":"checkbox_off","1":"checkbox_on"},disabled:{"0":"checkbox_off_dled","1":"checkbox_on_dled"},width:14,height:16},cycledConfig:{enabled:{"0":"flag_blue","1":"flag_green","2":"flag_orange","3":"flag_pink","4":"flag_purple","5":"flag_red","6":"flag_yellow"},disabled:{"0":"flag_grey","1":"flag_grey","2":"flag_grey","3":"flag_grey","4":"flag_grey","5":"flag_grey","6":"flag_grey"},width:16,height:16},originalValue:undefined,protectedValue:undefined,initComponent:function(){Ext.ux.form.BasicCheckbox.superclass.initComponent.call(this);this.addEvents("check","click")},onResize:function(){Ext.ux.form.BasicCheckbox.superclass.onResize.apply(this,arguments);if(!this.boxLabel){this.el.alignTo(this.wrap,"c-c")}},initEvents:function(){Ext.ux.form.BasicCheckbox.superclass.initEvents.call(this);if(this.mode!=="compat"||this.themedCompat){this.mon(this.el,{click:this.onClick,change:this.onChange,mouseenter:this.onMouseEnter,mouseleave:this.onMouseLeave,mousedown:this.onMouseDown,mouseup:this.onMouseUp,scope:this})}else{this.mon(this.el,{click:this.onClick,change:this.onChange,scope:this})}},getResizeEl:function(){return this.wrap},getPositionEl:function(){return this.wrap},alignErrorIcon:function(){this.errorIcon.alignTo(this.wrap,"tl-tr",[2,0])},markInvalid:function(a){Ext.ux.form.BasicCheckbox.superclass.markInvalid.call(this,a)},clearInvalid:function(){Ext.ux.form.BasicCheckbox.superclass.clearInvalid.call(this)},validateValue:function(b){var a=(this.rendered?this.el.dom.value:this.inputValue);var f=((this.rendered?this.el.dom.disabled:this.disabled)?"disabled":"enabled");if(this.mode==="compat"&&this.mustCheck&&!b){this.markInvalid(this.mustCheckText);return false}if(this.mode!=="compat"){if(a!==undefined&&a!==null&&this[this.mode+"Config"][f][a]===undefined){this.markInvalid();return false}}if(this.vtype){var e=Ext.form.VTypes;if(!e[this.vtype](b,this)){this.markInvalid(this.vtypeText||e[this.vtype+"Text"]);return false}}if(typeof this.validator==="function"){var c=this.validator(b);if(c!==true){this.markInvalid(c);return false}}if(this.regex&&!this.regex.test(b)){this.markInvalid(this.regexText);return false}return true},onRender:function(b,a){Ext.ux.form.BasicCheckbox.superclass.onRender.call(this,b,a);var c=this[this.mode+"Config"].width;var d=this[this.mode+"Config"].height;this.protectedValue=this.inputValue;if(this.protectedValue!==undefined){this.el.dom.value=this.protectedValue}else{this.setNextValue()}if(this.mode!=="compat"||this.themedCompat){this.el.setOpacity(0)}this.innerWrap=this.el.wrap({cls:"x-sm-form-check-innerwrap"});this.innerWrap.setStyle({position:"relative",display:"inline"});this.wrap=this.innerWrap.wrap({cls:"x-form-check-wrap"});this.vel=this.innerWrap.createChild({tag:"div",cls:"x-sm-form-check"},this.el.dom);if(this.mode!=="compat"||this.themedCompat){this.vel.setSize(c,d);this.el.setStyle({position:"absolute"});this.el.setTop(Math.round((d-16)/2));this.el.setLeft(Math.round((c-14)/2))}if(this.boxLabel){this.wrap.createChild({tag:"label",htmlFor:this.el.id,cls:"x-form-cb-label",html:this.boxLabel})}if(this.mode==="compat"){this.checked=(this.checked?true:(this.el.dom.checked?true:false));this.setValue(this.checked)}else{this.el.dom.checked=true;this.el.dom.defaultChecked=true;this.setValue(this.protectedValue)}},manageActiveClass:function(){if(this.rendered&&(this.mode!=="compat"||this.themedCompat)){var b=(this.mode==="compat"?this.protectedValue:(this.rendered?this.el.dom.value:this.protectedValue));var f=((this.rendered?this.el.dom.disabled:this.disabled)?"disabled":"enabled");var g=this[this.mode+"Config"][f][b];var a;var e;for(e in this[this.mode+"Config"][f]){a=e;break}if(g===undefined){g=this[this.mode+"Config"][f][a]}if(this.previousClass!==undefined){this.vel.removeClass(this.previousClass)}this.previousClass=g;this.vel.addClass(g)}},setNextValue:function(){var b=(this.mode==="compat"?this.protectedValue:(this.rendered?this.el.dom.value:this.protectedValue));var e=((this.rendered?this.el.dom.disabled:this.disabled)?"disabled":"enabled");var f=false;var a=null;var c;this.protectedValue=null;for(c in this[this.mode+"Config"][e]){if(a===null){a=c}if(b===undefined){break}if(f&&this.protectedValue===null){this.protectedValue=c}if(c===b){f=true}}if(this.protectedValue===null){this.protectedValue=a}if(this.mode!=="compat"){this.inputValue=this.protectedValue}if(this.rendered&&this.inputValue!==undefined){this.el.dom.value=this.inputValue}},onDestroy:function(){if(this.wrap){this.wrap.remove()}Ext.ux.form.BasicCheckbox.superclass.onDestroy.call(this)},initValue:function(){this.originalValue=this.inputValue;if(this.mode==="compat"){this.originalValue=this.checked}},getRawValue:function(){if(this.mode==="compat"){if(this.rendered){return this.el.dom.checked}else{return this.checked}}var a=this.rendered?this.el.getValue():Ext.value(this.value,"");return a},getValue:function(){var a=false;if(this.mode==="compat"){if(this.rendered){a=this.el.dom.checked}}else{a=this.protectedValue}return a},onClick:function(){if(this.mode==="compat"){if(this.el.dom.checked!==this.checked){this.setNextValue();this.checked=this.el.dom.checked}}else{this.setNextValue();this.el.dom.checked=true;this.el.dom.defaultChecked=true}this.manageActiveClass();this.validate();this.fireEvent("check",this,this.checked,this.inputValue);this.fireEvent("click",this,this.checked,this.inputValue)},onChange:function(){if(this.mode==="compat"){if(this.el.dom.checked!==this.checked){this.setNextValue();this.checked=this.el.dom.checked}}else{this.inputValue=this.el.dom.value;this.protectedValue=this.inputValue;this.el.dom.checked=true;this.el.dom.defaultChecked=true}this.manageActiveClass();this.validate();this.fireEvent("check",this,this.checked,this.inputValue);this.fireEvent("change",this,this.checked,this.inputValue)},setValue:function(b){var a;if(this.mode==="compat"){this.checked=(b===true||b==="true"||b==="1"||String(b).toLowerCase()==="on");if(this.rendered){this.el.dom.checked=this.checked;this.el.dom.defaultChecked=this.checked}this.protectedValue=(this.checked?"on":"no")}else{var c=((this.rendered?this.el.dom.disabled:this.disabled)?"disabled":"enabled");this.checked=true;if(this[this.mode+"Config"][c][b]!==undefined){this.protectedValue=b}else{for(a in this[this.mode+"Config"][c]){this.protectedValue=a;break}}this.inputValue=this.protectedValue;if(this.rendered&&this.inputValue!==undefined){this.el.dom.value=this.inputValue}}this.manageActiveClass();this.validate();this.fireEvent("check",this,this.checked);return this},disable:function(){Ext.ux.form.BasicCheckbox.superclass.disable.call(this);this.manageActiveClass()},enable:function(){Ext.ux.form.BasicCheckbox.superclass.enable.call(this);this.manageActiveClass()},onMouseEnter:function(){this.wrap.addClass("x-sm-form-check-over")},onMouseLeave:function(){this.wrap.removeClass("x-sm-form-check-over")},onMouseDown:function(){this.wrap.addClass("x-sm-form-check-down")},onMouseUp:function(){this.wrap.removeClass("x-sm-form-check-down")},onFocus:function(){Ext.ux.form.BasicCheckbox.superclass.onFocus.call(this);this.wrap.addClass("x-sm-form-check-focus")},onBlur:function(){Ext.ux.form.BasicCheckbox.superclass.onBlur.call(this);this.wrap.removeClass("x-sm-form-check-focus")}});Ext.form.Checkbox=Ext.ux.form.BasicCheckbox;Ext.reg("checkbox",Ext.form.Checkbox);Ext.ux.form.Checkbox=Ext.extend(Ext.ux.form.BasicCheckbox,{mode:"switch"});Ext.reg("switch_checkbox",Ext.ux.form.Checkbox);Ext.ux.form.CycleCheckbox=Ext.extend(Ext.ux.form.BasicCheckbox,{mode:"cycled"});Ext.reg("cycle_checkbox",Ext.ux.form.CycleCheckbox);Ext.override(Ext.form.Field,{markEl:"el",markInvalid:function(c){if(!this.rendered||this.preventMark){return}c=c||this.invalidText;var a=this.getMessageHandler();if(a){a.mark(this,c)}else{if(this.msgTarget){this[this.markEl].addClass(this.invalidClass);var b=Ext.getDom(this.msgTarget);if(b){b.innerHTML=c;b.style.display=this.msgDisplay}}}this.fireEvent("invalid",this,c)},clearInvalid:function(){if(!this.rendered||this.preventMark){return}var a=this.getMessageHandler();if(a){a.clear(this)}else{if(this.msgTarget){this[this.markEl].removeClass(this.invalidClass);var b=Ext.getDom(this.msgTarget);if(b){b.innerHTML="";b.style.display="none"}}}this.fireEvent("valid",this)}});Ext.apply(Ext.form.MessageTargets,{qtip:{mark:function(a,c){var b=a[(a.markEl?a.markEl:"el")];b.addClass(a.invalidClass);b.dom.qtip=c;b.dom.qclass="x-form-invalid-tip";if(Ext.QuickTips){Ext.QuickTips.enable()}},clear:function(a){var b=a[(a.markEl?a.markEl:"el")];b.removeClass(a.invalidClass);b.dom.qtip=""}},title:{mark:function(a,c){var b=a[(a.markEl?a.markEl:"el")];b.addClass(a.invalidClass);b.dom.title=c},clear:function(a){a[a.markEl].dom.title=""}},under:{mark:function(b,d){var c=b[(b.markEl?b.markEl:"el")],e=b.errorEl;c.addClass(b.invalidClass);if(!e){var a=b.getErrorCt();if(!a){c.dom.title=d;return}e=b.errorEl=a.createChild({cls:"x-form-invalid-msg"});e.setWidth(a.getWidth(true)-20)}e.update(d);Ext.form.Field.msgFx[b.msgFx].show(e,b)},clear:function(a){var b=a[(a.markEl?a.markEl:"el")],c=a.errorEl;b.removeClass(a.invalidClass);if(c){Ext.form.Field.msgFx[a.msgFx].hide(c,a)}else{b.dom.title=""}}},side:{mark:function(c,e){var d=c[(c.markEl?c.markEl:"el")],b=c.errorIcon;d.addClass(c.invalidClass);if(!b){var a=c.getErrorCt();if(!a){d.dom.title=e;return}b=c.errorIcon=a.createChild({cls:"x-form-invalid-icon"})}c.alignErrorIcon();b.dom.qtip=e;b.dom.qclass="x-form-invalid-tip";b.show();c.on("resize",c.alignErrorIcon,c)},clear:function(b){var c=b[(b.markEl?b.markEl:"el")],a=b.errorIcon;c.removeClass(b.invalidClass);if(a){a.dom.qtip="";a.hide();b.un("resize",b.alignErrorIcon,b)}else{c.dom.title=""}}}});(function(){function b(d){var c=Array.prototype.slice.call(arguments,1);return d.replace(/\{(\d+)\}/g,function(e,f){return c[f]})}var a=Date.formatCodeToRegex;Date.createParser=function(){var c=["var dt, y, m, d, h, i, s, ms, o, z, zz, u, v,","def = Date.defaults,","results = String(input).match(Date.parseRegexes[{0}]);","if(results){","{1}","if(u != null){","v = new Date(u * 1000);","}else{","dt = (new Date()).clearTime();","y = y >= 0? y : Ext.num(def.y, dt.getFullYear());","m = m >= 0? m : Ext.num(def.m - 1, dt.getMonth());","d = d || Ext.num(def.d, dt.getDate());","h  = h || Ext.num(def.h, dt.getHours());","i  = i || Ext.num(def.i, dt.getMinutes());","s  = s || Ext.num(def.s, dt.getSeconds());","ms = ms || Ext.num(def.ms, dt.getMilliseconds());","if(z >= 0 && y >= 0){","v = new Date(y, 0, 1, h, i, s, ms);","v = !strict? v : (strict === true && (z <= 364 || (v.isLeapYear() && z <= 365))? v.add(Date.DAY, z) : null);","}else if(strict === true && !Date.isValid(y, m + 1, d, h, i, s, ms)){","v = null;","}else{","v = new Date(y, m, d, h, i, s, ms);","}","}","}","if(v){","v.setFullYear(y);","if(zz != null){","v = v.add(Date.SECOND, -v.getTimezoneOffset() * 60 - zz);","}else if(o){","v = v.add(Date.MINUTE, -v.getTimezoneOffset() + (sn == '+'? -1 : 1) * (hr * 60 + mn));","}","}","return v;"].join("\n");return function(l){var e=Date.parseRegexes.length,m=1,f=[],k=[],j=false,d="",h;for(h=0;h<l.length;++h){d=l.charAt(h);if(!j&&d==="\\"){j=true}else{if(j){j=false;k.push(String.escape(d))}else{var g=a(d,m);m+=g.g;k.push(g.s);if(g.g&&g.c){f.push(g.c)}}}}Date.parseRegexes[e]=new RegExp("^"+k.join("")+"$","i");Date.parseFunctions[l]=new Function("input","strict",b(c,e,f.join("")))}}();Date.formatCodes.f="String.leftPad(this.getFullYear(), 4, '0')";Date.parseCodes.f=Date.parseCodes.Y}());Ext.DatePicker.prototype.onMonthClick=function(f,b){f.stopEvent();var c=new Ext.Element(b),a;if(c.is("button.x-date-mp-cancel")){this.hideMonthPicker()}else{if(c.is("button.x-date-mp-ok")){var g=new Date(this.mpSelYear,this.mpSelMonth,(this.activeDate||this.value).getDate());if(g.getMonth()!==this.mpSelMonth){g=new Date(this.mpSelYear,this.mpSelMonth,1).getLastDateOfMonth()}g.setFullYear(this.mpSelYear);this.update(g);this.hideMonthPicker()}else{if(a=c.up("td.x-date-mp-month",2)){this.mpMonths.removeClass("x-date-mp-sel");a.addClass("x-date-mp-sel");this.mpSelMonth=a.dom.xmonth}else{if(a=c.up("td.x-date-mp-year",2)){this.mpYears.removeClass("x-date-mp-sel");a.addClass("x-date-mp-sel");this.mpSelYear=a.dom.xyear}else{if(c.is("a.x-date-mp-prev")){this.updateMPYear(this.mpyear-10)}else{if(c.is("a.x-date-mp-next")){this.updateMPYear(this.mpyear+10)}}}}}}};Ext.DatePicker.prototype.onMonthDblClick=function(f,c){f.stopEvent();var d=new Ext.Element(c),b;var a=null;if(b=d.up("td.x-date-mp-month",2)){a=new Date(this.mpSelYear,b.dom.xmonth,(this.activeDate||this.value).getDate());a.setFullYear(this.mpSelYear);this.update(a);this.hideMonthPicker()}else{if(b=d.up("td.x-date-mp-year",2)){a=new Date(b.dom.xyear,this.mpSelMonth,(this.activeDate||this.value).getDate());a.setFullYear(b.dom.xyear);this.update(a);this.hideMonthPicker()}}};Ext.DatePicker.prototype.update=function(G,A){if(this.rendered){var a=this.activeDate,o=this.isVisible();this.activeDate=G;if(!A&&a&&this.el){var n=G.getTime();if(a.getMonth()===G.getMonth()&&a.getFullYear()===G.getFullYear()){this.cells.removeClass("x-date-selected");this.cells.each(function(d){if(d.dom.firstChild.dateValue===n){d.addClass("x-date-selected");if(o&&!this.cancelFocus){Ext.fly(d.dom.firstChild).focus(50)}return false}},this);return}}var j=G.getDaysInMonth(),p=G.getFirstDateOfMonth(),f=p.getDay()-this.startDay;if(f<0){f+=7}j+=f;var B=G.add("mo",-1),g=B.getDaysInMonth()-f,e=this.cells.elements,q=this.textNodes,y=86400000,D=(new Date(B.getFullYear(),B.getMonth(),g)).clearTime(),C=new Date().clearTime().getTime(),u=G.clearTime(true).getTime(),s=this.minDate?this.minDate.clearTime(true):Number.NEGATIVE_INFINITY,x=this.maxDate?this.maxDate.clearTime(true):Number.POSITIVE_INFINITY,F=this.disabledDatesRE,r=this.disabledDatesText,I=this.disabledDays?this.disabledDays.join(""):false,E=this.disabledDaysText,z=this.format;D.setFullYear(B.getFullYear());if(this.showToday){var l=new Date().clearTime(),c=(l<s||l>x||(F&&z&&F.test(l.dateFormat(z)))||(I&&I.indexOf(l.getDay())!==-1));if(!this.disabled){this.todayBtn.setDisabled(c);this.todayKeyListener[c?"disable":"enable"]()}}var k=function(K,d){d.title="";var w=D.getTime();d.firstChild.dateValue=w;if(w===C){d.className+=" x-date-today";d.title=K.todayText}if(w===u){d.className+=" x-date-selected";if(o){Ext.fly(d.firstChild).focus(50)}}if(w<s){d.className=" x-date-disabled";d.title=K.minText;return}if(w>x){d.className=" x-date-disabled";d.title=K.maxText;return}if(I){if(I.indexOf(D.getDay())!==-1){d.title=E;d.className=" x-date-disabled"}}if(F&&z){var J=D.dateFormat(z);if(F.test(J)){d.title=r.replace("%0",J);d.className=" x-date-disabled"}}};var v=0;for(;v<f;v++){q[v].innerHTML=(++g);D.setDate(D.getDate()+1);e[v].className="x-date-prevday";k(this,e[v])}for(;v<j;v++){var b=v-f+1;q[v].innerHTML=(b);D.setDate(D.getDate()+1);e[v].className="x-date-active";k(this,e[v])}var H=0;for(;v<42;v++){q[v].innerHTML=(++H);D.setDate(D.getDate()+1);e[v].className="x-date-nextday";k(this,e[v])}this.mbtn.setText(this.monthNames[G.getMonth()]+" "+G.getFullYear());if(!this.internalRender){var h=this.el.dom.firstChild,m=h.offsetWidth;this.el.setWidth(m+this.el.getBorderWidth("lr"));Ext.fly(h).setWidth(m);this.internalRender=true;if(Ext.isOpera&&!this.secondPass){h.rows[0].cells[1].style.width=(m-(h.rows[0].cells[0].offsetWidth+h.rows[0].cells[2].offsetWidth))+"px";this.secondPass=true;this.update.defer(10,this,[G])}}}};
/*
 * Ext JS Library 3.2.1
 * Copyright(c) 2006-2010 Ext JS, Inc.
 * licensing@extjs.com
 * http://www.extjs.com/license
 */
Ext.ns("Ext.ux.grid");Ext.ux.grid.RowExpander=Ext.extend(Ext.util.Observable,{expandOnEnter:true,expandOnDblClick:true,expandOnClick:true,lastExpandedRow:null,accordionMode:true,header:"",width:20,sortable:false,fixed:true,hideable:false,menuDisabled:true,dataIndex:"",id:"expander",lazyRender:true,enableCaching:true,constructor:function(a){Ext.apply(this,a);this.addEvents({beforeexpand:true,expand:true,beforecollapse:true,collapse:true});Ext.ux.grid.RowExpander.superclass.constructor.call(this);if(this.tpl){if(typeof this.tpl==="string"){this.tpl=new Ext.Template(this.tpl)}this.tpl.compile()}this.state={};this.bodyContent={}},getRowClass:function(a,e,d,c){d.cols=d.cols-1;var b=this.bodyContent[a.id];if(!b&&!this.lazyRender){b=this.getBodyContent(a,e)}if(b){d.body=b}return this.state[a.id]?"x-grid3-row-expanded":"x-grid3-row-collapsed"},init:function(b){this.grid=b;var a=b.getView();a.getRowClass=this.getRowClass.createDelegate(this);a.enableRowBody=true;b.on("render",this.onRender,this);b.on("destroy",this.onDestroy,this)},onRender:function(){var a=this.grid;var b=a.getView().mainBody;b.on("mousedown",this.onMouseDown,this,{delegate:".x-grid3-row-expander"});if(this.expandOnEnter){this.keyNav=new Ext.KeyNav(this.grid.getGridEl(),{enter:this.onEnter,scope:this})}if(this.expandOnClick){a.on("rowclick",this.onRowClick,this)}if(this.expandOnDblClick){a.on("rowdblclick",this.onRowDblClick,this)}},onDestroy:function(){if(this.keyNav){this.keyNav.disable();delete this.keyNav}var a=this.grid.getView().mainBody;if(a){a.un("mousedown",this.onMouseDown,this)}},onRowDblClick:function(a,b,c){this.toggleRow(b)},onRowClick:function(a,b,c){this.expandRow(b)},onEnter:function(h){var f=this.grid,j=f.getSelectionModel(),b=j.getSelections(),c,a;for(c=0,a=b.length;c<a;c++){var d=f.getStore().indexOf(b[c]);this.toggleRow(d)}},getBodyContent:function(a,b){if(!this.enableCaching){return this.tpl.apply(a.data)}var c=this.bodyContent[a.id];if(!c){c=this.tpl.apply(a.data);this.bodyContent[a.id]=c}return c},onMouseDown:function(b,a){b.stopEvent();var c=b.getTarget(".x-grid3-row");this.toggleRow(c)},renderer:function(b,c,a){c.cellAttr='rowspan="2"';return'<div class="x-grid3-row-expander">&#160;</div>'},beforeExpand:function(b,a,c){if(this.fireEvent("beforeexpand",this,b,a,c)!==false){if(this.tpl&&this.lazyRender){a.innerHTML=this.getBodyContent(b,c)}return true}else{return false}},toggleRow:function(a){if(typeof a==="number"){a=this.grid.view.getRow(a)}this[Ext.fly(a).hasClass("x-grid3-row-collapsed")?"expandRow":"collapseRow"](a)},expandRow:function(c){if(typeof c==="number"){c=this.grid.view.getRow(c)}var b=this.grid.store.getAt(c.rowIndex);var a=Ext.DomQuery.selectNode("tr:nth(2) div.x-grid3-row-body",c);if(this.beforeExpand(b,a,c.rowIndex)){if(this.accordionMode===true){if(this.lastExpandedRow!==null){this.collapseRow(this.lastExpandedRow)}this.lastExpandedRow=c}this.state[b.id]=true;Ext.fly(c).replaceClass("x-grid3-row-collapsed","x-grid3-row-expanded");this.fireEvent("expand",this,b,a,c.rowIndex)}},collapseRow:function(c){if(typeof c==="number"){c=this.grid.view.getRow(c)}var b=this.grid.store.getAt(c.rowIndex);var a=Ext.fly(c).child("tr:nth(1) div.x-grid3-row-body",true);if(this.fireEvent("beforecollapse",this,b,a,c.rowIndex)!==false){this.state[b.id]=false;Ext.fly(c).replaceClass("x-grid3-row-expanded","x-grid3-row-collapsed");this.fireEvent("collapse",this,b,a,c.rowIndex)}}});Ext.preg("rowexpander",Ext.ux.grid.RowExpander);Ext.grid.RowExpander=Ext.ux.grid.RowExpander;Genapp.configure=function(){if(Genapp.ConsultationPanel){Ext.apply(Genapp.ConsultationPanel.prototype,{dateFormat:"f/m/d",hideMapDetails:false,queryPanelCancelButtonText:"Stopper la recherche",hideCsvExportButton:false,hideGridCsvExportMenuItem:false,hideCsvExportAlert:true,hideAggregationButton:true,hideInterpolationButton:true,hideAggregationCsvExportMenuItem:true,hidePrintMapButton:true,hidePredefinedRequestSaveButton:true,autoZoomOnResultsFeatures:true,hideUserManualLink:false,userManualLinkHref:"../pdf/ModeDEmploi.pdf",userManualLinkText:"Mode d'emploi",queryPanelWidth:380,gridPageSize:50})}if(Genapp.form.DateRangeField){Ext.apply(Genapp.form.DateRangeField.prototype,{minDefaultValue:new Date(0,0,1),maxDefaultValue:new Date(),minValue:new Date(-1,12,1),maxValue:new Date()})}if(Genapp.FieldForm){Ext.apply(Genapp.FieldForm.prototype,{dateFormat:"f/m/d",criteriaLabelWidth:130})}if(Genapp.MapPanel){Ext.apply(Genapp.MapPanel.prototype,{rightPanelWidth:175})}if(Genapp.form.GeometryField){Ext.apply(Genapp.form.GeometryField.prototype,{hideMapDetails:true,mapWindowMaximized:true,mapWindowMinZoomLevel:1,mapWindowMaximizable:false})}if(Genapp.CardPanel){Ext.apply(Genapp.CardPanel.prototype,{shownPages:["consultationpage"],activeItem:0,widthToSubstract:20,heightToSubstract:20})}};