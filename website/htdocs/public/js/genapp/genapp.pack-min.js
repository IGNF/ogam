Genapp.buildApplication=function(a){Ext.QuickTips.init();Ext.apply(Ext.QuickTips.getQuickTip(),{showDelay:250,dismissDelay:0,trackMouse:true});Ext.form.Field.prototype.msgTarget="qtip";Ext.layout.FormLayout.prototype.labelSeparator=" :";Ext.BLANK_IMAGE_URL=Genapp.base_url+"/img/s.gif";Ext.Ajax.timeout=30000;Genapp.cardPanel=new Genapp.CardPanel(a)};Genapp.util.htmlStringFormat=function(a){a=a.replace(new RegExp("'","g"),"&#39;");a=a.replace(new RegExp('"',"g"),"&#34;");return a};Genapp.util.post=function(c,e){var b=document.createElement("form");b.action=c;b.method="POST";b.style.display="none";for(var a in e){var d=document.createElement("textarea");d.name=a;d.value=e[a];b.appendChild(d)}document.body.appendChild(b);b.submit();return b};OpenLayers.Handler.FeatureInfo=OpenLayers.Class.create();OpenLayers.Handler.FeatureInfo.prototype=OpenLayers.Class.inherit(OpenLayers.Handler,{alertErrorTitle:"Error :",alertRequestFailedMsg:"Sorry, the feature info request failed...",click:function(a){var c=new OpenLayers.Pixel(a.xy.x,a.xy.y);var d=this.map.getLonLatFromPixel(c);var b=Genapp.base_url+"proxy/getInfo?SERVICE=WFS&VERSION=1.0.0&REQUEST=GetFeature&typename=result_locations&MAXFEATURES=1&BBOX="+(d.lon-500)+","+(d.lat+500)+","+(d.lon+500)+","+(d.lat-500);OpenLayers.loadURL(b,"",this,function(g){try{var f=Ext.decode(g.responseText);Genapp.cardPanel.consultationPanel.openDetails(f.id,"getmapdetails")}catch(h){Ext.Msg.alert(this.alertErrorTitle,this.alertRequestFailedMsg)}},function(e){Ext.Msg.alert(this.alertErrorTitle,this.alertRequestFailedMsg)});Event.stop(a)}});OpenLayers.Control.FeatureInfoControl=OpenLayers.Class.create();OpenLayers.Control.FeatureInfoControl.prototype=OpenLayers.Class.inherit(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,initialize:function(b,a){OpenLayers.Control.prototype.initialize.apply(this,[a])},draw:function(){this.handler=new OpenLayers.Handler.FeatureInfo(this,{click:this.click});this.activate()},CLASS_NAME:"OpenLayers.Control.FeatureInfoControl"});Genapp.CardPanel=Ext.extend(Ext.Panel,{layout:"card",activeItem:1,border:false,renderTo:"page",localeCls:"",widthToSubstract:120,heightToSubstract:210,initComponent:function(){this.addEvents("resizewrapper");Ext.getBody().addClass(this.localeCls);this.height=Ext.getBody().getViewSize().height-this.heightToSubstract;this.width=Ext.getBody().getViewSize().width-this.widthToSubstract;Ext.EventManager.onWindowResize(function(a,c){var b={width:Ext.getBody().getViewSize().width-this.widthToSubstract,height:Ext.getBody().getViewSize().height-this.heightToSubstract};this.setSize(b);this.fireEvent("resizewrapper",b.width,b.height)},this);if(!this.items){this.items=[this.predefinedRequestPanel=new Genapp.PredefinedRequestPanel(),this.consultationPanel=new Genapp.ConsultationPanel()]}Genapp.CardPanel.superclass.initComponent.call(this)}});Genapp.ConsultationPanel=Ext.extend(Ext.Panel,{region:"center",layout:"border",cls:"genapp_consultation_panel",border:false,id:"consultation_panel",localeCls:"",hideCsvExportAlert:false,hideCsvExportButton:false,hideGridCsvExportMenuItem:false,hideAggregationCsvExportMenuItem:false,hideInterpolationButton:false,hideAggregationButton:false,hidePrintMapButton:true,hideDetails:false,hideMapDetails:true,hideUserManualLink:true,hidePredefinedRequestButton:true,userManualLinkHref:Genapp.base_url+"pdf/User_Manual.pdf",userManualLinkText:"User Manual",hideDetailsVerticalLabel:false,showGridOnSubmit:false,datasetComboBoxEmptyText:"Please select a dataset...",datasetPanelTitle:"Dataset",formsPanelTitle:"Forms Panel",csvExportButtonText:"Csv Export",gridCsvExportMenuItemText:"Results",aggregationCsvExportMenuItemText:"Aggregation cells",interpolationButtonText:"Interpolation",aggregationButtonText:"Aggregation",printMapButtonText:"Print map",gridViewEmptyText:"No result...",gridPanelTitle:"Results",gridPanelTabTip:"The request's results",centerPanelTitle:"Result Panel",queryPanelTitle:"Query Panel",queryPanelPinToolQtip:"Pin the panel",queryPanelUnpinToolQtip:"Unpin the panel",queryPanelCancelButtonText:"Cancel",queryPanelPredefinedRequestButtonText:"Predefined Requests",queryPanelResetButtonText:"Reset",queryPanelSearchButtonText:"Search",queryPanelCancelButtonTooltip:"Cancel the request",queryPanelPredefinedRequestButtonTooltip:"Go to the predefined request page",queryPanelResetButtonTooltip:"Reset the request",queryPanelSearchButtonTooltip:"Launch the request",detailsPanelCtTitle:"Details",detailsPanelCtPinToolQtip:"Pin the panel",detailsPanelCtUnpinToolQtip:"Unpin the panel",mapMaskMsg:"Loading...",alertErrorTitle:"Error :",alertRequestFailedMsg:"Sorry, the request failed...",dateFormat:"Y/m/d",csvExportAlertTitle:"CSV exportation on IE",csvExportAlertMsg:"<div><H2>For your comfort on Internet Explorer you can:</H2>         <H3>Disable confirmation for file downloads.</H3>         <ul>         <li>In IE, expand the 'Tools' menu</li>         <li>Click on 'Internet Options'</li>         <li>Click on the 'Security' tab</li>         <li>Click on 'Custom Level'</li>         <li>Scroll down to the 'Downloads' part</li>         <li>Enable the confirmation for file download </li>         </ul>         <H3>Disable the file opening in the current window.</H3>         <ul>         <li>Open the workstation</li>         <li>Expand the 'Tools' menu</li>         <li>Click on 'Folder Options ...'</li>         <li>Click on the 'File Types' tab</li>         <li>Select the XLS extension</li>         <li>Click on the 'Advanced' button</li>         <li>Uncheck 'Browse in same window'</li>         </ul></div>",interpolationButtonMenuMaxDistanceTextDefaultValue:5000,autoZoomOnResultsFeatures:false,launchRequestOnPredefinedRequestLoad:true,collapseQueryPanelOnPredefinedRequestLoad:true,initComponent:function(){this.datasetDS=new Ext.data.JsonStore({url:Genapp.ajax_query_url+"ajaxgetdatasets",method:"POST",autoLoad:true,listeners:{load:{fn:function(c,b,d){for(i=0;i<b.length;i++){if(b[i].data.is_default==="1"){this.datasetComboBox.setValue(b[i].data.id);this.updateDatasetFormsPanel(b[i].data.id);break}}},scope:this}}});this.datasetComboBox=new Ext.form.ComboBox({name:"datasetId",hiddenName:"datasetId",hideLabel:true,store:this.datasetDS,editable:false,displayField:"label",valueField:"id",forceSelection:true,mode:"local",typeAhead:true,width:345,maxHeight:100,triggerAction:"all",emptyText:this.datasetComboBoxEmptyText,selectOnFocus:true,disableKeyFilter:true,listeners:{select:{fn:function(d,b,c){this.updateDatasetFormsPanel(b.data.id)},scope:this}}});this.datasetPanel=new Ext.Panel({region:"north",layout:"form",autoHeight:true,frame:true,margins:"10 0 5 0",cls:"genapp_query_panel_dataset_panel",title:this.datasetPanelTitle,items:this.datasetComboBox});this.formsPanel=new Ext.form.FieldSet({layout:"auto",region:"center",autoScroll:true,cls:"genapp_query_formspanel",frame:true,margins:"5 0 5 0",title:this.formsPanelTitle,keys:{key:Ext.EventObject.ENTER,fn:this.submitRequest,scope:this}});this.gridDSReader=new Ext.data.ArrayReader();this.gridDSReader.updateMetadata=function(b){delete this.ef;this.meta=b;this.recordType=Ext.data.Record.create(b.fields);this.onMetaChange(b,this.recordType,{metaData:b})};this.gridDS=new Ext.data.Store({autoDestroy:true,url:Genapp.ajax_query_url+"ajaxgetgridrows",remoteSort:true,reader:this.gridDSReader});this.pagingToolbar=new Ext.PagingToolbar({pageSize:Genapp.grid.pagesize,store:this.gridDS,displayInfo:true});this.pagingToolbar.reset=function(){if(!this.rendered){return}this.afterTextItem.setText(String.format(this.afterPageText,1));this.inputItem.setValue(1);this.first.setDisabled(true);this.prev.setDisabled(true);this.next.setDisabled(true);this.last.setDisabled(true);this.refresh.enable();if(this.displayItem){this.displayItem.setText(this.emptyMsg)}this.fireEvent("change",this,{total:0,activePage:1,pages:1})};this.gridView=new Ext.grid.GridView({autoFill:true,emptyText:this.gridViewEmptyText,deferEmptyText:true});this.gridView.reset=function(){this.mainBody.dom.innerHTML="&#160;"};this.gridPanel=new Ext.grid.GridPanel({frame:true,tabTip:this.gridPanelTabTip,collapsible:true,titleCollapse:true,title:this.gridPanelTitle,header:false,layout:"fit",autoScroll:true,loadMask:true,view:this.gridView,store:this.gridDS,trackMouseOver:false,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),cm:new Ext.grid.ColumnModel({}),bbar:this.pagingToolbar,listeners:{activate:function(b){if(!this.hideInterpolationButton){this.interpolationButton.hide()}if(!this.hideAggregationButton){this.aggregationButton.hide()}if(!this.hideCsvExportButton){this.csvExportButton.show()}if(!this.hidePrintMapButton){this.printMapButton.hide()}},scope:this}});this.mapPanel=new Genapp.MapPanel({hideMapDetails:this.hideMapDetails,listeners:{activate:function(b){if(!this.hideInterpolationButton){this.interpolationButton.show()}if(!this.hideAggregationButton){this.aggregationButton.show()}if(!this.hideCsvExportButton){this.csvExportButton.hide()}if(!this.hidePrintMapButton){this.printMapButton.show()}},scope:this}});this.centerPanel=new Ext.TabPanel({activeItem:0,frame:true,plain:true,region:"center",title:this.centerPanelTitle,items:[this.mapPanel,this.gridPanel]});this.centerPanel.on("render",function(d){var b=d.getEl().query(".x-tab-edge");if(!this.hideUserManualLink){Ext.DomHelper.insertBefore(b[0],{tag:"li",children:[{tag:"a",target:"_blank",href:this.userManualLinkHref,children:[{tag:"span",cls:"x-tab-strip-text genapp-query-center-panel-tab-strip-link",html:this.userManualLinkText}]}]})}function e(f){var g=Ext.DomHelper.insertBefore(b[0],{tag:"li",cls:"genapp-query-center-panel-tab-strip-top-button"},true);g.parent().setWidth("100%");g.on("mousedown",Ext.emptyFn,null,{stopPropagation:true});return new Ext.ComponentMgr.create(Ext.apply({renderTo:g.id},f))}this.mask=new Ext.LoadMask(this.getEl(),{msg:this.mapMaskMsg});this.centerPanel.doLayout();if(!this.hideInterpolationButton){this.interpolationButton=e({xtype:"splitbutton",text:this.interpolationButtonText,disabled:true,menu:this.interpolationButtonMenu=new Ext.menu.Menu({cls:"genapp-query-center-panel-interpolation-button-menu",defaults:{width:200},items:[this.interpolationButtonMenuDataCombo=new Ext.form.ComboBox({xtype:"combo",queryParam:"datasetId",store:new Ext.data.JsonStore({url:Genapp.base_url+"interpolation/ajaxgetvariables",method:"POST",listeners:{load:function(g,f,h){if(f.length==0){this.interpolationButtonMenuDataCombo.reset();delete this.interpolationButtonMenuDataCombo.lastQuery}},scope:this}}),editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a datum...",getListParent:function(){return this.el.up(".x-menu")},lastQuery:"",listeners:{beforequery:function(f){f.query=this.datasetComboBox.getValue();if(Ext.isEmpty(f.query)){f.cancel=true}},scope:this}}),this.interpolationButtonMenuGridsCombo=new Ext.form.ComboBox({xtype:"combo",store:new Ext.data.JsonStore({url:Genapp.base_url+"interpolation/ajaxgetgrids",method:"POST",autoLoad:true}),mode:"local",editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a grid...",getListParent:function(){return this.el.up(".x-menu")}}),this.interpolationButtonMenuMethodsCombo=new Ext.form.ComboBox({xtype:"combo",store:new Ext.data.JsonStore({url:Genapp.base_url+"interpolation/ajaxgetmethods",method:"POST",autoLoad:true}),mode:"local",editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a method...",getListParent:function(){return this.el.up(".x-menu")}}),this.interpolationButtonMenuMaxDistanceText=new Ext.form.TextField({xtype:"textfield",allowBlank:false,emptyText:"Select a max distance...",value:this.interpolationButtonMenuMaxDistanceTextDefaultValue,getListParent:function(){return this.el.up(".x-menu")}}),{xtype:"button",text:"Ok",handler:function(f,g){if(this.interpolationButtonMenuDataCombo.isValid(true)&&this.interpolationButtonMenuGridsCombo.isValid(true)&&this.interpolationButtonMenuMethodsCombo.isValid(true)&&this.interpolationButtonMenuMaxDistanceText.isValid(true)){this.showMask();Ext.Ajax.request({url:Genapp.base_url+"interpolation/ajax-validate-interpolation-variable-form",success:function(h,j){var h=Ext.decode(h.responseText);if(Ext.isEmpty(h.success)||h.success==false){this.hideMask();var k="An error occured during the interpolation process.";if(!Ext.isEmpty(h.errorMsg)){k+=" "+h.errorMsg}Ext.Msg.alert("Error...",k)}else{this.getStatus("interpolation",function(){this.mapPanel.enableLayersAndLegends([h.layerName],true,true)})}},failure:function(){this.hideMask();Ext.Msg.alert.createCallback("Error...","An error occured during the interpolation process.")},params:{INTERPOLATION_VARIABLE:this.interpolationButtonMenuDataCombo.getValue(),GRID_NAME:this.interpolationButtonMenuGridsCombo.getValue(),METHOD:this.interpolationButtonMenuMethodsCombo.getValue(),MAXDIST:this.interpolationButtonMenuMaxDistanceText.getValue()},scope:this});this.interpolationButtonMenu.hide()}},scope:this,style:"margin:auto;"}]})})}if(!this.hideAggregationButton){this.aggregationButton=e({xtype:"splitbutton",text:this.aggregationButtonText,disabled:true,menu:this.aggregationButtonMenu=new Ext.menu.Menu({cls:"genapp-query-center-panel-aggregation-button-menu",defaults:{width:200},items:[this.aggregationButtonMenuDataCombo=new Ext.form.ComboBox({xtype:"combo",queryParam:"datasetId",store:new Ext.data.JsonStore({url:Genapp.base_url+"aggregation/ajaxgetvariables",method:"POST",listeners:{load:function(g,f,h){if(f.length==0){this.aggregationButtonMenuDataCombo.reset();delete this.aggregationButtonMenuDataCombo.lastQuery}},scope:this}}),editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a datum...",getListParent:function(){return this.el.up(".x-menu")},lastQuery:"",listeners:{beforequery:function(f){f.query=this.datasetComboBox.getValue();if(Ext.isEmpty(f.query)){f.cancel=true}},scope:this}}),this.aggregationButtonMenuGridsCombo=new Ext.form.ComboBox({xtype:"combo",store:new Ext.data.JsonStore({url:Genapp.base_url+"aggregation/ajaxgetgrids",method:"POST",autoLoad:true}),mode:"local",editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a grid...",getListParent:function(){return this.el.up(".x-menu")}}),{xtype:"button",text:"Ok",handler:function(f,g){if(this.aggregationButtonMenuDataCombo.isValid(true)&&this.aggregationButtonMenuGridsCombo.isValid(true)){this.showMask();Ext.Ajax.request({url:Genapp.base_url+"aggregation/ajax-validate-aggregation-variable-form",success:function(h,j){var h=Ext.decode(h.responseText);if(Ext.isEmpty(h.success)||h.success==false){this.hideMask();var k="An error occured during the aggregation process.";if(!Ext.isEmpty(h.errorMsg)){k+=" "+h.errorMsg}Ext.Msg.alert("Error...",k)}else{this.getStatus("aggregation",function(){this.aggregationCsvExportMenuItem.enable();this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.aggregation,true,true,true);this.mapPanel.enableLayersAndLegends([h.layerName],true,true)})}},failure:function(){this.hideMask();Ext.Msg.alert.createCallback("Error...","An error occured during the aggregation process.")},params:{AGGREGATE_VARIABLE:this.aggregationButtonMenuDataCombo.getValue(),GRID_NAME:this.aggregationButtonMenuGridsCombo.getValue()},scope:this});this.aggregationButtonMenu.hide()}},scope:this,style:"margin:auto;"}]})})}var c=[];if(!this.hideGridCsvExportMenuItem){c.push(this.gridCsvExportMenuItem=new Ext.menu.Item({text:this.gridCsvExportMenuItemText,handler:this.exportCSV.createDelegate(this,["grid-csv-export"]),iconCls:"genapp-query-center-panel-grid-csv-export-menu-item-icon"}))}if(!this.hideAggregationCsvExportMenuItem){c.push(this.aggregationCsvExportMenuItem=new Ext.menu.Item({text:this.aggregationCsvExportMenuItemText,handler:this.exportCSV.createDelegate(this,["aggregation-csv-export"]),iconCls:"genapp-query-center-panel-aggregation-csv-export-menu-item-icon",disabled:true}))}if(!this.hideCsvExportButton){this.csvExportButton=e({xtype:"splitbutton",text:this.csvExportButtonText,disabled:true,menu:this.csvExportButtonMenu=new Ext.menu.Menu({items:c})})}if(!this.hidePrintMapButton){this.printMapButton=e({xtype:"button",iconCls:"genapp-query-center-panel-print-map-button-icon",text:this.printMapButtonText,handler:this.printMap,scope:this})}},this,{single:true});this.queryPanelPinned=true;var a={region:"west",title:this.queryPanelTitle,collapsible:true,margins:"0 5 0 0",titleCollapse:true,width:370,frame:true,layout:"border",cls:"genapp_query_panel",items:[this.datasetPanel,this.formsPanel],tools:[{id:"pin",qtip:this.queryPanelPinToolQtip,hidden:true,handler:function(d,c,b){c.hide();b.header.child(".x-tool-unpin").show();this.queryPanelPinned=true},scope:this},{id:"unpin",qtip:this.queryPanelUnpinToolQtip,handler:function(d,c,b){c.hide();b.header.child(".x-tool-pin").show();this.queryPanelPinned=false},scope:this}],bbar:[{xtype:"tbbutton",text:this.queryPanelCancelButtonText,tooltipType:"title",tooltip:this.queryPanelCancelButtonTooltip,cls:"genapp_query_formspanel_cancel_button",scope:this,handler:this.cancelRequest},{xtype:"tbseparator"},{xtype:"tbbutton",text:this.queryPanelResetButtonText,tooltipType:"title",tooltip:this.queryPanelResetButtonTooltip,cls:"genapp_query_formspanel_reset_button",scope:this,handler:this.resetRequest},{xtype:"tbfill"},{xtype:"tbbutton",text:this.queryPanelSearchButtonText,tooltipType:"title",tooltip:this.queryPanelSearchButtonTooltip,cls:"genapp_query_formspanel_search_button",scope:this,handler:this.submitRequest}]};if(!this.hidePredefinedRequestButton){a.tbar={cls:"genapp_query_panel_tbar",items:[{xtype:"tbbutton",text:this.queryPanelPredefinedRequestButtonText,tooltipType:"title",tooltip:this.queryPanelPredefinedRequestButtonTooltip,scope:this,handler:function(c,d){Genapp.cardPanel.getLayout().setActiveItem("predefined_request")}}]}}this.queryPanel=new Ext.FormPanel(a);if(!this.hideRequestVerticalLabel){this.addVerticalLabel(this.queryPanel,"genapp-query-request-panel-ct-xcollapsed-vertical-label-div")}this.detailsPanel=new Ext.TabPanel({frame:true,plain:true,enableTabScroll:true,cls:"genapp-query-details-panel",scrollIncrement:91,scrollRepeatInterval:100,idDelimiter:"___"});this.detailsPanelPinned=true;this.detailsPanelCt=new Ext.Panel({region:"east",title:this.detailsPanelCtTitle,frame:true,split:true,layout:"fit",width:344,minWidth:200,collapsible:true,titleCollapse:true,collapsed:true,items:this.detailsPanel,tools:[{id:"pin",qtip:this.detailsPanelCtPinToolQtip,hidden:true,handler:function(d,c,b){c.hide();b.header.child(".x-tool-unpin").show();this.detailsPanelPinned=true},scope:this},{id:"unpin",qtip:this.detailsPanelCtUnpinToolQtip,handler:function(d,c,b){c.hide();b.header.child(".x-tool-pin").show();this.detailsPanelPinned=false},scope:this}]});if(!this.hideDetailsVerticalLabel){this.addVerticalLabel(this.detailsPanelCt,"genapp-query-details-panel-ct-xcollapsed-vertical-label-div")}if(!this.items){this.items=[this.queryPanel,this.centerPanel];if(!this.hideDetails){this.items.push(this.detailsPanelCt)}}Genapp.ConsultationPanel.superclass.initComponent.call(this)},updateWestPanels:function(b,d,f,e){var a=Ext.decode(b.responseText);this.formsPanel.body.update();for(var c=0;c<a.data.length;c++){if(!(Ext.isEmpty(a.data[c].criteria)&&Ext.isEmpty(a.data[c].columns))){this.formsPanel.add(new Genapp.FieldForm({title:a.data[c].label,id:a.data[c].id,criteria:a.data[c].criteria,criteriaValues:e,columns:a.data[c].columns}))}}this.formsPanel.doLayout();if(!Ext.isEmpty(f)){if(f.collapseQueryPanel==true){this.queryPanel.collapse()}if(f.launchRequest==true){this.submitRequest()}}},renderLeftTools:function(f,e,a,g,d,b){var c="";if(!this.hideDetails){c="<div class=\"genapp-query-grid-slip\" onclick=\"Genapp.cardPanel.consultationPanel.openDetails('{0}', 'getdetails');\"></div>"}c+="<div class=\"genapp-query-grid-map\" onclick=\"Genapp.cardPanel.consultationPanel.displayLocation('{0}','{1}');\"></div>";return String.format(c,a.data.id,a.data.location_centroid)},openDetails:function(d,a){if(!Ext.isEmpty(d)){var b=Ext.getCmp("consultation_panel");b.collapseQueryPanel();b.detailsPanel.ownerCt.expand();var c=b.detailsPanel.get(d);if(Ext.isEmpty(c)){c=b.detailsPanel.add(new Genapp.DetailsPanel({rowId:d,dataUrl:a}))}b.detailsPanel.activate(c)}},displayLocation:function(c,b){var a=Ext.getCmp("consultation_panel");a.centerPanel.activate(a.mapPanel);a.mapPanel.zoomToFeature(c,b)},cancelRequest:function(){if(this.requestConn&&this.requestConn!==null){this.requestConn.abort();this.gridPanel.loadMask.hide();this.mapMask.hide()}},resetRequest:function(){this.updateDatasetFormsPanel(this.datasetComboBox.getValue())},submitRequest:function(){if(!this.hideAggregationButton){this.aggregationButton.disable();this.aggregationButtonMenuDataCombo.reset();this.aggregationButtonMenuGridsCombo.reset();delete this.aggregationButtonMenuDataCombo.lastQuery}if(!this.hideAggregationCsvExportMenuItem){this.aggregationCsvExportMenuItem.disable()}if(!this.hideInterpolationButton){this.interpolationButton.disable();this.interpolationButtonMenuDataCombo.reset();this.interpolationButtonMenuGridsCombo.reset();this.interpolationButtonMenuMethodsCombo.reset();this.interpolationButtonMenuMaxDistanceText.setValue(this.interpolationButtonMenuMaxDistanceTextDefaultValue);delete this.interpolationButtonMenuDataCombo.lastQuery}if(!this.hideCsvExportButton){this.csvExportButton.disable()}this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.request,true,false,true);this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.aggregation,true,true,true);this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.interpolation,true,true,true);if(!this.mapResultLayers){var a=this.mapPanel.layersActivation.request;this.mapResultLayers=[];for(var c=0;c<a.length;c++){var b=this.mapPanel.map.getLayersByName(a[c])[0];b.events.register("loadend",this,function(e){this.mapResultLayersLoadEnd[e.object.name]=1;var d=0;for(b in this.mapResultLayersLoadEnd){if(typeof this.mapResultLayersLoadEnd[b]!=="function"){d+=this.mapResultLayersLoadEnd[b]}}if(d===this.mapResultLayers.length){this.mapMask.hide()}});this.mapResultLayers.push(b)}}this.mapResultLayersLoadEnd={};for(var c=0;c<this.mapResultLayers.length;c++){var b=this.mapResultLayers[c];this.mapResultLayersLoadEnd[b.name]=0}if(!this.mapMask){this.mapMask=new Ext.LoadMask(this.mapPanel.getEl(),{msg:this.mapMaskMsg})}if(this.showGridOnSubmit){this.centerPanel.activate(this.mapPanel);this.mapMask.show();this.centerPanel.activate(this.gridPanel);this.gridPanel.loadMask.show()}else{this.centerPanel.activate(this.gridPanel);this.gridPanel.loadMask.show();this.centerPanel.activate(this.mapPanel);this.mapMask.show()}for(var c=0;c<this.mapResultLayersLoadEnd.length;c++){var b=this.mapResultLayersLoadEnd[c];b.display(false)}this.mapPanel.clean();this.clearGrid();Ext.Ajax.on("beforerequest",function(e,d){this.requestConn=e},this,{single:true});this.formsPanel.findParentByType("form").getForm().submit({url:Genapp.ajax_query_url+"ajaxgetgridcolumns",timeout:480000,success:function(h,k){this.requestConn=null;var g=k.result.columns;var e=new Array({header:"",renderer:this.renderLeftTools.createDelegate(this),sortable:false,fixed:true,menuDisabled:true,align:"center",width:52});var j=new Array();var d;var l;for(var f=0;f<g.length;f++){d={header:Genapp.util.htmlStringFormat(g[f].label),sortable:true,dataIndex:g[f].name,width:100,tooltip:Genapp.util.htmlStringFormat(g[f].definition),hidden:g[f].hidden};l={name:g[f].name};switch(g[f].type){case"STRING":d.xtype="gridcolumn";l.type="string";break;case"INTEGER":d.xtype="gridcolumn";break;case"NUMERIC":d.xtype="numbercolumn";if(g[f].decimals!=null){d.format=this.numberPattern(".",g[f].decimals)}break;case"RANGE":d.xtype="numbercolumn";if(g[f].decimals!=null){d.format=this.numberPattern(".",g[f].decimals)}break;case"DATE":d.xtype="datecolumn";d.format=this.dateFormat;break;default:d.xtype="gridcolumn";l.type="auto";break}e.push(d);j.push(l)}this.gridDSReader.updateMetadata({root:"rows",fields:j,totalProperty:"total"});if(this.centerPanel.getActiveTab() instanceof Genapp.MapPanel){this.centerPanel.activate(this.gridPanel);this.gridPanel.getColumnModel().setConfig(e);this.centerPanel.activate(this.mapPanel)}else{this.gridPanel.getColumnModel().setConfig(e)}this.gridPanel.getView().reset();Ext.Ajax.on("beforerequest",function(n,m){this.requestConn=n},this,{single:true});this.gridPanel.getStore().load({params:{start:0,limit:Genapp.grid.pagesize},callback:function(){this.requestConn=null;this.getResultsBBox();if(this.autoZoomOnResultsFeatures!=true){this.mapPanel.enableLayersAndLegends(this.mapPanel.layersActivation.request,true,true)}this.collapseQueryPanel();this.collapseDetailsPanel();if(!this.hideAggregationButton){this.aggregationButton.enable()}if(!this.hideInterpolationButton){this.interpolationButton.enable()}if(!this.hideCsvExportButton){this.csvExportButton.enable()}this.gridPanel.syncSize()},scope:this})},failure:function(d,e){if(e.result&&e.result.errorMessage){Ext.Msg.alert(this.alertErrorTitle,e.result.errorMessage)}else{Ext.Msg.alert(this.alertErrorTitle,this.alertRequestFailedMsg)}this.gridPanel.loadMask.hide();this.mapMask.hide()},scope:this})},collapseQueryPanel:function(){if(!this.queryPanelPinned){this.queryPanel.collapse()}},collapseDetailsPanel:function(){if(!this.detailsPanelPinned){this.detailsPanel.ownerCt.collapse()}},updateFormsPanel:function(b,c,a){this.formsPanel.removeAll(true);this.formsPanel.getUpdater().showLoading();Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetforms",success:this.updateWestPanels.createDelegate(this,[c,a],true),method:"POST",params:b,scope:this})},updatePredefinedRequestFormsPanel:function(b,a){this.updateFormsPanel({requestName:b},{launchRequest:this.launchRequestOnPredefinedRequestLoad,collapseQueryPanel:this.collapseQueryPanelOnPredefinedRequestLoad},a)},updateDatasetFormsPanel:function(a){this.updateFormsPanel({datasetId:a})},loadRequest:function(a){this.datasetComboBox.setValue(a.datasetId);this.updatePredefinedRequestFormsPanel(a.name,a.fieldValues)},clearGrid:function(){var a=this.gridPanel.getStore();if(a.getCount()!=0){this.gridPanel.getBottomToolbar().reset()}if(this.gridPanel.rendered){this.gridPanel.getColumnModel().setConfig({});this.gridPanel.getView().updateAllColumnWidths();this.gridPanel.getView().reset()}},exportCSV:function(a){var b=function(d,e,c){this.showMask(true);window.location=Genapp.ajax_query_url+a};if(Ext.isIE&&!this.hideCsvExportAlert){Ext.Msg.show({title:this.csvExportAlertTitle,msg:this.csvExportAlertMsg,cls:"genapp-query-center-panel-csv-export-alert",buttons:Ext.Msg.OK,fn:b,animEl:this.csvExportButton.getEl(),icon:Ext.MessageBox.INFO,scope:this});this.hideCsvExportAlert=true}else{b.call(this)}},printMap:function(d,f){var a=this.mapPanel.map.center;var e=this.mapPanel.map.zoom;var g=this.mapPanel.map.getLayersBy("visibility",true);var b="";for(var c=0;c<g.length;c++){if(g[c].printable!==false){b+=g[c].name+","}}b=b.substr(0,b.length-1);Genapp.util.post(Genapp.base_url+"map/ajaxgeneratemap",{center:a,zoom:e,layers:b})},showMask:function(a){this.mask.show();if(a){window.onfocus=(function(){this.mask.hide();window.onfocus=Ext.emptyFn}).createDelegate(this)}},numberPattern:function(c,e,a){var d=[];d.push("0");if(a){d.push(a+"000")}if(e){d.push(c);for(var b=0;b<e;b++){d.push("0")}}return d.join("")},hideMask:function(){this.mask.hide()},addVerticalLabel:function(b,a){b.on("collapse",function(c){Ext.get(c.id+"-xcollapsed").createChild({tag:"div",cls:a})},this,{single:true})},getStatus:function(a,b){Ext.Ajax.request({url:Genapp.base_url+a+"/ajax-get-status",success:function(c,d){var c=Ext.decode(c.responseText);if(Ext.isEmpty(c.success)||c.success==false){this.hideMask();var e="An error occured during the status request.";if(!Ext.isEmpty(c.errorMsg)){e+=" "+c.errorMsg}Ext.Msg.alert("Error...",e)}else{if(c.status=="RUNNING"){this.getStatus.defer(2000,this,[a,b])}else{if(c.status=="OK"){this.hideMask();b.call(this)}else{this.hideMask();var e="An error occured during the status request.";if(!Ext.isEmpty(c.errorMsg)){e+=" "+c.errorMsg}Ext.Msg.alert("Error...",e)}}}},failure:function(){this.hideMask();var c="An error occured during the status request.";Ext.Msg.alert("Error...",c)},scope:this})},getResultsBBox:function(){Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetresultsbbox",success:function(a,b){try{var a=Ext.decode(a.responseText);if(Ext.isEmpty(a.success)||a.success==false){if(!Ext.isEmpty(a.errorMsg)){throw (a.errorMsg)}throw ("")}else{if(!Ext.isEmpty(a.resultsbbox)){this.mapPanel.resultsBBox=a.resultsbbox}else{this.mapPanel.resultsBBox=null}if(this.autoZoomOnResultsFeatures==true){if(this.mapPanel.resultsBBox!==null){this.mapPanel.zoomOnBBox(this.mapPanel.resultsBBox)}this.mapPanel.enableLayersAndLegends(this.mapPanel.layersActivation.request,true,true)}}}catch(c){var d="An error occured during the bounding box request.";if(!Ext.isEmpty(c)){d+=" "+c}Ext.Msg.alert("Error...",d)}},failure:function(a,b){var c="An error occured during the bounding box request. Status code : "+a.status;Ext.Msg.alert("Error...",c)},scope:this})}});Ext.namespace("Genapp");Genapp.DateRangePicker=Ext.extend(Ext.Panel,{layout:"column",cls:"x-menu-date-range-item",buttonAlign:"center",hideValidationButton:false,tbarStartDateButtonText:"Start Date ...",tbarRangeDateButtonText:"Range Date",tbarEndDateButtonText:"... End Date",fbarOkButtonText:"ok",selectedDate:{startDate:null,endDate:null},initComponent:function(){this.items=[this.startDatePicker=new Ext.DatePicker(Ext.apply({internalRender:this.strict||!Ext.isIE,ctCls:"x-menu-date-item",columnWidth:0.5},this.initialConfig)),{xtype:"spacer",width:5,html:"&nbsp;"},this.endDatePicker=new Ext.DatePicker(Ext.apply({internalRender:this.strict||!Ext.isIE,ctCls:"x-menu-date-item",columnWidth:0.5},this.initialConfig))];this.startDatePicker.on("select",this.startDateSelect,this);this.endDatePicker.on("select",this.endDateSelect,this);this.tbar=new Ext.Toolbar({items:[this.startDateButton=new Ext.Button({text:this.tbarStartDateButtonText,cls:"x-menu-date-range-item-start-date-button",enableToggle:true,allowDepress:false,toggleGroup:"DateButtonsGroup",toggleHandler:this.onStartDatePress.createDelegate(this)}),this.rangeDateButton=new Ext.Button({text:this.tbarRangeDateButtonText,cls:"x-menu-date-range-item-range-date-button",pressed:true,enableToggle:true,allowDepress:false,toggleGroup:"DateButtonsGroup",toggleHandler:this.onRangeDatePress.createDelegate(this)}),"->",this.endDateButton=new Ext.Button({text:this.tbarEndDateButtonText,cls:"x-menu-date-range-item-end-date-button",enableToggle:true,allowDepress:false,toggleGroup:"DateButtonsGroup",toggleHandler:this.onEndDatePress.createDelegate(this)})]});if(!this.hideValidationButton){this.fbar=new Ext.Toolbar({cls:"x-date-bottom",items:[{xtype:"button",text:this.fbarOkButtonText,width:"auto",handler:this.onOkButtonPress.createDelegate(this)}]})}Genapp.DateRangePicker.superclass.initComponent.call(this)},onRangeDatePress:function(a,b){if(b){this.startDatePicker.enable();this.endDatePicker.enable();this.resetDates()}},onStartDatePress:function(a,b){if(b){this.startDatePicker.enable();this.endDatePicker.disable();this.resetDates()}},onEndDatePress:function(a,b){if(b){this.startDatePicker.disable();this.endDatePicker.enable();this.resetDates()}},startDateSelect:function(b,a){this.selectedDate.startDate=a;if(this.startDateButton.pressed){this.returnSelectedDate()}else{if(this.selectedDate.endDate!==null){this.returnSelectedDate()}}},endDateSelect:function(b,a){this.selectedDate.endDate=a;if(this.endDateButton.pressed){this.returnSelectedDate()}else{if(this.selectedDate.startDate!==null){this.returnSelectedDate()}}},resetselectedDate:function(){this.selectedDate={startDate:null,endDate:null}},resetDates:function(){this.resetselectedDate();this.startDatePicker.setValue(this.startDatePicker.defaultValue);this.endDatePicker.setValue(this.endDatePicker.defaultValue)},returnSelectedDate:function(){this.fireEvent("select",this,this.selectedDate);this.resetselectedDate()},isEnabledDate:function(a){if((a.activeDate.getTime()-a.minDate.getTime()>=0)&&(a.maxDate.getTime()-a.activeDate.getTime()>=0)){return true}else{return false}},onOkButtonPress:function(a,b){if(b){if(this.startDateButton.pressed){if(this.isEnabledDate(this.startDatePicker)){this.selectedDate={startDate:this.startDatePicker.activeDate,endDate:null};this.returnSelectedDate()}}else{if(this.endDateButton.pressed){if(this.isEnabledDate(this.endDatePicker)){this.selectedDate={startDate:null,endDate:this.endDatePicker.activeDate};this.returnSelectedDate()}}else{if(this.isEnabledDate(this.startDatePicker)&&this.isEnabledDate(this.endDatePicker)){this.selectedDate={startDate:this.startDatePicker.activeDate,endDate:this.endDatePicker.activeDate};this.returnSelectedDate()}}}}}});Ext.reg("daterangepicker",Genapp.DateRangePicker);Genapp.DetailsPanel=Ext.extend(Ext.Panel,{headerWidth:60,closable:true,autoScroll:true,dataUrl:null,cls:"genapp-query-details-panel",tpl:new Ext.XTemplate('<tpl for="map">','<img title="{title}" src="{url}">',"</tpl>",'<tpl for="formats">','<tpl if="is_array != true">',"<fieldset>",'<legend align="top"> {title} </legend>','<tpl for="fields">',"<p><b>{label} :</b> {value}</p>","</tpl>","</fieldset>","</tpl>",'<tpl if="is_array == true">',"<table>","<caption>{title}</caption>","<tr>",'<tpl for="columns">',"<th>{label}</th>","</tpl>","</tr>",'<tpl for="rows">',"<tr>",'<tpl for=".">',"<td>{.}</td>","</tpl>","</tr>","</tpl>","</table>","</tpl>","</tpl>"),loadingMsg:"Loading...",initComponent:function(){this.title='<div style="width:'+this.headerWidth+'px;">'+this.loadingMsg+"</div>";this.on("render",this.updateDetails,this);this.itemId=this.rowId;Genapp.DetailsPanel.superclass.initComponent.call(this)},updateDetails:function(a){this.getUpdater().showLoading();Ext.Ajax.request({url:Genapp.ajax_query_url+this.dataUrl,success:function(b,c){var d=Ext.decode(b.responseText);this.setTitle('<div style="width:'+this.headerWidth+'px;">'+d.title+"</div>");this.tpl.overwrite(this.body,d)},method:"POST",params:{id:this.rowId},scope:this})}});Genapp.FieldForm=Ext.extend(Ext.Panel,{frame:true,cls:"genapp-query-field-form-panel",criteriaPanelTbarLabel:"Criteria",criteriaPanelTbarComboLoadingText:"searching...",columnsPanelTbarLabel:"Columns",columnsPanelTbarComboEmptyText:"Select...",columnsPanelTbarComboLoadingText:"searching...",columnsPanelTbarAddAllButtonTooltip:"Add all the columns",columnsPanelTbarRemoveAllButtonTooltip:"Remove all the columns",initComponent:function(){this.criteriaDS=new Ext.data.JsonStore({fields:[{name:"name",mapping:"a"},{name:"label",mapping:"b"},{name:"inputType",mapping:"c"},{name:"type",mapping:"d"},{name:"definition",mapping:"e"},{name:"is_default",mapping:"f"},{name:"default_value",mapping:"g"},{name:"params",mapping:"p"}],data:this.criteria});this.columnsDS=new Ext.data.JsonStore({fields:[{name:"name",mapping:"a"},{name:"label",mapping:"b"},{name:"definition",mapping:"c"},{name:"is_default",mapping:"d"},{name:"params",mapping:"p"}],data:this.columns});this.criteriaPanel=new Ext.Panel({layout:"form",hidden:Ext.isEmpty(this.criteria)?true:false,hideMode:"offsets",labelWidth:120,cls:"genapp-query-criteria-panel",defaults:{labelStyle:"padding: 0; margin-top:3px",width:180},listeners:{add:function(b,g,e){if(b.defaultType==="panel"){if(e==0){var f="first-child";if(g.rendered){g.getEl().addClass(f)}else{g.itemCls?g.itemCls+=" "+f:g.itemCls=f}}var c=g.name;var d=0;var j;var a="";var h=g.ownerCt;do{a=c+"["+d+++"]"}while(h.items.findIndex("name",a)!==-1);g.name=g.hiddenName=a}},scope:this},items:this.getDefaultCriteriaConfig(),tbar:[{xtype:"tbfill"},new Ext.Toolbar.TextItem(this.criteriaPanelTbarLabel),{xtype:"tbspacer"},{xtype:"combo",hiddenName:"Criteria",store:this.criteriaDS,editable:false,displayField:"label",valueField:"name",mode:"local",width:220,maxHeight:100,triggerAction:"all",emptyText:this.criteriaPanelTbarComboEmptyText,loadingText:this.criteriaPanelTbarComboLoadingText,listeners:{scope:this,select:{fn:this.addCriteria,scope:this}}},{xtype:"tbspacer"}]});this.columnsPanel=new Ext.Panel({layout:"form",hidden:Ext.isEmpty(this.columns)?true:false,hideMode:"offsets",cls:"genapp-query-columns-panel",items:this.getDefaultColumnsConfig(),tbar:[{xtype:"tbbutton",tooltip:this.columnsPanelTbarAddAllButtonTooltip,ctCls:"genapp-tb-btn",iconCls:"genapp-tb-btn-add",handler:this.addAllColumns,scope:this},{xtype:"tbbutton",tooltip:this.columnsPanelTbarRemoveAllButtonTooltip,ctCls:"genapp-tb-btn",iconCls:"genapp-tb-btn-remove",handler:this.removeAllColumns,scope:this},{xtype:"tbfill"},new Ext.Toolbar.TextItem(this.columnsPanelTbarLabel),{xtype:"tbspacer"},{xtype:"combo",fieldLabel:"Columns",hiddenName:"Columns",store:this.columnsDS,editable:false,displayField:"label",valueField:"name",mode:"local",width:220,maxHeight:100,triggerAction:"all",emptyText:this.columnsPanelTbarComboEmptyText,loadingText:this.columnsPanelTbarComboLoadingText,listeners:{scope:this,select:{fn:this.addColumn,scope:this}}},{xtype:"tbspacer"}]});if(!this.items){this.items=[this.criteriaPanel,this.columnsPanel]}this.collapsible=true;this.titleCollapse=true;Genapp.FieldForm.superclass.initComponent.call(this);this.doLayout()},addCriteria:function(c,a,b){if(c!==null){c.clearValue();c.collapse()}this.criteriaPanel.add(this.getCriteriaConfig(a.data,false));this.criteriaPanel.doLayout()},getDefaultCriteriaConfig:function(){var a=[];this.criteriaDS.each(function(c){if(c.data.is_default){var b=c.data.default_value;if(!Ext.isEmpty(b)){var h=b.split(";");var g=Ext.isEmpty(this.form.criteriaValues);for(var e=0;e<h.length;e++){var d=c.copy();if(g){d.data.default_value=h[e]}else{var f=this.form.criteriaValues["criteria__"+d.data.name];if(!Ext.isEmpty(f)){if(Ext.isArray(f)){d.data.default_value=f[e]}else{d.data.default_value=f}}else{d.data.default_value=h[e]}}this.items.push(this.form.getCriteriaConfig(d.data,false))}}}},{form:this,items:a});return a},addColumn:function(c,a,b){if(c!==null){c.clearValue();c.collapse()}if(this.columnsPanel.find("name","column__"+a.data.name).length===0){this.columnsPanel.add(this.getColumnConfig(a.data));this.columnsPanel.doLayout()}},getColumnConfig:function(a){var b={xtype:"container",autoEl:"div",cls:"genapp-query-column-item",items:[{xtype:"box",autoEl:{tag:"div",cls:"columnLabelBin",html:"&nbsp;&nbsp;&nbsp;&nbsp;"},listeners:{render:function(c){c.getEl().on("click",function(f,e,d){this.columnsPanel.remove(c.ownerCt)},this,{single:true})},scope:this}},{xtype:"box",autoEl:{tag:"span",cls:"columnLabel","ext:qtitle":Genapp.util.htmlStringFormat(a.label),"ext:qwidth":200,"ext:qtip":Genapp.util.htmlStringFormat(a.definition),html:a.label}},{xtype:"hidden",name:"column__"+a.name,value:"1"}]};return b},getDefaultColumnsConfig:function(){var a=[];this.columnsDS.each(function(b){if(b.data.is_default){this.items.push(this.form.getColumnConfig(b.data))}},{form:this,items:a});return a},addAllColumns:function(){this.columnsDS.each(function(a){this.addColumn(null,a)},this)},removeAllColumns:function(){this.columnsPanel.removeAll()}});Ext.apply(Genapp.FieldForm.prototype,{criteriaPanelTbarComboEmptyText:"Select...",dateFormat:"Y/m/d",getCriteriaConfig:function(b,d){if(!Ext.isEmpty(b.default_value)&&Ext.isString(b.default_value)&&b.default_value.indexOf(";")!=-1){var a=[];var f=b.default_value.split(";");for(var c=0;c<f.length;c++){b.default_value=f[c];a.push(Genapp.FieldForm.prototype.getCriteriaConfig(b,d))}return a}var e={};e.name="criteria__"+b.name;switch(b.inputType){case"SELECT":e.xtype="combo";e.itemCls="trigger-field";e.hiddenName=e.name;e.triggerAction="all";e.typeAhead=true;e.mode="local";e.displayField="label";e.valueField="code";e.emptyText=Genapp.FieldForm.prototype.criteriaPanelTbarComboEmptyText;e.disableKeyFilter=true;e.store=new Ext.data.ArrayStore({fields:["code","label"],data:b.params.options});break;case"DATE":e.xtype="daterangefield";e.itemCls="trigger-field";e.format=Genapp.FieldForm.prototype.dateFormat;break;case"NUMERIC":e.xtype="numberrangefield";e.itemCls="trigger-field";if(b.type=="RANGE"){e.minValue=b.params.min;e.maxValue=b.params.max}if(b.type=="INTEGER"){e.allowDecimals=false;e.decimalPrecision=0}break;case"CHECKBOX":e.xtype="switch_checkbox";e.ctCls="improvedCheckbox";switch(b.default_value){case 1:case"1":case true:case"true":e.inputValue="1";break;default:e.inputValue="0";break}break;case"RADIO":case"TEXT":switch(b.type){case"INTEGER":e.xtype="numberfield";e.allowDecimals=false;break;case"NUMERIC":e.xtype="numberfield";break;default:e.xtype="textfield";break}break;case"GEOM":e.xtype="geometryfield";e.itemCls="trigger-field";break;default:e.xtype="field";break}if(!Ext.isEmpty(b.default_value)){e.value=b.default_value}if(!Ext.isEmpty(b.fixed)){e.disabled=b.fixed}e.fieldLabel=b.label;if(!d){e.listeners={render:function(j){var h=Ext.get("x-form-el-"+j.id).parent();var k=h.child(".x-form-item-label");k.set({"ext:qtitle":b.label,"ext:qwidth":200,"ext:qtip":b.definition});k.addClass("labelNextBin");var g=h.createChild({tag:"div",cls:"filterBin"},k);g.insertHtml("afterBegin","&nbsp;&nbsp;&nbsp;");g.on("click",function(n,m,l){j.ownerCt.remove(j)},this,{single:true})},scope:this}}return e}});Genapp.MapPanel=Ext.extend(Ext.Panel,{frame:true,collapsible:true,titleCollapse:true,title:"Map",header:false,layout:"border",isDrawingMap:false,featureWKT:null,tabTip:"The map with the request's results's location",hideLayersAndLegendVerticalLabel:false,rightPanelCollapsed:false,rightPanelWidth:170,layerPanelTitle:"Layers",layerPanelTabTip:"The layers's tree",legendPanelTitle:"Legends",legendPanelTabTip:"The layers's legends",panZoomBarControlTitle:"Zoom",navigationControlTitle:"Drag the map",selectFeatureControlTitle:"Select Feature",invalidWKTMsg:"The feature cannot be displayed",zoomToFeaturesControlTitle:"Zoom to the features",drawFeatureControlTitle:"Draw a polygon",modifyFeatureControlTitle:"Update the feature",tbarDeleteFeatureButtonTooltip:"Delete the feature",tbarPreviousButtonTooltip:"Previous Position",tbarNextButtonTooltip:"Next Position",zoomBoxInControlTitle:"Zoom in",zoomBoxOutControlTitle:"Zoom out",zoomToMaxExtentControlTitle:"Zoom to max extend",featureInfoControlTitle:"Get the plot location information",hideLegalMentions:true,legalMentionsLinkHref:Genapp.base_url+"map/show-legal-mentions",legalMentionsLinkText:"Legal Mentions",minZoomLevel:0,resultsBBox:null,layersActivation:{},initComponent:function(){this.addEvents("afterinit");this.toolbar=new mapfish.widgets.toolbar.Toolbar({configurable:false});this.layersAndLegendsPanel=new Ext.TabPanel({region:"east",width:this.rightPanelWidth,collapsed:this.rightPanelCollapsed,collapsible:true,titleCollapse:false,cls:"genapp-query-map-right-panel",activeItem:0,split:true,items:[this.layerPanel=new Ext.Panel({layout:"fit",cls:"genapp-query-layer-tree-panel",title:this.layerPanelTitle,tabTip:this.layerPanelTabTip,frame:true,layoutConfig:{animate:true}}),this.legendPanel=new Ext.Panel({cls:"genapp-query-legend-panel",title:this.legendPanelTitle,tabTip:this.legendPanelTabTip,frame:true,layoutConfig:{animate:true}})]});if(!this.hideLayersAndLegendVerticalLabel){this.layersAndLegendsPanel.on("collapse",function(a){Ext.get(a.id+"-xcollapsed").createChild({tag:"div",cls:"genapp-query-map-right-panel-xcollapsed-vertical-label-div"})},this,{single:true})}this.items=[this.mapPanel=new Ext.Panel({region:"center",cls:"genapp_query_mappanel",frame:true,layout:"fit",tbar:this.toolbar,xtype:"panel",listeners:{render:function(a){a.body.setStyle("width","100%");a.body.setStyle("height","100%");Ext.Ajax.request({url:Genapp.base_url+"map/getLayers",success:function(c,e){var d=Ext.decode(c.responseText);this.layersList=[];this.layersActivation={};for(var f=0;f<d.layers.length;f++){var h;if(d.layers[f].untiled){h=new OpenLayers.Layer.WMS.Untiled(d.layers[f].name,d[d.layers[f].url],d.layers[f].params,d.layers[f].options)}else{h=new OpenLayers.Layer.WMS(d.layers[f].name,d[d.layers[f].url],d.layers[f].params,d.layers[f].options)}this.layersList.push(h);var b=d.layers[f].params.activateType.toLowerCase();if(Ext.isEmpty(this.layersActivation[b])){this.layersActivation[b]=[d.layers[f].name]}else{this.layersActivation[b].push(d.layers[f].name)}if(d.layers[f].hasLegend){var g=a.ownerCt.items.get(1).items.get(1).add(new Ext.BoxComponent({id:this.id+d.layers[f].name,autoEl:{tag:"div",children:[{tag:"span",html:d.layers[f].options.label,cls:"x-form-item x-form-item-label"},{tag:"img",src:Genapp.base_url+"proxy/getlegendimage?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetLegendGraphic&Format=image/png&WIDTH=160&LAYER="+d.layers[f].params.layers+"&HASSLD="+(d.layers[f].params.hasSLD?"true":"false")}]}}));if(d.layers[f].params.isDisabled||d.layers[f].params.isHidden||!d.layers[f].params.isChecked){g.on("render",function(j){j.hide()});g.on("show",(function(j,k){if(j.rendered){j.getEl().child("img").dom.src=Genapp.base_url+"proxy/getlegendimage?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetLegendGraphic&Format=image/png&WIDTH=160&LAYER="+k.layers+"&HASSLD="+(k.hasSLD?"true":"false")+"&dc="+(new Date()).getTime()}}).createCallback(g,d.layers[f].params))}}}a.ownerCt.items.get(1).items.get(1).doLayout();this.initMap(a.body.id);a.on("bodyresize",this.map.updateSize,this.map);if(!this.hideLegalMentions){a.el.createChild({tag:"div",cls:"genapp-map-panel-legal-mentions",children:[{tag:"a",target:"_blank",href:this.legalMentionsLinkHref,html:this.legalMentionsLinkText}]},a.el.child(".olMapViewport",true)).on("click",Ext.emptyFn,null,{stopPropagation:true})}Ext.Ajax.request({url:Genapp.base_url+"map/get-tree-layers",success:function(j,k){this.layerTreeModel=Ext.decode(j.responseText);this.initLayerTree();a.ownerCt.items.get(1).items.get(0).add(this.layertree);a.ownerCt.items.get(1).items.get(0).doLayout();this.initToolbar();a.ownerCt.items.get(0).getTopToolbar().doLayout();this.fireEvent("afterinit",this)},scope:this})},scope:this})},scope:this}}),this.layersAndLegendsPanel];Genapp.MapPanel.superclass.initComponent.call(this)},initMap:function(d){var a=[];for(var f=this.minZoomLevel;f<Genapp.map.resolutions.length;f++){a.push(Genapp.map.resolutions[f])}this.map=new OpenLayers.Map(d,{controls:[],resolutions:a,projection:Genapp.map.projection,units:"m",tileSize:new OpenLayers.Size(Genapp.map.tilesize,Genapp.map.tilesize),maxExtent:new OpenLayers.Bounds(Genapp.map.x_min,Genapp.map.y_min,Genapp.map.x_max,Genapp.map.y_max),eventListeners:{changelayer:function(h){if(h.property=="visibility"){this.toggleLayersAndLegendsForZoom(h.layer)}},scope:this}});this.wktFormat=new OpenLayers.Format.WKT();this.vectorLayer=new OpenLayers.Layer.Vector("Vector Layer",{printable:false});var c=new OpenLayers.Layer("Empty baselayer",{isBaseLayer:true,printable:false});this.map.addLayer(c);for(var f=0;f<this.layersList.length;f++){this.map.addLayer(this.layersList[f])}this.map.addLayer(this.vectorLayer);this.map.addControl(new OpenLayers.Control.PanZoomBar({title:this.panZoomBarControlTitle}));this.map.addControl(new OpenLayers.Control.MousePosition({prefix:"X: ",separator:" - Y: ",suffix:" m (L2e)",numDigits:0,title:"MousePosition"}));this.map.addControl(new OpenLayers.Control.Scale());this.map.addControl(new OpenLayers.Control.ScaleLine({title:"ScaleLine",bottomOutUnits:"",bottomInUnits:""}));this.map.setCenter(new OpenLayers.LonLat(Genapp.map.x_center,Genapp.map.y_center),Genapp.map.defaultzoom);if(this.isDrawingMap){this.vectorLayer.preFeatureInsert=function(h){if(this.features.length>1){this.removeFeatures([this.features[0]])}};var b=new OpenLayers.Control.SelectFeature(this.vectorLayer,{multiple:false,clickout:true,toggle:true,title:this.selectFeatureControlTitle});this.map.addControl(b);b.activate();if(this.featureWKT){var e=this.wktFormat.read(this.featureWKT);if(e){this.vectorLayer.addFeatures([e])}else{alert(this.invalidWKTMsg)}}}else{var g=new OpenLayers.Control.SelectFeature(this.vectorLayer,{hover:true});this.map.addControl(g);g.activate()}},initLayerTree:function(){this.layertree=new mapfish.widgets.LayerTree({title:"",border:false,map:this.map,model:this.layerTreeModel,enableDD:true,listeners:{afterrender:function(){for(var a=0;a<this.map.layers.length;a++){this.toggleLayersAndLegendsForZoom(this.map.layers[a])}},scope:this},plugins:[{init:function(a){a.getRootNode().cascade(function(b){if(b.attributes.disabled==true){b.forceDisable=true}else{b.forceDisable=false}})}},mapfish.widgets.LayerTree.createContextualMenuPlugin(["opacitySlide"])],ascending:false});this.map.setLayerIndex(this.vectorLayer,100)},initToolbar:function(){this.toolbar.map=this.map;if(this.isDrawingMap){this.toolbar.addControl(new OpenLayers.Control.ZoomToFeatures(this.vectorLayer,{title:this.zoomToFeaturesControlTitle,maxZoomLevel:9,ratio:1.05,autoActivate:true}),{iconCls:"zoomstations"});this.toolbar.addControl(new OpenLayers.Control.DrawFeature(this.vectorLayer,OpenLayers.Handler.Polygon),{iconCls:"drawpolygon",tooltip:this.drawFeatureControlTitle});this.toolbar.addControl(new OpenLayers.Control.ModifyFeature(this.vectorLayer,{displayClass:"olControlModifyFeature",deleteCodes:[46,100],type:OpenLayers.Control.TYPE_TOOL,title:this.modifyFeatureControlTitle}),{iconCls:"modifyfeature",disabled:false});var b=new Ext.Toolbar.Button({iconCls:"deletefeature",tooltip:this.tbarDeleteFeatureButtonTooltip,disabled:false,handler:OpenLayers.Function.bind(function(){if(this.vectorLayer.features.length){var e=this.map.getControlsBy("title",this.selectFeatureControlTitle);if(this.vectorLayer.selectedFeatures.length){e[0].unselect(this.vectorLayer.selectedFeatures[0])}this.vectorLayer.removeFeatures(this.vectorLayer.features)}else{}},this)});this.toolbar.add(b)}this.toolbar.addFill();if(!this.hideMapDetails){this.toolbar.addControl(new OpenLayers.Control.FeatureInfoControl(),{iconCls:"feature-info",tooltip:this.featureInfoControlTitle})}var c=new OpenLayers.Control.NavigationHistory({});this.map.addControl(c);c.activate();var d=new Ext.Toolbar.Button({iconCls:"back",tooltip:this.tbarPreviousButtonTooltip,disabled:true,handler:c.previous.trigger});var a=new Ext.Toolbar.Button({iconCls:"next",tooltip:this.tbarNextButtonTooltip,disabled:true,handler:c.next.trigger});this.toolbar.add(d);this.toolbar.add(a);c.previous.events.register("activate",d,function(){this.setDisabled(false)});c.previous.events.register("deactivate",d,function(){this.setDisabled(true)});c.next.events.register("activate",a,function(){this.setDisabled(false)});c.next.events.register("deactivate",a,function(){this.setDisabled(true)});this.toolbar.addSeparator();this.toolbar.addControl(new OpenLayers.Control.ZoomBox({title:this.zoomBoxInControlTitle}),{iconCls:"zoomin"});this.toolbar.addControl(new OpenLayers.Control.ZoomBox({out:true,title:this.zoomBoxOutControlTitle}),{iconCls:"zoomout"});this.toolbar.addControl(new OpenLayers.Control.Navigation({isDefault:true,title:this.navigationControlTitle,mouseWheelOptions:{interval:100}}),{iconCls:"pan"});this.toolbar.addSeparator();this.toolbar.addButton({handler:this.zoomOnResultsBBox,scope:this,iconCls:"zoomstations",tooltip:this.zoomToFeaturesControlTitle});this.toolbar.addControl(new OpenLayers.Control.ZoomToMaxExtent({map:this.map,active:true,title:this.zoomToMaxExtentControlTitle}),{iconCls:"zoomfull"});this.toolbar.activate()},clean:function(){this.vectorLayer.destroyFeatures(this.vectorLayer.features)},zoomToFeature:function(c,b){var a=this.wktFormat.read(b);a.attributes.id=c.substring(c.lastIndexOf("__")+2);this.vectorLayer.destroyFeatures(this.vectorLayer.features);this.map.setLayerIndex(this.vectorLayer,100);if(a){this.vectorLayer.addFeatures([a])}else{alert(this.invalidWKTMsg)}this.map.setCenter(new OpenLayers.LonLat(a.geometry.x,a.geometry.y),7)},zoomOnBBox:function(g){if(!Ext.isEmpty(g)){var h=this.map;var d=1;var a=h.numZoomLevels-1;var c=this.wktFormat.read(g);var f=c.geometry.getBounds();f=f.scale(d);if((f.getWidth()===0)&&(f.getHeight()===0)){var e=a}else{var b=h.getZoomForExtent(f);var e=(b>a)?a:b}h.setCenter(f.getCenterLonLat(),e)}},zoomOnResultsBBox:function(){this.zoomOnBBox(this.resultsBBox)},toggleLayersAndLegends:function(d){var e=[];var b=[];var c=[];var a=[];for(layerName in d){if(d.hasOwnProperty(layerName)){switch(d[layerName]){case"checked":e.push(layerName);break;case"unchecked":b.push(layerName);break;case"disable":c.push(layerName);break;case"hide":a.push(layerName);break;default:break}}}this.enableLayersAndLegends(e,true,true);this.enableLayersAndLegends(b,false,true);this.disableLayersAndLegends(c,true,false,true);this.disableLayersAndLegends(a,true,true,true)},enableLayersAndLegends:function(g,b,f){var a=this.layerPanel.isVisible();this.layersAndLegendsPanel.activate(this.layerPanel);for(var c=0;c<g.length;c++){var e=this.layertree.layerToNodeIds[g[c]];if(!Ext.isEmpty(e)){if(f!=false){this.layertree.getNodeById(e).forceDisable=false}if(this.layertree.getNodeById(e).zoomDisable!=true){this.layertree.getNodeById(e).enable()}this.layertree.getNodeById(e).getUI().show();if(b==true){var d=this.map.getLayersByName(g[c]);d[0].redraw(true);this.layertree.setNodeChecked(e,true)}}}this.layersAndLegendsPanel.activate(this.legendPanel);this.setLegendsVisible(g,true);if(a){this.layersAndLegendsPanel.activate(this.layerPanel)}},disableLayersAndLegends:function(g,a,c,f){if(!Ext.isEmpty(g)){for(var b=0;b<g.length;b++){var e=this.layertree.layerToNodeIds[g[b]];if(!Ext.isEmpty(e)){if(a==true){this.layertree.setNodeChecked(e,false)}var d=this.layertree.getNodeById(e);if(c==true){d.getUI().hide()}d.disable();if(f!=false){d.forceDisable=true}}this.setLegendsVisible([g[b]],false)}}},toggleLayersAndLegendsForZoom:function(a){if(!Ext.isEmpty(this.layertree)){var c=this.layertree.layerToNodeIds[a.name];if(!Ext.isEmpty(c)){var b=this.layertree.getNodeById(c);if(!Ext.isEmpty(b)&&!b.hidden){if(!a.calculateInRange()){b.zoomDisable=true;this.disableLayersAndLegends([a.name],false,false,false)}else{b.zoomDisable=false;if(b.forceDisable!=true){this.enableLayersAndLegends([a.name],false,false)}}}}}},setLegendsVisible:function(d,c){for(i=0;i<d.length;i++){var a=this.legendPanel.findById(this.id+d[i]);if(!Ext.isEmpty(a)){if(c==true){var b=this.map.getLayersByName(d[i]);if(b[0].calculateInRange()&&b[0].getVisibility()){a.show()}else{a.hide()}}else{a.hide()}}}},beforeDestroy:function(){if(this.map){this.map.destroy()}Genapp.MapPanel.superclass.beforeDestroy.call(this)}});Genapp.NumberRangePicker=Ext.extend(Ext.Panel,{layout:"form",height:59,width:176,labelWidth:30,buttonAlign:"center",cls:"x-menu-number-range-item",minFieldLabel:"Min",maxFieldLabel:"Max",okButtonText:"ok",hideValidationButton:true,initComponent:function(){Ext.apply(this,{items:[this.minField=new Genapp.form.TwinNumberField({fieldLabel:this.minFieldLabel}),this.maxField=new Genapp.form.TwinNumberField({fieldLabel:this.maxFieldLabel})]});if(!this.hideValidationButton){this.buttons=[{xtype:"button",text:this.okButtonText,width:"auto",handler:this.onOkButtonPress.createDelegate(this)}];this.height=this.height+28}Genapp.NumberRangePicker.superclass.initComponent.call(this)},onOkButtonPress:function(a,b){if(b){this.fireEvent("select",this,{minValue:this.minField.getValue(),maxValue:this.maxField.getValue()})}}});Ext.reg("numberrangepicker",Genapp.NumberRangePicker);Genapp.PredefinedRequestPanel=Ext.extend(Ext.Panel,{itemId:"predefined_request",frame:true,title:"Predefined Request",layout:"border",consultationButtonText:"Consultation",consultationButtonTooltip:"Go to the consultation page",descriptionTitle:"",nameColumnHeader:"Name",labelColumnHeader:"Label",descriptionColumnHeader:"Description",dateColumnHeader:"Date",clickColumnHeader:"Click(s)",positionColumnHeader:"Rank",groupNameColumnHeader:"Group name",groupLabelColumnHeader:"Group label",groupPositionColumnHeader:"Group Rank",groupTextTpl:"{group} ({[values.rs.length]})",resetButtonText:"Reset",resetButtonTooltip:"Reset the form with the default values",launchRequestButtonText:"Launch the request",launchRequestButtonTooltip:"Launch the request in the consultation page",loadingText:"Loading...",defaultCardPanelText:"Please select a request...",defaultErrorCardPanelText:"Sorry, the loading failed...",criteriaPanelTitle:"Request criteria",initComponent:function(){var e=new Ext.data.ArrayReader({root:"rows",totalProperty:"total"},[{name:"request_name",type:"string"},{name:"label",type:"string"},{name:"definition",type:"string"},{name:"click",type:"int"},{name:"date",type:"date",dateFormat:"Y-m-d"},{name:"criteria_hint",type:"string"},{name:"position",type:"int"},{name:"group_name",type:"string"},{name:"group_label",type:"string"},{name:"group_position",type:"int"},{name:"dataset_id",type:"string"}]);var d=new Ext.data.GroupingStore({reader:e,autoDestroy:true,url:Genapp.ajax_query_url+"ajaxgetpredefinedrequestlist",remoteSort:false,sortInfo:{field:"position",direction:"ASC"},groupField:"group_position"});var c=[];if(!Ext.isEmpty(this.descriptionTitle)){c.push('<h4 class="genapp-predefined-request-grid-panel-description-title">'+this.descriptionTitle+":</h4>")}c.push('<p class="genapp-predefined-request-grid-panel-description-text">{definition}</p>');var f=new Ext.ux.grid.RowExpander({tpl:new Ext.Template(c)});var b=function(j,h,l,n,k,m,g){return l.data[g]};var a=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{id:"request_name",header:this.nameColumnHeader,dataIndex:"request_name",width:30,groupable:false,hidden:true},{header:this.labelColumnHeader,dataIndex:"label",groupable:false},{header:this.descriptionColumnHeader,dataIndex:"definition",groupable:false,hidden:true},{header:this.dateColumnHeader,dataIndex:"date",format:"Y/m/d",xtype:"datecolumn",width:20,groupable:false,hidden:true},{header:this.clickColumnHeader,dataIndex:"click",width:10,groupable:false,hidden:true},{header:this.positionColumnHeader,dataIndex:"position",width:10,groupable:false,hidden:true},{header:this.groupNameColumnHeader,dataIndex:"group_name",hidden:true,groupRenderer:b.createDelegate(this,["group_label"],true)},{header:this.groupLabelColumnHeader,dataIndex:"group_label",hidden:true},{header:this.groupPositionColumnHeader,dataIndex:"group_position",width:10,hidden:true,groupRenderer:b.createDelegate(this,["group_label"],true)}]});this.grid=new Ext.grid.GridPanel({region:"center",margins:{top:5,right:5,bottom:5,left:5},autoExpandColumn:1,border:true,plugins:f,ds:d,cm:a,view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:this.groupTextTpl}),sm:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{rowselect:this.onGridRowSelect,scope:this}})});this.requestCriteriaCardPanel=new Ext.form.FieldSet({cls:"genapp-predefined-request-criteria-card-panel",layout:"card",autoScroll:true,activeItem:2,labelWidth:90,title:" ",defaults:{width:140,border:false},width:350,border:true,fbar:this.requestCriteriaCardPanelFooterTBar=new Ext.Toolbar({hidden:true,cls:"genapp-predefined-request-criteria-panel-footerTBar",items:[this.resetButton=new Ext.Button({text:this.resetButtonText,listeners:{render:function(g){new Ext.ToolTip({anchor:"left",target:g.getEl(),html:this.resetButtonTooltip,showDelay:Ext.QuickTips.getQuickTip().showDelay,dismissDelay:Ext.QuickTips.getQuickTip().dismissDelay})},scope:this},handler:function(g,j){var h=this.grid.getSelectionModel().getSelected();this.requestCriteriaCardPanel.getComponent(h.data.request_name).getForm().reset()},scope:this}),this.launchRequestButton=new Ext.Button({text:this.launchRequestButtonText,listeners:{render:function(g){new Ext.ToolTip({anchor:"left",target:g.getEl(),html:this.launchRequestButtonTooltip,showDelay:Ext.QuickTips.getQuickTip().showDelay,dismissDelay:Ext.QuickTips.getQuickTip().dismissDelay})},scope:this},handler:function(g,k){var l=this.grid.getSelectionModel().getSelected().data;var j=this.requestCriteriaCardPanel.getComponent(l.request_name).getForm().getValues();var h=Ext.getCmp("consultation_panel");h.loadRequest({datasetId:l.dataset_id,name:l.request_name,fieldValues:j});Genapp.cardPanel.getLayout().setActiveItem("consultation_panel")},scope:this})]}),items:[{xtype:"box",autoEl:{tag:"div",cls:"loading-indicator",html:this.loadingText}},{xtype:"box",autoEl:{tag:"div",cls:"genapp-predefined-request-criteria-panel-error-msg",html:this.defaultErrorCardPanelText}},{xtype:"box",autoEl:{tag:"div",cls:"genapp-predefined-request-criteria-panel-intro",html:this.defaultCardPanelText}}]});this.eastPanel=new Ext.Panel({region:"east",width:"350px",cls:"genapp-predefined-request-east-panel",margins:{top:5,right:5,bottom:5,left:5},bbar:{items:[{xtype:"tbfill"},{xtype:"button",text:this.consultationButtonText,listeners:{render:function(g){new Ext.ToolTip({anchor:"left",target:g.getEl(),html:this.consultationButtonTooltip,showDelay:Ext.QuickTips.getQuickTip().showDelay,dismissDelay:Ext.QuickTips.getQuickTip().dismissDelay})},scope:this},scope:this,handler:function(g,h){Genapp.cardPanel.getLayout().setActiveItem("consultation_panel")}}]},items:this.requestCriteriaCardPanel});this.items=[this.grid,this.eastPanel];this.listeners={activate:function(){var g=this.grid.getSelectionModel().getSelected();this.grid.getStore().reload({callback:function(j,k,l){if(l){if(!Ext.isEmpty(g)){var h=this.grid.getStore().findExact("request_name",g.data.request_name);this.grid.getSelectionModel().selectRow(h);this.grid.plugins.expandRow(h)}}else{console.log("Request failure: ");console.log("records:",j,"options:",k);this.requestCriteriaCardPanel.getLayout().setActiveItem(1)}},scope:this})},scope:this};Genapp.PredefinedRequestPanel.superclass.initComponent.call(this)},onGridRowSelect:function(c,b,a){this.requestCriteriaCardPanel.setTitle("");this.requestCriteriaCardPanelFooterTBar.hide();this.requestCriteriaCardPanel.getLayout().setActiveItem(0);if(Ext.isEmpty(this.requestCriteriaCardPanel.getComponent(a.data.request_name))){Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetpredefinedrequestcriteria",success:function(f,h){var e=new Ext.data.ArrayReader({root:"criteria",fields:["name","format","data","default_value","fixed","inputType","type","label","definition","params"]});var d=e.readRecords(Ext.decode(f.responseText));var j=new Ext.form.FormPanel({itemId:a.data.request_name,labelWidth:130,autoHeight:true,defaults:{labelStyle:"padding: 0; margin-top:3px",width:180},items:{xtype:"box",autoEl:{tag:"div",cls:"genapp-predefined-request-criteria-panel-criteria-hint",style:"width:200px;",html:a.data.criteria_hint}}});for(var g=0;g<d.records.length;g++){j.add(Genapp.FieldForm.prototype.getCriteriaConfig(d.records[g].data,true))}this.requestCriteriaCardPanel.add(j);this.showCriteriaPanel(a.data.request_name);this.requestCriteriaCardPanel.doLayout()},failure:function(d,e){console.log("Request failure: "+d.statusText);console.log("Response:",d,"Options:",e);this.requestCriteriaCardPanel.getLayout().setActiveItem(1)},params:{request_name:a.data.request_name},scope:this})}else{this.showCriteriaPanel(a.data.request_name)}},showCriteriaPanel:function(a){this.requestCriteriaCardPanel.setTitle(this.criteriaPanelTitle);this.requestCriteriaCardPanelFooterTBar.show();this.requestCriteriaCardPanel.getLayout().setActiveItem(a)}});Ext.namespace("Genapp.form");Genapp.form.DateRangeField=Ext.extend(Ext.form.DateField,{minText:"The dates in this field must be equal to or after {0}",maxText:"The dates in this field must be equal to or before {0}",reverseText:"The end date must be posterior to the start date",notEqualText:"The end date can't be equal to the start date",dateSeparator:" - ",endDatePrefix:"<= ",startDatePrefix:">= ",usePrefix:true,hideValidationButton:false,authorizeEqualValues:true,mergeEqualValues:true,autoReverse:true,minValue:new Date(0),maxValue:new Date(2999,11,31),minDefaultValue:new Date(),maxDefaultValue:new Date(),setDisabledDates:function(a){this.disabledDates=a;this.initDisabledDays();if(this.menu){this.menu.rangePicker.startDatePicker.setDisabledDates(this.disabledDatesRE);this.menu.rangePicker.endDatePicker.setDisabledDates(this.disabledDatesRE)}},setDisabledDays:function(a){this.disabledDays=a;if(this.menu){this.menu.rangePicker.startDatePicker.setDisabledDays(a);this.menu.rangePicker.endDatePicker.setDisabledDays(a)}},setMinValue:function(a){this.minValue=(typeof a=="string"?this.parseDate(a):a);if(this.menu){this.menu.rangePicker.startDatePicker.setMinDate(this.minValue);this.menu.rangePicker.endDatePicker.setMinDate(this.minValue)}},setMaxValue:function(a){this.maxValue=(typeof a=="string"?this.parseDate(a):a);if(this.menu){this.menu.rangePicker.startDatePicker.setMaxDate(this.maxValue);this.menu.rangePicker.endDatePicker.setMaxDate(this.maxValue)}},getErrors:function(c){var e=Ext.form.DateField.superclass.getErrors.apply(this,arguments);c=this.formatDate(c||this.processValue(this.getRawValue()));if(c.length<1){return e}var a=c.split(this.dateSeparator);if(a.length!=1&&a.length!=2){e.push(String.format(this.invalidText,c,this.format+this.dateSeparator+this.format));return e}var d=this.parseRangeDate(c);if(a.length==1){if(!d){e.push(String.format(this.invalidText,c,this.format));return e}var b=Ext.form.DateField.superclass.getErrors.call(this,c);if(!Ext.isEmpty(b)){e.push(String.format(this.invalidText,c,this.format));return e}}else{if(a.length==2){if(!d){e.push(String.format(this.invalidText,c,this.format+this.dateSeparator+this.format));return e}var b=Ext.form.DateField.superclass.getErrors.call(this,c);if(!Ext.isEmpty(b)){e.push(String.format(this.invalidText,c,this.format+this.dateSeparator+this.format));return e}if(d.endDate.getTime()-d.startDate.getTime()<0){e.push(this.reverseText);return e}if(!this.authorizeEqualValues&&d.endDate.getElapsed(d.startDate)==0){e.push(this.notEqualText);return e}}}if(d.startDate!=null){if(d.startDate.getTime()-this.minValue.getTime()<0){e.push(String.format(this.minText,this.formatDate(this.minValue)));return e}if(this.maxValue.getTime()-d.startDate.getTime()<0){e.push(String.format(this.maxText,this.formatDate(this.maxValue)));return e}}if(d.endDate!=null){if(d.endDate.getTime()-this.minValue.getTime()<0){e.push(String.format(this.minText,this.formatDate(this.minValue)));return e}if(this.maxValue.getTime()-d.endDate.getTime()<0){e.push(String.format(this.maxText,this.formatDate(this.maxValue)));return e}}return e},parseRangeDate:function(j){if(!j){return null}if(this.isRangeDate(j)){return j}if(Ext.isDate(j)){return{startDate:j,endDate:j}}var k=j.split(this.dateSeparator);if(k.length==1){var c=j.indexOf(this.startDatePrefix,0);var h=j.indexOf(this.endDatePrefix,0);if(c!=-1){var a=this.parseDate.call(this,j.substring(c+this.startDatePrefix.length));if(a){return{startDate:a,endDate:null}}else{return null}}else{if(h!=-1){var e=this.parseDate.call(this,j.substring(h+this.endDatePrefix.length));if(e){return{startDate:null,endDate:e}}else{return null}}else{var b=this.parseDate.call(this,j);if(b){return{startDate:b,endDate:b}}else{return null}}}}else{if(k.length==2){var l=Date.parseDate(k[0],this.format);var g=Date.parseDate(k[1],this.format);if((!l||!g)&&this.altFormats){if(!this.altFormatsArray){this.altFormatsArray=this.altFormats.split("|")}var d,f;if(!l){for(d=0,f=this.altFormatsArray.length;d<f&&!l;d++){l=Date.parseDate(k[0],this.altFormatsArray[d])}}if(!g){for(d=0,f=this.altFormatsArray.length;d<f&&!g;d++){g=Date.parseDate(k[1],this.altFormatsArray[d])}}}if(!l||!g){return null}else{return{startDate:l,endDate:g}}}else{return null}}},formatDate:function(a){if(Ext.isDate(a)){return Genapp.form.DateRangeField.superclass.formatDate.call(this,a)}if(this.isRangeDate(a)){if(a.startDate==null&&a.endDate!=null){if(this.usePrefix){return this.endDatePrefix+a.endDate.format(this.format)}else{return this.minValue.format(this.format)+this.dateSeparator+a.endDate.format(this.format)}}else{if(a.startDate!=null&&a.endDate==null){if(this.usePrefix){return this.startDatePrefix+a.startDate.format(this.format)}else{return a.startDate.format(this.format)+this.dateSeparator+this.maxValue.format(this.format)}}else{if(a.startDate!=null&&a.endDate!=null){if(this.mergeEqualValues&&a.endDate.getElapsed(a.startDate)==0){return a.startDate.format(this.format)}else{if(this.autoReverse&&a.endDate.getTime()-a.startDate.getTime()<0){return a.endDate.format(this.format)+this.dateSeparator+a.startDate.format(this.format)}else{return a.startDate.format(this.format)+this.dateSeparator+a.endDate.format(this.format)}}}else{return""}}}}else{return a}},onTriggerClick:function(){if(this.disabled){return}if(!this.menu){this.menu=new Genapp.menu.DateRangeMenu({hideOnClick:false,hideValidationButton:this.hideValidationButton,showToday:this.showToday})}this.onFocus();if(typeof this.minDefaultValue==="string"){this.minDefaultValue=new Date(this.minDefaultValue)}if(typeof this.maxDefaultValue==="string"){this.maxDefaultValue=new Date(this.maxDefaultValue)}Ext.apply(this.menu.rangePicker.startDatePicker,{minDate:this.minValue,maxDate:this.maxValue,defaultValue:this.minDefaultValue,disabledDatesRE:this.disabledDatesRE,disabledDatesText:this.disabledDatesText,disabledDays:this.disabledDays,disabledDaysText:this.disabledDaysText,format:this.format,showToday:this.showToday,minText:String.format(this.minText,this.formatDate(this.minValue)),maxText:String.format(this.maxText,this.formatDate(this.maxValue))});Ext.apply(this.menu.rangePicker.endDatePicker,{minDate:this.minValue,maxDate:this.maxValue,defaultValue:this.maxDefaultValue,disabledDatesRE:this.disabledDatesRE,disabledDatesText:this.disabledDatesText,disabledDays:this.disabledDays,disabledDaysText:this.disabledDaysText,format:this.format,showToday:this.showToday,minText:String.format(this.minText,this.formatDate(this.minValue)),maxText:String.format(this.maxText,this.formatDate(this.maxValue))});var b=this.getValue();var c=this.minDefaultValue;var a=this.maxDefaultValue;if(Ext.isDate(b)){c=b;a=b}else{if(this.isRangeDate(b)){if(b.startDate!=null){c=b.startDate}if(b.endDate!=null){a=b.endDate}}}this.menu.rangePicker.startDatePicker.setValue(c);this.menu.rangePicker.endDatePicker.setValue(a);this.menu.show(this.el,"tl-bl?");this.menuEvents("on")},isRangeDate:function(a){return(Ext.isObject(a)&&(Ext.isDate(a.startDate)||a.startDate==null)&&(Ext.isDate(a.endDate)||a.endDate==null))},getValue:function(){return this.parseRangeDate(Ext.form.DateField.superclass.getValue.call(this))||""},setValue:function(a){return Ext.form.DateField.superclass.setValue.call(this,this.formatDate(this.parseRangeDate(a)))},beforeBlur:function(){var a=this.parseRangeDate(this.getRawValue());if(a){this.setValue(a)}}});Ext.reg("daterangefield",Genapp.form.DateRangeField);Ext.namespace("Genapp.form");Genapp.form.GeometryField=Ext.extend(Ext.form.TriggerField,{fieldLabel:"Location",mapWindowTitle:"Draw the search zone on the map :",mapWindowValidateButtonText:"Validate",mapWindowValidateAndSearchButtonText:"Validate and search",mapWindowCancelButtonText:"Cancel",triggerClass:"x-form-map-trigger",editable:false,hideMapDetails:true,mapWindowMaximizable:true,mapWindowMaximized:false,mapWindowHeight:500,mapWindowWidth:850,mapWindowMinZoomLevel:0,initComponent:function(){Genapp.form.GeometryField.superclass.initComponent.call(this);if(!this.hideTrigger){this.onTriggerClick=function(){if(this.disabled){return}if(!(this.mapWindow instanceof Ext.Window)){this.openMap(this)}else{this.mapWindow.show()}}}},openMap:function(){if(!this.mapWindow){this.mapWindow=new Ext.Window({layout:"fit",maximizable:this.mapWindowMaximizable,maximized:this.mapWindowMaximized,title:this.mapWindowTitle,width:this.mapWindowWidth,height:this.mapWindowHeight,closeAction:"destroy",draggable:false,resizable:false,modal:true,scope:true,items:this.mapPanel=new Genapp.MapPanel({title:"",isDrawingMap:true,featureWKT:this.getRawValue(),hideMapDetails:this.hideMapDetails,minZoomLevel:this.mapWindowMinZoomLevel,resultsBBox:Ext.getCmp("consultation_panel").mapPanel.resultsBBox}),buttons:[{text:this.mapWindowCancelButtonText,handler:function(){this.mapWindow.destroy()},scope:this},{text:this.mapWindowValidateButtonText,handler:this.onWindowValidate,scope:this},{text:this.mapWindowValidateAndSearchButtonText,handler:this.onWindowValidate.createDelegate(this,[true])}]});this.mapWindow.on("destroy",function(){delete this.mapWindow;if(this.submitRequest==true){Ext.getCmp("consultation_panel").submitRequest();this.submitRequest=false}},this);this.mapPanel.on("afterinit",function(b){var a=Ext.getCmp("consultation_panel");b.map.setCenter(a.mapPanel.map.getCenter());b.map.zoomTo(a.mapPanel.map.getZoom()-this.mapWindowMinZoomLevel);b.enableLayersAndLegends(this.mapPanel.layersActivation.request,true,true)},this)}this.mapWindow.show()},onWindowValidate:function(a){var b=this.mapPanel.vectorLayer.features.length?this.mapPanel.wktFormat.write(this.mapPanel.vectorLayer.features[0]):"";this.setValue(b);if(a==true){this.submitRequest=true}this.mapWindow.destroy();this.el.highlight()}});Ext.reg("geometryfield",Genapp.form.GeometryField);Ext.namespace("Genapp.form");Genapp.form.NumberRangeField=Ext.extend(Ext.form.TriggerField,{numberSeparator:" - ",minText:"The minimum value for this field is {0}",maxText:"The maximum value for this field is {0}",reverseText:"The max number must be superior to the min number",formatText:"The correct format is '{0}'",allowDecimals:true,decimalSeparator:".",decimalPrecision:2,allowNegative:true,minValue:-Number.MAX_VALUE,maxValue:Number.MAX_VALUE,nanText:"'{0}' is not a valid number",baseChars:"0123456789 ",hideValidationButton:false,setEmptyText:false,initEvents:function(){var a=this.baseChars+"";if(this.allowDecimals){a+=this.decimalSeparator}if(this.allowNegative){a+="-"}this.maskRe=new RegExp("["+Ext.escapeRe(a)+"]");Genapp.form.NumberRangeField.superclass.initEvents.call(this)},initComponent:function(){Genapp.form.NumberRangeField.superclass.initComponent.call(this);this.addEvents("select");if(this.setEmptyText){this.emptyText=this.minValue+this.numberSeparator+this.maxValue}var a=0;if(this.decimalPrecision>0){a=a+this.decimalSeparator;for(i=0;i<this.decimalPrecision;i++){a=a+"0"}}a=a+this.numberSeparator+a;this.formatText=String.format(this.formatText,a)},validateValue:function(e){if(!Genapp.form.NumberRangeField.superclass.validateValue.call(this,e)){return false}if(e.length<1){return true}var c=e.split(this.numberSeparator);if(c.length==1){var b=this.parseValue(c[0]);if(isNaN(b)){this.markInvalid(String.format(this.nanText,b));return false}else{return true}}else{if(c.length==2){var d=this.parseValue(c[0]);var a=this.parseValue(c[1]);if(a===""||d===""){this.markInvalid(this.formatText);return false}if(isNaN(d)){this.markInvalid(String.format(this.nanText,d));return false}if(isNaN(a)){this.markInvalid(String.format(this.nanText,a));return false}if(d<this.minValue){this.markInvalid(String.format(this.minText,this.minValue));return false}if(a>this.maxValue){this.markInvalid(String.format(this.maxText,this.maxValue));return false}if((a-d)<0){this.markInvalid(this.reverseText);return false}return true}else{this.markInvalid(this.formatText);return false}}},getValue:function(){var b=Genapp.form.NumberRangeField.superclass.getValue.call(this);var a=b.split(this.numberSeparator);if(a.length==1){return String(this.fixPrecision(this.parseValue(a[0]))).replace(".",this.decimalSeparator)}else{if(a.length==2){return String(this.fixPrecision(this.parseValue(a[0]))).replace(".",this.decimalSeparator)+this.numberSeparator+String(this.fixPrecision(this.parseValue(a[1]))).replace(".",this.decimalSeparator)}else{return""}}},setValue:function(c){var d=null;var a=null;if(Ext.isObject(c)){if(typeof c.minValue!=="undefined"&&typeof c.maxValue!=="undefined"){d=c.minValue;a=c.maxValue}else{return""}}else{if(typeof c==="string"){var b=c.split(this.numberSeparator);if(b.length==1){d=a=this.parseValue(b[0])}else{if(b.length==2){d=this.parseValue(b[0]);a=this.parseValue(b[1])}else{return""}}}else{return""}}min=typeof d=="number"?d:parseFloat(String(d).replace(this.decimalSeparator,"."));max=typeof a=="number"?a:parseFloat(String(a).replace(this.decimalSeparator,"."));mins=isNaN(min)?"":String(this.fixPrecision(min)).replace(".",this.decimalSeparator);maxs=isNaN(max)?"":String(this.fixPrecision(max)).replace(".",this.decimalSeparator);if(min==max){c=mins}else{if(min<max){c=mins+this.numberSeparator+maxs}else{c=maxs+this.numberSeparator+mins}}return Genapp.form.NumberRangeField.superclass.setValue.call(this,c)},parseValue:function(a){a=parseFloat(String(a).replace(this.decimalSeparator,"."));return isNaN(a)?"":a},fixPrecision:function(b){var a=isNaN(b);if(!this.allowDecimals||this.decimalPrecision==-1||a||!b){return a?"":b}return parseFloat(parseFloat(b).toFixed(this.decimalPrecision))},onTriggerClick:function(){if(this.disabled){return}if(!this.menu){this.menu=new Genapp.menu.NumberRangeMenu({hideOnClick:false,hideValidationButton:this.hideValidationButton})}this.onFocus();Ext.apply(this.menu.rangePicker.minField,{emptyText:this.setEmptyText?this.minValue:null,allowDecimals:this.allowDecimals,decimalSeparator:this.decimalSeparator,decimalPrecision:this.decimalPrecision,allowNegative:this.allowNegative,minValue:this.minValue,maxValue:this.maxValue,baseChars:this.baseChars});Ext.apply(this.menu.rangePicker.maxField,{emptyText:this.setEmptyText?this.maxValue:null,allowDecimals:this.allowDecimals,decimalSeparator:this.decimalSeparator,decimalPrecision:this.decimalPrecision,allowNegative:this.allowNegative,minValue:this.minValue,maxValue:this.maxValue,baseChars:this.baseChars});var b=this.getValue().split(this.numberSeparator);if(b.length==1){var c=this.parseValue(b[0]);var a=c}else{if(b.length==2){var c=this.parseValue(b[0]);var a=this.parseValue(b[1])}else{return}}this.menu.rangePicker.minField.setValue(c);this.menu.rangePicker.maxField.setValue(a);this.menu.show(this.el,"tl-bl?");this.menuEvents("on")},menuEvents:function(a){this.menu[a]("select",this.onSelect,this);this.menu[a]("hide",this.onMenuHide,this);this.menu[a]("show",this.onFocus,this)},onSelect:function(a,b){this.fireEvent("select",this,b);this.menu.hide()},onMenuHide:function(){this.focus(false,60);this.menuEvents("un");this.setValue({minValue:this.menu.rangePicker.minField.getValue(),maxValue:this.menu.rangePicker.maxField.getValue()})},validateBlur:function(){return !this.menu||!this.menu.isVisible()},onDestroy:function(){Ext.destroy(this.menu,this.wrap);Genapp.form.NumberRangeField.superclass.onDestroy.call(this)},beforeBlur:function(){var a=this.getRawValue();if(a){this.setValue(a)}}});Ext.reg("numberrangefield",Genapp.form.NumberRangeField);Ext.namespace("Genapp.form");Genapp.form.TwinNumberField=Ext.extend(Ext.form.TwinTriggerField,{fieldClass:"x-form-field x-form-num-field",allowDecimals:true,decimalSeparator:".",decimalPrecision:2,allowNegative:true,minValue:-Number.MAX_VALUE,maxValue:Number.MAX_VALUE,minText:"The minimum value for this field is {0}",maxText:"The maximum value for this field is {0}",nanText:"{0} is not a valid number",baseChars:"0123456789",trigger1Class:"x-form-clear-trigger",hideTrigger1:true,hideTrigger2:true,initComponent:function(){this.on("change",this.onChange,this);Genapp.form.TwinNumberField.superclass.initComponent.call(this)},onTrigger1Click:function(){this.reset();this.triggers[0].hide()},onChange:function(b){var a=this.getValue();if(a!==""&&a!=null){this.triggers[0].show()}else{this.triggers[0].hide()}},initEvents:function(){var a=this.baseChars+"";if(this.allowDecimals){a+=this.decimalSeparator}if(this.allowNegative){a+="-"}this.maskRe=new RegExp("["+Ext.escapeRe(a)+"]");Ext.form.NumberField.superclass.initEvents.call(this)},validateValue:function(b){if(!Ext.form.NumberField.superclass.validateValue.call(this,b)){return false}if(b.length<1){return true}b=String(b).replace(this.decimalSeparator,".");if(isNaN(b)){this.markInvalid(String.format(this.nanText,b));return false}var a=this.parseValue(b);if(a<this.minValue){this.markInvalid(String.format(this.minText,this.minValue));return false}if(a>this.maxValue){this.markInvalid(String.format(this.maxText,this.maxValue));return false}return true},getValue:function(){return this.fixPrecision(this.parseValue(Ext.form.NumberField.superclass.getValue.call(this)))},setValue:function(a){a=typeof a=="number"?a:parseFloat(String(a).replace(this.decimalSeparator,"."));a=isNaN(a)?"":String(a).replace(".",this.decimalSeparator);if(this.triggers){if(a!==""&&a!=null&&a!=this.minValue&&a!=this.maxValue){this.triggers[0].show()}else{this.triggers[0].hide()}}return Ext.form.NumberField.superclass.setValue.call(this,a)},parseValue:function(a){a=parseFloat(String(a).replace(this.decimalSeparator,"."));return isNaN(a)?"":a},fixPrecision:function(b){var a=isNaN(b);if(!this.allowDecimals||this.decimalPrecision==-1||a||!b){return a?"":b}return parseFloat(parseFloat(b).toFixed(this.decimalPrecision))},beforeBlur:function(){var a=this.parseValue(this.getRawValue());if(a!==""&&a!=null){this.setValue(this.fixPrecision(a))}}});Ext.reg("twinnumberfield",Genapp.form.TwinNumberField);Ext.namespace("Genapp.menu");Genapp.menu.DateRangeMenu=Ext.extend(Ext.menu.DateMenu,{layout:"table",cls:"x-date-range-menu",initComponent:function(){this.on("beforeshow",this.onBeforeShow,this);Ext.apply(this,{plain:true,showSeparator:false,items:[this.rangePicker=new Genapp.DateRangePicker(this.initialConfig)]});this.rangePicker.purgeListeners();Ext.menu.DateMenu.superclass.initComponent.call(this);this.relayEvents(this.rangePicker,["select"])},onBeforeShow:function(){if(this.rangePicker){this.rangePicker.startDatePicker.hideMonthPicker(true);this.rangePicker.endDatePicker.hideMonthPicker(true)}},showAt:function(c,b,a){this.parentMenu=b;if(!this.el){this.render()}if(a!==false){this.fireEvent("beforeshow",this);c=this.el.adjustForConstraints(c)}this.el.setXY(c);if(this.enableScrolling){this.constrainScroll(c[1])}this.el.show();Ext.menu.Menu.superclass.onShow.call(this);this.hidden=false;this.focus();this.fireEvent("show",this)}});Ext.reg("daterangemenu",Genapp.menu.DateRangeMenu);Ext.namespace("Genapp.menu");Genapp.menu.NumberRangeMenu=Ext.extend(Ext.menu.Menu,{layout:"auto",cls:"x-number-range-menu",initComponent:function(){Ext.apply(this,{plain:true,showSeparator:false,items:[this.rangePicker=new Genapp.NumberRangePicker(this.initialConfig)]});this.rangePicker.purgeListeners();Genapp.menu.NumberRangeMenu.superclass.initComponent.call(this);this.relayEvents(this.rangePicker,["select"])},showAt:function(c,b,a){this.parentMenu=b;if(!this.el){this.render()}if(a!==false){c=this.el.adjustForConstraints(c)}this.el.setXY(c);if(this.enableScrolling){this.constrainScroll(c[1])}this.el.show();Ext.menu.Menu.superclass.onShow.call(this);this.hidden=false;this.focus();this.fireEvent("show",this)}});Ext.reg("numberrangemenu",Genapp.menu.NumberRangeMenu);