Genapp.buildApplication=function(a){Ext.QuickTips.init();Ext.apply(Ext.QuickTips.getQuickTip(),{showDelay:250,dismissDelay:0,trackMouse:true});Ext.form.Field.prototype.msgTarget="side";Ext.layout.FormLayout.prototype.labelSeparator=" :";Ext.BLANK_IMAGE_URL=Genapp.base_url+"/img/s.gif";Ext.Ajax.timeout=480000;Genapp.consultationPanel=new Genapp.ConsultationPanel(a)};Genapp.util.htmlStringFormat=function(a){a=a.replace(new RegExp("'","g"),"&#39;");a=a.replace(new RegExp('"',"g"),"&#34;");return a};OpenLayers.Handler.FeatureInfo=OpenLayers.Class.create();OpenLayers.Handler.FeatureInfo.prototype=OpenLayers.Class.inherit(OpenLayers.Handler,{alertErrorTitle:"Error :",alertRequestFailedMsg:"Sorry, the feature info request failed...",click:function(a){var c=new OpenLayers.Pixel(a.xy.x,a.xy.y);var d=this.map.getLonLatFromPixel(c);var b=Genapp.base_url+"proxy/getInfo?SERVICE=WFS&VERSION=1.0.0&REQUEST=GetFeature&typename=result_locations&MAXFEATURES=1&BBOX="+(d.lon-500)+","+(d.lat+500)+","+(d.lon+500)+","+(d.lat-500);OpenLayers.loadURL(b,"",this,function(g){try{var f=Ext.decode(g.responseText);Genapp.consultationPanel.openDetails(f.id,"getmapdetails")}catch(h){Ext.Msg.alert(this.alertErrorTitle,this.alertRequestFailedMsg)}},function(e){Ext.Msg.alert(this.alertErrorTitle,this.alertRequestFailedMsg)});Event.stop(a)}});OpenLayers.Control.FeatureInfoControl=OpenLayers.Class.create();OpenLayers.Control.FeatureInfoControl.prototype=OpenLayers.Class.inherit(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,initialize:function(b,a){OpenLayers.Control.prototype.initialize.apply(this,[a])},draw:function(){this.handler=new OpenLayers.Handler.FeatureInfo(this,{click:this.click});this.activate()},CLASS_NAME:"OpenLayers.Control.FeatureInfoControl"});Genapp.ConsultationPanel=Ext.extend(Ext.Panel,{region:"center",layout:"border",cls:"genapp_consultation_panel",border:false,renderTo:"page",id:"consultation_panel",localeCls:"",hideCsvExportAlert:false,hideCsvExportButton:false,hideGridCsvExportMenuItem:false,hideAggregationCsvExportMenuItem:false,hideInterpolationButton:false,hideAggregationButton:false,hideDetails:false,hideMapDetails:true,hideUserManualLink:true,userManualLinkHref:Genapp.base_url+"pdf/User_Manual.pdf",userManualLinkText:"User Manual",hideDetailsVerticalLabel:false,showGridOnSubmit:false,datasetComboBoxEmptyText:"Please select a dataset...",datasetPanelTitle:"Dataset",formsPanelTitle:"Forms Panel",csvExportButtonText:"Csv Export",gridCsvExportMenuItemText:"Results",aggregationCsvExportMenuItemText:"Aggregation cells",interpolationButtonText:"Interpolation",aggregationButtonText:"Aggregation",gridViewEmptyText:"No result...",gridPanelTitle:"Results",gridPanelTabTip:"The request's results",centerPanelTitle:"Result Panel",queryPanelTitle:"Query Panel",queryPanelPinToolQtip:"Pin the panel",queryPanelUnpinToolQtip:"Unpin the panel",queryPanelCancelButtonText:"Cancel",queryPanelResetButtonText:"Reset",queryPanelSearchButtonText:"Search",queryPanelCancelButtonTooltip:"Cancel the request",queryPanelResetButtonTooltip:"Reset the request",queryPanelSearchButtonTooltip:"Launch the request",detailsPanelCtTitle:"Details",detailsPanelCtPinToolQtip:"Pin the panel",detailsPanelCtUnpinToolQtip:"Unpin the panel",mapMaskMsg:"Loading...",alertErrorTitle:"Error :",alertRequestFailedMsg:"Sorry, the request failed...",widthToSubstract:0,heightToSubstract:0,dateFormat:"Y/m/d",csvExportAlertTitle:"CSV exportation on IE",csvExportAlertMsg:"<div><H2>For your comfort on Internet Explorer you can:</H2>         <H3>Disable confirmation for file downloads.</H3>         <ul>         <li>In IE, expand the 'Tools' menu</li>         <li>Click on 'Internet Options'</li>         <li>Click on the 'Security' tab</li>         <li>Click on 'Custom Level'</li>         <li>Scroll down to the 'Downloads' part</li>         <li>Enable the confirmation for file download </li>         </ul>         <H3>Disable the file opening in the current window.</H3>         <ul>         <li>Open the workstation</li>         <li>Expand the 'Tools' menu</li>         <li>Click on 'Folder Options ...'</li>         <li>Click on the 'File Types' tab</li>         <li>Select the XLS extension</li>         <li>Click on the 'Advanced' button</li>         <li>Uncheck 'Browse in same window'</li>         </ul></div>",interpolationButtonMenuMaxDistanceTextDefaultValue:5000,autoZoomOnResultsFeatures:false,initComponent:function(){this.addEvents("resizewrapper");Ext.getBody().addClass(this.localeCls);this.height=Ext.getBody().getViewSize().height-this.heightToSubstract;this.width=Ext.getBody().getViewSize().width-this.widthToSubstract;Ext.EventManager.onWindowResize(function(a,c){var b={width:Ext.getBody().getViewSize().width-this.widthToSubstract,height:Ext.getBody().getViewSize().height-this.heightToSubstract};this.setSize(b);this.fireEvent("resizewrapper",b.width,b.height)},this);this.datasetDS=new Ext.data.JsonStore({url:Genapp.ajax_query_url+"ajaxgetdatasets",method:"POST",autoLoad:true,listeners:{load:{fn:function(b,a,c){for(i=0;i<a.length;i++){if(a[i].data.is_default==="1"){this.datasetComboBox.setValue(a[i].data.id);this.updateFormsPanel(a[i].data.id);break}}},scope:this}}});this.datasetComboBox=new Ext.form.ComboBox({name:"datasetId",hiddenName:"datasetId",hideLabel:true,store:this.datasetDS,editable:false,displayField:"label",valueField:"id",forceSelection:true,mode:"local",typeAhead:true,width:345,maxHeight:100,triggerAction:"all",emptyText:this.datasetComboBoxEmptyText,selectOnFocus:true,disableKeyFilter:true,listeners:{select:{fn:function(c,a,b){this.updateFormsPanel(a.data.id)},scope:this}}});this.datasetPanel=new Ext.Panel({region:"north",layout:"form",height:60,frame:true,margins:"5 0 5 0",title:this.datasetPanelTitle,items:this.datasetComboBox});this.formsPanel=new Ext.form.FieldSet({layout:"auto",region:"center",autoScroll:true,cls:"genapp_query_formspanel",frame:true,margins:"5 0 5 0",title:this.formsPanelTitle,keys:{key:Ext.EventObject.ENTER,fn:this.submitRequest,scope:this}});this.gridDSReader=new Ext.data.ArrayReader();this.gridDSReader.updateMetadata=function(a){delete this.ef;this.meta=a;this.recordType=Ext.data.Record.create(a.fields);this.onMetaChange(a,this.recordType,{metaData:a})};this.gridDS=new Ext.data.Store({autoDestroy:true,url:Genapp.ajax_query_url+"ajaxgetgridrows",remoteSort:true,reader:this.gridDSReader});this.pagingToolbar=new Ext.PagingToolbar({pageSize:Genapp.grid.pagesize,store:this.gridDS,displayInfo:true});this.pagingToolbar.reset=function(){if(!this.rendered){return}this.afterTextItem.setText(String.format(this.afterPageText,1));this.inputItem.setValue(1);this.first.setDisabled(true);this.prev.setDisabled(true);this.next.setDisabled(true);this.last.setDisabled(true);this.refresh.enable();if(this.displayItem){this.displayItem.setText(this.emptyMsg)}this.fireEvent("change",this,{total:0,activePage:1,pages:1})};this.gridView=new Ext.grid.GridView({autoFill:true,emptyText:this.gridViewEmptyText,deferEmptyText:true});this.gridView.reset=function(){this.mainBody.dom.innerHTML="&#160;"};this.gridPanel=new Ext.grid.GridPanel({frame:true,tabTip:this.gridPanelTabTip,collapsible:true,titleCollapse:true,title:this.gridPanelTitle,header:false,layout:"fit",autoScroll:true,loadMask:true,view:this.gridView,store:this.gridDS,trackMouseOver:false,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),cm:new Ext.grid.ColumnModel({}),bbar:this.pagingToolbar});this.mapPanel=new Genapp.MapPanel({hideMapDetails:this.hideMapDetails});this.centerPanel=new Ext.TabPanel({activeItem:0,frame:true,plain:true,region:"center",title:this.centerPanelTitle,items:[this.mapPanel,this.gridPanel]});this.centerPanel.on("render",function(c){var a=c.getEl().query(".x-tab-edge");if(!this.hideUserManualLink){Ext.DomHelper.insertBefore(a[0],{tag:"li",children:[{tag:"a",target:"_blank",href:this.userManualLinkHref,children:[{tag:"span",cls:"x-tab-strip-text genapp-query-center-panel-tab-strip-link",html:this.userManualLinkText}]}]})}function d(e){var f=Ext.DomHelper.insertBefore(a[0],{tag:"li",cls:"genapp-query-center-panel-tab-strip-top-button"},true);f.parent().setWidth("100%");f.on("mousedown",Ext.emptyFn,null,{stopPropagation:true});return new Ext.ComponentMgr.create(Ext.apply({renderTo:f.id},e))}this.mask=new Ext.LoadMask(this.getEl(),{msg:this.mapMaskMsg});this.centerPanel.doLayout();if(!this.hideInterpolationButton){this.interpolationButton=d({xtype:"splitbutton",text:this.interpolationButtonText,disabled:true,menu:this.interpolationButtonMenu=new Ext.menu.Menu({cls:"genapp-query-center-panel-interpolation-button-menu",defaults:{width:200},items:[this.interpolationButtonMenuDataCombo=new Ext.form.ComboBox({xtype:"combo",queryParam:"datasetId",store:new Ext.data.JsonStore({url:Genapp.base_url+"interpolation/ajaxgetvariables",method:"POST",listeners:{load:function(f,e,g){if(e.length==0){this.interpolationButtonMenuDataCombo.reset();delete this.interpolationButtonMenuDataCombo.lastQuery}},scope:this}}),editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a datum...",getListParent:function(){return this.el.up(".x-menu")},lastQuery:"",listeners:{beforequery:function(e){e.query=this.datasetComboBox.getValue();if(Ext.isEmpty(e.query)){e.cancel=true}},scope:this}}),this.interpolationButtonMenuGridsCombo=new Ext.form.ComboBox({xtype:"combo",store:new Ext.data.JsonStore({url:Genapp.base_url+"interpolation/ajaxgetgrids",method:"POST",autoLoad:true}),mode:"local",editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a grid...",getListParent:function(){return this.el.up(".x-menu")}}),this.interpolationButtonMenuMethodsCombo=new Ext.form.ComboBox({xtype:"combo",store:new Ext.data.JsonStore({url:Genapp.base_url+"interpolation/ajaxgetmethods",method:"POST",autoLoad:true}),mode:"local",editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a method...",getListParent:function(){return this.el.up(".x-menu")}}),this.interpolationButtonMenuMaxDistanceText=new Ext.form.TextField({xtype:"textfield",allowBlank:false,emptyText:"Select a max distance...",value:this.interpolationButtonMenuMaxDistanceTextDefaultValue,getListParent:function(){return this.el.up(".x-menu")}}),{xtype:"button",text:"Ok",handler:function(f,g){if(this.interpolationButtonMenuDataCombo.isValid(true)&&this.interpolationButtonMenuGridsCombo.isValid(true)&&this.interpolationButtonMenuMethodsCombo.isValid(true)&&this.interpolationButtonMenuMaxDistanceText.isValid(true)){this.showMask();Ext.Ajax.request({url:Genapp.base_url+"interpolation/ajax-validate-interpolation-variable-form",success:function(e,h){var e=Ext.decode(e.responseText);if(Ext.isEmpty(e.success)||e.success==false){this.hideMask();var j="An error occured during the interpolation process.";if(!Ext.isEmpty(e.errorMsg)){j+=" "+e.errorMsg}Ext.Msg.alert("Error...",j)}else{this.getStatus("interpolation",function(){this.mapPanel.enableLayersAndLegends([e.layerName],true,true)})}},failure:function(){this.hideMask();Ext.Msg.alert.createCallback("Error...","An error occured during the interpolation process.")},params:{INTERPOLATION_VARIABLE:this.interpolationButtonMenuDataCombo.getValue(),GRID_NAME:this.interpolationButtonMenuGridsCombo.getValue(),METHOD:this.interpolationButtonMenuMethodsCombo.getValue(),MAXDIST:this.interpolationButtonMenuMaxDistanceText.getValue()},scope:this});this.interpolationButtonMenu.hide()}},scope:this,style:"margin:auto;"}]})})}if(!this.hideAggregationButton){this.aggregationButton=d({xtype:"splitbutton",text:this.aggregationButtonText,disabled:true,menu:this.aggregationButtonMenu=new Ext.menu.Menu({cls:"genapp-query-center-panel-aggregation-button-menu",defaults:{width:200},items:[this.aggregationButtonMenuDataCombo=new Ext.form.ComboBox({xtype:"combo",queryParam:"datasetId",store:new Ext.data.JsonStore({url:Genapp.base_url+"aggregation/ajaxgetvariables",method:"POST",listeners:{load:function(f,e,g){if(e.length==0){this.aggregationButtonMenuDataCombo.reset();delete this.aggregationButtonMenuDataCombo.lastQuery}},scope:this}}),editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a datum...",getListParent:function(){return this.el.up(".x-menu")},lastQuery:"",listeners:{beforequery:function(e){e.query=this.datasetComboBox.getValue();if(Ext.isEmpty(e.query)){e.cancel=true}},scope:this}}),this.aggregationButtonMenuGridsCombo=new Ext.form.ComboBox({xtype:"combo",store:new Ext.data.JsonStore({url:Genapp.base_url+"aggregation/ajaxgetgrids",method:"POST",autoLoad:true}),mode:"local",editable:false,allowBlank:false,displayField:"label",valueField:"name",forceSelection:true,typeAhead:true,triggerAction:"all",emptyText:"Select a grid...",getListParent:function(){return this.el.up(".x-menu")}}),{xtype:"button",text:"Ok",handler:function(f,g){if(this.aggregationButtonMenuDataCombo.isValid(true)&&this.aggregationButtonMenuGridsCombo.isValid(true)){this.showMask();Ext.Ajax.request({url:Genapp.base_url+"aggregation/ajax-validate-aggregation-variable-form",success:function(e,h){var e=Ext.decode(e.responseText);if(Ext.isEmpty(e.success)||e.success==false){this.hideMask();var j="An error occured during the aggregation process.";if(!Ext.isEmpty(e.errorMsg)){j+=" "+e.errorMsg}Ext.Msg.alert("Error...",j)}else{this.getStatus("aggregation",function(){this.aggregationCsvExportMenuItem.enable();this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.aggregation,true,true,true);this.mapPanel.enableLayersAndLegends([e.layerName],true,true)})}},failure:function(){this.hideMask();Ext.Msg.alert.createCallback("Error...","An error occured during the aggregation process.")},params:{AGGREGATE_VARIABLE:this.aggregationButtonMenuDataCombo.getValue(),GRID_NAME:this.aggregationButtonMenuGridsCombo.getValue()},scope:this});this.aggregationButtonMenu.hide()}},scope:this,style:"margin:auto;"}]})})}var b=[];if(!this.hideGridCsvExportMenuItem){b.push(this.gridCsvExportMenuItem=new Ext.menu.Item({text:this.gridCsvExportMenuItemText,handler:this.exportCSV.createDelegate(this,["grid-csv-export"]),iconCls:"genapp-query-center-panel-grid-csv-export-menu-item-icon"}))}if(!this.hideAggregationCsvExportMenuItem){b.push(this.aggregationCsvExportMenuItem=new Ext.menu.Item({text:this.aggregationCsvExportMenuItemText,handler:this.exportCSV.createDelegate(this,["aggregation-csv-export"]),iconCls:"genapp-query-center-panel-aggregation-csv-export-menu-item-icon",disabled:true}))}if(!this.hideCsvExportButton){this.csvExportButton=d({xtype:"splitbutton",text:this.csvExportButtonText,disabled:true,menu:this.csvExportButtonMenu=new Ext.menu.Menu({items:b})})}},this,{single:true});this.queryPanelPinned=true;this.queryPanel=new Ext.FormPanel({region:"west",title:this.queryPanelTitle,collapsible:true,margins:"0 5 0 0",titleCollapse:true,width:370,frame:true,layout:"border",items:[this.datasetPanel,this.formsPanel],tools:[{id:"pin",qtip:this.queryPanelPinToolQtip,hidden:true,handler:function(c,b,a){b.hide();a.header.child(".x-tool-unpin").show();this.queryPanelPinned=true},scope:this},{id:"unpin",qtip:this.queryPanelUnpinToolQtip,handler:function(c,b,a){b.hide();a.header.child(".x-tool-pin").show();this.queryPanelPinned=false},scope:this}],bbar:[{xtype:"tbbutton",text:this.queryPanelCancelButtonText,tooltipType:"title",tooltip:this.queryPanelCancelButtonTooltip,cls:"genapp_query_formspanel_cancel_button",scope:this,handler:this.cancelRequest},{xtype:"tbseparator"},{xtype:"tbbutton",text:this.queryPanelResetButtonText,tooltipType:"title",tooltip:this.queryPanelResetButtonTooltip,cls:"genapp_query_formspanel_reset_button",scope:this,handler:this.resetRequest},{xtype:"tbfill"},{xtype:"tbbutton",text:this.queryPanelSearchButtonText,tooltipType:"title",tooltip:this.queryPanelSearchButtonTooltip,cls:"genapp_query_formspanel_search_button",scope:this,handler:this.submitRequest}]});if(!this.hideRequestVerticalLabel){this.addVerticalLabel(this.queryPanel,"genapp-query-request-panel-ct-xcollapsed-vertical-label-div")}this.detailsPanel=new Ext.TabPanel({frame:true,plain:true,enableTabScroll:true,cls:"genapp-query-details-panel",scrollIncrement:91,scrollRepeatInterval:100,idDelimiter:"___"});this.detailsPanelPinned=true;this.detailsPanelCt=new Ext.Panel({region:"east",title:this.detailsPanelCtTitle,frame:true,split:true,layout:"fit",width:344,minWidth:200,collapsible:true,titleCollapse:true,collapsed:true,items:this.detailsPanel,tools:[{id:"pin",qtip:this.detailsPanelCtPinToolQtip,hidden:true,handler:function(c,b,a){b.hide();a.header.child(".x-tool-unpin").show();this.detailsPanelPinned=true},scope:this},{id:"unpin",qtip:this.detailsPanelCtUnpinToolQtip,handler:function(c,b,a){b.hide();a.header.child(".x-tool-pin").show();this.detailsPanelPinned=false},scope:this}]});if(!this.hideDetailsVerticalLabel){this.addVerticalLabel(this.detailsPanelCt,"genapp-query-details-panel-ct-xcollapsed-vertical-label-div")}if(!this.items){this.items=[this.queryPanel,this.centerPanel];if(!this.hideDetails){this.items.push(this.detailsPanelCt)}}Genapp.ConsultationPanel.superclass.initComponent.call(this)},updateWestPanels:function(b,d,e){var a=Ext.decode(b.responseText);this.formsPanel.body.update();for(var c=0;c<a.data.length;c++){if(!(Ext.isEmpty(a.data[c].criteria)&&Ext.isEmpty(a.data[c].columns))){this.formsPanel.add(new Genapp.FieldForm({title:a.data[c].label,id:a.data[c].id,datasetId:e,criteria:a.data[c].criteria,columns:a.data[c].columns}))}}this.formsPanel.doLayout()},renderLeftTools:function(f,e,a,g,d,b){var c="";if(!this.hideDetails){c="<div class=\"genapp-query-grid-slip\" onclick=\"Genapp.consultationPanel.openDetails('{0}', 'getdetails');\"></div>"}c+="<div class=\"genapp-query-grid-map\" onclick=\"Genapp.consultationPanel.displayLocation('{0}','{1}');\"></div>";return String.format(c,a.data.id,a.data.location_centroid)},openDetails:function(d,a){if(!Ext.isEmpty(d)){var b=Ext.getCmp("consultation_panel");b.collapseQueryPanel();b.detailsPanel.ownerCt.expand();var c=b.detailsPanel.get(d);if(Ext.isEmpty(c)){c=b.detailsPanel.add(new Genapp.DetailsPanel({rowId:d,dataUrl:a}))}b.detailsPanel.activate(c)}},displayLocation:function(c,b){var a=Ext.getCmp("consultation_panel");a.centerPanel.activate(a.mapPanel);a.mapPanel.zoomToFeature(c,b)},cancelRequest:function(){if(this.requestConn&&this.requestConn!==null){this.requestConn.abort();this.gridPanel.loadMask.hide();this.mapMask.hide()}},resetRequest:function(){this.updateFormsPanel(this.datasetComboBox.getValue())},submitRequest:function(){if(!this.hideAggregationButton){this.aggregationButton.disable();this.aggregationButtonMenuDataCombo.reset();this.aggregationButtonMenuGridsCombo.reset();delete this.aggregationButtonMenuDataCombo.lastQuery}if(!this.hideAggregationCsvExportMenuItem){this.aggregationCsvExportMenuItem.disable()}if(!this.hideInterpolationButton){this.interpolationButton.disable();this.interpolationButtonMenuDataCombo.reset();this.interpolationButtonMenuGridsCombo.reset();this.interpolationButtonMenuMethodsCombo.reset();this.interpolationButtonMenuMaxDistanceText.setValue(this.interpolationButtonMenuMaxDistanceTextDefaultValue);delete this.interpolationButtonMenuDataCombo.lastQuery}if(!this.hideCsvExportButton){this.csvExportButton.disable()}this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.request,true,false,true);this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.aggregation,true,true,true);this.mapPanel.disableLayersAndLegends(this.mapPanel.layersActivation.interpolation,true,true,true);if(!this.mapResultLayers){var a=this.mapPanel.layersActivation.request;this.mapResultLayers=[];for(var c=0;c<a.length;c++){var b=this.mapPanel.map.getLayersByName(a[c])[0];b.events.register("loadend",this,function(e){this.mapResultLayersLoadEnd[e.object.name]=1;var d=0;for(b in this.mapResultLayersLoadEnd){if(typeof this.mapResultLayersLoadEnd[b]!=="function"){d+=this.mapResultLayersLoadEnd[b]}}if(d===this.mapResultLayers.length){this.mapMask.hide()}});this.mapResultLayers.push(b)}}this.mapResultLayersLoadEnd={};for(var c=0;c<this.mapResultLayers.length;c++){var b=this.mapResultLayers[c];this.mapResultLayersLoadEnd[b.name]=0}if(!this.mapMask){this.mapMask=new Ext.LoadMask(this.mapPanel.getEl(),{msg:this.mapMaskMsg})}if(this.showGridOnSubmit){this.centerPanel.activate(this.mapPanel);this.mapMask.show();this.centerPanel.activate(this.gridPanel);this.gridPanel.loadMask.show()}else{this.centerPanel.activate(this.gridPanel);this.gridPanel.loadMask.show();this.centerPanel.activate(this.mapPanel);this.mapMask.show()}for(var c=0;c<this.mapResultLayersLoadEnd.length;c++){var b=this.mapResultLayersLoadEnd[c];b.display(false)}this.mapPanel.clean();this.clearGrid();Ext.Ajax.on("beforerequest",function(e,d){this.requestConn=e},this,{single:true});this.formsPanel.findParentByType("form").getForm().submit({url:Genapp.ajax_query_url+"ajaxgetgridcolumns",timeout:480000,success:function(h,k){this.requestConn=null;var g=k.result.columns;var e=new Array({header:"",renderer:this.renderLeftTools.createDelegate(this),sortable:false,fixed:true,menuDisabled:true,align:"center",width:52});var j=new Array();var d;var l;for(var f=0;f<g.length;f++){d={header:Genapp.util.htmlStringFormat(g[f].label),sortable:true,dataIndex:g[f].name,width:100,tooltip:Genapp.util.htmlStringFormat(g[f].definition),hidden:g[f].hidden};l={name:g[f].name};switch(g[f].type){case"STRING":d.xtype="gridcolumn";l.type="string";break;case"INTEGER":d.xtype="gridcolumn";break;case"NUMERIC":case"RANGE":d.xtype="numbercolumn";break;case"DATE":d.xtype="datecolumn";d.format=this.dateFormat;break;default:d.xtype="gridcolumn";l.type="auto";break}e.push(d);j.push(l)}this.gridDSReader.updateMetadata({root:"rows",fields:j,totalProperty:"total"});if(this.centerPanel.getActiveTab() instanceof Genapp.MapPanel){this.centerPanel.activate(this.gridPanel);this.gridPanel.getColumnModel().setConfig(e);this.centerPanel.activate(this.mapPanel)}else{this.gridPanel.getColumnModel().setConfig(e)}this.gridPanel.getView().reset();Ext.Ajax.on("beforerequest",function(n,m){this.requestConn=n},this,{single:true});this.gridPanel.getStore().load({params:{start:0,limit:Genapp.grid.pagesize},callback:function(){this.requestConn=null;this.getResultsBBox();if(this.autoZoomOnResultsFeatures!=true){this.mapPanel.enableLayersAndLegends(this.mapPanel.layersActivation.request,true,true)}this.collapseQueryPanel();this.collapseDetailsPanel();if(!this.hideAggregationButton){this.aggregationButton.enable()}if(!this.hideInterpolationButton){this.interpolationButton.enable()}if(!this.hideCsvExportButton){this.csvExportButton.enable()}this.gridPanel.syncSize()},scope:this})},failure:function(d,e){if(e.result&&e.result.errorMessage){Ext.Msg.alert(this.alertErrorTitle,e.result.errorMessage)}else{Ext.Msg.alert(this.alertErrorTitle,this.alertRequestFailedMsg)}this.gridPanel.loadMask.hide();this.mapMask.hide()},scope:this})},collapseQueryPanel:function(){if(!this.queryPanelPinned){this.queryPanel.collapse()}},collapseDetailsPanel:function(){if(!this.detailsPanelPinned){this.detailsPanel.ownerCt.collapse()}},updateFormsPanel:function(a){this.formsPanel.removeAll(true);this.formsPanel.getUpdater().showLoading();Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetforms",success:this.updateWestPanels.createDelegate(this,[a],true),method:"POST",params:{datasetId:a},scope:this})},clearGrid:function(){var a=this.gridPanel.getStore();if(a.getCount()!=0){this.gridPanel.getBottomToolbar().reset()}if(this.gridPanel.rendered){this.gridPanel.getColumnModel().setConfig({});this.gridPanel.getView().updateAllColumnWidths();this.gridPanel.getView().reset()}},exportCSV:function(a){var b=function(d,e,c){this.showMask(true);window.location=Genapp.ajax_query_url+a};if(Ext.isIE&&!this.hideCsvExportAlert){Ext.Msg.show({title:this.csvExportAlertTitle,msg:this.csvExportAlertMsg,cls:"genapp-query-center-panel-csv-export-alert",buttons:Ext.Msg.OK,fn:b,animEl:this.csvExportButton.getEl(),icon:Ext.MessageBox.INFO,scope:this});this.hideCsvExportAlert=true}else{b.call(this)}},showMask:function(a){this.mask.show();if(a){window.onfocus=(function(){this.mask.hide();window.onfocus=Ext.emptyFn}).createDelegate(this)}},hideMask:function(){this.mask.hide()},addVerticalLabel:function(b,a){b.on("collapse",function(c){Ext.get(c.id+"-xcollapsed").createChild({tag:"div",cls:a})},this,{single:true})},getStatus:function(a,b){Ext.Ajax.request({url:Genapp.base_url+a+"/ajax-get-status",success:function(c,d){var c=Ext.decode(c.responseText);if(Ext.isEmpty(c.success)||c.success==false){this.hideMask();var e="An error occured during the status request.";if(!Ext.isEmpty(c.errorMsg)){e+=" "+c.errorMsg}Ext.Msg.alert("Error...",e)}else{if(c.status=="RUNNING"){this.getStatus.defer(2000,this,[a,b])}else{if(c.status=="OK"){this.hideMask();b.call(this)}else{this.hideMask();var e="An error occured during the status request.";if(!Ext.isEmpty(c.errorMsg)){e+=" "+c.errorMsg}Ext.Msg.alert("Error...",e)}}}},failure:function(){this.hideMask();var c="An error occured during the status request.";Ext.Msg.alert("Error...",c)},scope:this})},getResultsBBox:function(){Ext.Ajax.request({url:Genapp.ajax_query_url+"ajaxgetresultsbbox",success:function(a,b){try{var a=Ext.decode(a.responseText);if(Ext.isEmpty(a.success)||a.success==false){if(!Ext.isEmpty(a.errorMsg)){throw (a.errorMsg)}throw ("")}else{if(!Ext.isEmpty(a.resultsbbox)){this.mapPanel.resultsBBox=a.resultsbbox}else{this.mapPanel.resultsBBox=null}if(this.autoZoomOnResultsFeatures==true){if(this.mapPanel.resultsBBox!==null){this.mapPanel.zoomOnBBox(this.mapPanel.resultsBBox)}this.mapPanel.enableLayersAndLegends(this.mapPanel.layersActivation.request,true,true)}}}catch(c){var d="An error occured during the bounding box request.";if(!Ext.isEmpty(c)){d+=" "+c}Ext.Msg.alert("Error...",d)}},failure:function(a,b){var c="An error occured during the bounding box request. Status code : "+a.status;Ext.Msg.alert("Error...",c)},scope:this})}});Genapp.DateRangePicker=Ext.extend(Ext.Panel,{layout:"hbox",layoutConfig:{defaultMargins:{left:5,top:5,right:0,bottom:5}},height:203,width:369,cls:"x-menu-date-range-item",buttonAlign:"center",hideValidationButton:false,tbarStartDateButtonText:"Start Date ...",tbarRangeDateButtonText:"Range Date",tbarEndDateButtonText:"... End Date",fbarOkButtonText:"ok",selectedDate:{startDate:null,endDate:null},initComponent:function(){this.items=[this.startDatePicker=new Ext.DatePicker(Ext.apply({internalRender:this.strict||!Ext.isIE,ctCls:"x-menu-date-item"},this.initialConfig)),this.endDatePicker=new Ext.DatePicker(Ext.apply({internalRender:this.strict||!Ext.isIE,ctCls:"x-menu-date-item"},this.initialConfig))];this.startDatePicker.on("select",this.startDateSelect,this);this.endDatePicker.on("select",this.endDateSelect,this);this.tbar=new Ext.Toolbar({items:[this.startDateButton=new Ext.Button({text:this.tbarStartDateButtonText,cls:"x-menu-date-range-item-start-date-button",enableToggle:true,allowDepress:false,toggleGroup:"DateButtonsGroup",toggleHandler:this.onStartDatePress.createDelegate(this)}),this.rangeDateButton=new Ext.Button({text:this.tbarRangeDateButtonText,cls:"x-menu-date-range-item-range-date-button",pressed:true,enableToggle:true,allowDepress:false,toggleGroup:"DateButtonsGroup",toggleHandler:this.onRangeDatePress.createDelegate(this)}),"->",this.endDateButton=new Ext.Button({text:this.tbarEndDateButtonText,cls:"x-menu-date-range-item-end-date-button",enableToggle:true,allowDepress:false,toggleGroup:"DateButtonsGroup",toggleHandler:this.onEndDatePress.createDelegate(this)})]});if(!this.hideValidationButton){this.fbar=new Ext.Toolbar({cls:"x-date-bottom",items:[{xtype:"button",text:this.fbarOkButtonText,width:"auto",handler:this.onOkButtonPress.createDelegate(this)}]});this.height=this.height+28}if(this.showToday){this.height=this.height+31}Genapp.DateRangePicker.superclass.initComponent.call(this)},onRangeDatePress:function(a,b){if(b){this.startDatePicker.enable();this.endDatePicker.enable();this.resetDates()}},onStartDatePress:function(a,b){if(b){this.startDatePicker.enable();this.endDatePicker.disable();this.resetDates()}},onEndDatePress:function(a,b){if(b){this.startDatePicker.disable();this.endDatePicker.enable();this.resetDates()}},startDateSelect:function(b,a){this.selectedDate.startDate=a;if(this.startDateButton.pressed){this.returnSelectedDate()}else{if(this.selectedDate.endDate!==null){this.returnSelectedDate()}}},endDateSelect:function(b,a){this.selectedDate.endDate=a;if(this.endDateButton.pressed){this.returnSelectedDate()}else{if(this.selectedDate.startDate!==null){this.returnSelectedDate()}}},resetselectedDate:function(){this.selectedDate={startDate:null,endDate:null}},resetDates:function(){this.resetselectedDate();this.startDatePicker.setValue(this.startDatePicker.defaultValue);this.endDatePicker.setValue(this.endDatePicker.defaultValue)},returnSelectedDate:function(){this.fireEvent("select",this,this.selectedDate);this.resetselectedDate()},isEnabledDate:function(a){if((a.activeDate.getTime()-a.minDate.getTime()>=0)&&(a.maxDate.getTime()-a.activeDate.getTime()>=0)){return true}else{return false}},onOkButtonPress:function(a,b){if(b){if(this.startDateButton.pressed){if(this.isEnabledDate(this.startDatePicker)){this.selectedDate={startDate:this.startDatePicker.activeDate,endDate:null};this.returnSelectedDate()}}else{if(this.endDateButton.pressed){if(this.isEnabledDate(this.endDatePicker)){this.selectedDate={startDate:null,endDate:this.endDatePicker.activeDate};this.returnSelectedDate()}}else{if(this.isEnabledDate(this.startDatePicker)&&this.isEnabledDate(this.endDatePicker)){this.selectedDate={startDate:this.startDatePicker.activeDate,endDate:this.endDatePicker.activeDate};this.returnSelectedDate()}}}}}});Ext.reg("daterangepicker",Genapp.DateRangePicker);Genapp.DetailsPanel=Ext.extend(Ext.Panel,{headerWidth:60,closable:true,autoScroll:true,dataUrl:null,cls:"genapp-query-details-panel",tpl:new Ext.XTemplate('<tpl for="map">','<img title="{title}" src="{url}">',"</tpl>",'<tpl for="formats">','<tpl if="is_array != true">',"<fieldset>",'<legend align="top"> {title} </legend>','<tpl for="fields">',"<p><b>{label} :</b> {value}</p>","</tpl>","</fieldset>","</tpl>",'<tpl if="is_array == true">',"<table>","<caption>{title}</caption>","<tr>",'<tpl for="columns">',"<th>{label}</th>","</tpl>","</tr>",'<tpl for="rows">',"<tr>",'<tpl for=".">',"<td>{.}</td>","</tpl>","</tr>","</tpl>","</table>","</tpl>","</tpl>"),loadingMsg:"Loading...",initComponent:function(){this.title='<div style="width:'+this.headerWidth+'px;">'+this.loadingMsg+"</div>";this.on("render",this.updateDetails,this);this.itemId=this.rowId;Genapp.DetailsPanel.superclass.initComponent.call(this)},updateDetails:function(a){this.getUpdater().showLoading();Ext.Ajax.request({url:Genapp.ajax_query_url+this.dataUrl,success:function(b,c){var d=Ext.decode(b.responseText);this.setTitle('<div style="width:'+this.headerWidth+'px;">'+d.title+"</div>");this.tpl.overwrite(this.body,d)},method:"POST",params:{id:this.rowId},scope:this})}});Genapp.FieldForm=Ext.extend(Ext.Panel,{frame:true,cls:"genapp-query-field-form-panel",criteriaPanelTbarLabel:"Criteria",criteriaPanelTbarComboEmptyText:"Select...",criteriaPanelTbarComboLoadingText:"searching...",columnsPanelTbarLabel:"Columns",columnsPanelTbarComboEmptyText:"Select...",columnsPanelTbarComboLoadingText:"searching...",columnsPanelTbarAddAllButtonTooltip:"Add all the columns",columnsPanelTbarRemoveAllButtonTooltip:"Remove all the columns",dateFormat:"Y/m/d",initComponent:function(){this.criteriaDS=new Ext.data.JsonStore({fields:[{name:"name",mapping:"a"},{name:"label",mapping:"b"},{name:"inputType",mapping:"c"},{name:"type",mapping:"d"},{name:"definition",mapping:"e"},{name:"is_default",mapping:"f"},{name:"default_value",mapping:"g"},{name:"params",mapping:"p"}],data:this.criteria});this.columnsDS=new Ext.data.JsonStore({fields:[{name:"name",mapping:"a"},{name:"label",mapping:"b"},{name:"definition",mapping:"c"},{name:"is_default",mapping:"d"},{name:"params",mapping:"p"}],data:this.columns});this.criteriaPanel=new Ext.Panel({layout:"form",hidden:Ext.isEmpty(this.criteria)?true:false,hideMode:"offsets",labelWidth:120,cls:"genapp-query-criteria-panel",bodyStyle:"padding:0px 5px;",defaults:{labelStyle:"padding: 0; margin-top:3px",width:180},items:this.getDefaultCriteriaConfig(),tbar:[{xtype:"tbfill"},new Ext.Toolbar.TextItem(this.criteriaPanelTbarLabel),{xtype:"tbspacer"},{xtype:"combo",hiddenName:"Criteria",store:this.criteriaDS,editable:false,displayField:"label",valueField:"name",mode:"local",width:220,maxHeight:100,triggerAction:"all",emptyText:this.criteriaPanelTbarComboEmptyText,loadingText:this.criteriaPanelTbarComboLoadingText,listeners:{scope:this,select:{fn:this.addCriteria,scope:this}}},{xtype:"tbspacer"}]});this.columnsPanel=new Ext.Panel({layout:"form",hidden:Ext.isEmpty(this.columns)?true:false,hideMode:"offsets",items:this.getDefaultColumnsConfig(),tbar:[{xtype:"tbbutton",tooltip:this.columnsPanelTbarAddAllButtonTooltip,ctCls:"genapp-tb-btn",iconCls:"genapp-tb-btn-add",handler:this.addAllColumns,scope:this},{xtype:"tbbutton",tooltip:this.columnsPanelTbarRemoveAllButtonTooltip,ctCls:"genapp-tb-btn",iconCls:"genapp-tb-btn-remove",handler:this.removeAllColumns,scope:this},{xtype:"tbfill"},new Ext.Toolbar.TextItem(this.columnsPanelTbarLabel),{xtype:"tbspacer"},{xtype:"combo",fieldLabel:"Columns",hiddenName:"Columns",store:this.columnsDS,editable:false,displayField:"label",valueField:"name",mode:"local",width:220,maxHeight:100,triggerAction:"all",emptyText:this.columnsPanelTbarComboEmptyText,loadingText:this.columnsPanelTbarComboLoadingText,listeners:{scope:this,select:{fn:this.addColumn,scope:this}}},{xtype:"tbspacer"}]});if(!this.items){this.items=[this.criteriaPanel,this.columnsPanel]}this.collapsible=true;this.titleCollapse=true;Genapp.FieldForm.superclass.initComponent.call(this);this.doLayout()},addCriteria:function(c,a,b){if(c!==null){c.clearValue();c.collapse()}this.criteriaPanel.add(this.getCriteriaConfig(a.data));this.criteriaPanel.doLayout()},getCriteriaConfig:function(a){var e={};var d="criteria__"+a.name;var c=0;var b;do{e.name=e.hiddenName=d+"["+c+++"]";if(this.criteriaPanel){b=this.criteriaPanel.find("name",e.name).length}else{break}}while(b!==0);switch(a.inputType){case"SELECT":e.xtype="combo";e.hiddenName=e.name;e.triggerAction="all";e.typeAhead=true;e.mode="local";e.displayField="label";e.valueField="code";e.emptyText=this.criteriaPanelTbarComboEmptyText;e.disableKeyFilter=true;e.store=new Ext.data.ArrayStore({fields:["code","label"],data:a.params.options});break;case"DATE":e.xtype="daterangefield";e.format=this.dateFormat;break;case"NUMERIC":e.xtype="numberrangefield";if(a.type=="RANGE"){e.minValue=a.params.min;e.maxValue=a.params.max}if(a.type=="INTEGER"){e.allowDecimals=false;e.decimalPrecision=0}break;case"CHECKBOX":e.xtype="switch_checkbox";e.ctCls="improvedCheckbox";if(!Ext.isEmpty(a.default_value)){e.inputValue="1"}break;case"RADIO":case"TEXT":switch(a.type){case"INTEGER":e.xtype="numberfield";e.allowDecimals=false;break;case"NUMERIC":e.xtype="numberfield";break;default:e.xtype="textfield";break}break;case"GEOM":e.xtype="geometryfield";break;default:e.xtype="field";break}if(!Ext.isEmpty(a.default_value)){e.value=a.default_value}e.fieldLabel=a.label;e.listeners={render:function(h){var g=Ext.get("x-form-el-"+h.id).parent();var j=g.child(".x-form-item-label");j.set({"ext:qtitle":a.label,"ext:qwidth":200,"ext:qtip":a.definition});j.addClass("labelNextBin");var f=g.createChild({tag:"div",cls:"filterBin"},j);f.insertHtml("afterBegin","&nbsp;&nbsp;&nbsp;");f.on("click",function(m,l,k){this.criteriaPanel.remove(h)},this,{single:true})},scope:this};return e},getDefaultCriteriaConfig:function(){var a=[];this.criteriaDS.each(function(c){if(c.data.is_default){var b=c.data.default_value;if(!Ext.isEmpty(b)){var f=b.split(";");for(var e=0;e<f.length;e++){var d=c.copy();d.data.default_value=f[e];this.items.push(this.form.getCriteriaConfig(d.data))}}}},{form:this,items:a});return a},addColumn:function(c,a,b){if(c!==null){c.clearValue();c.collapse()}if(this.columnsPanel.find("name","column__"+a.data.name).length===0){this.columnsPanel.add(this.getColumnConfig(a.data));this.columnsPanel.doLayout()}},getColumnConfig:function(a){var b={xtype:"container",autoEl:"div",cls:"genapp-query-column-item",items:[{xtype:"box",autoEl:{tag:"div",cls:"columnLabelBin",html:"&nbsp;&nbsp;&nbsp;&nbsp;"},listeners:{render:function(c){c.getEl().on("click",function(f,e,d){this.columnsPanel.remove(c.ownerCt)},this,{single:true})},scope:this}},{xtype:"box",autoEl:{tag:"span",cls:"columnLabel","ext:qtitle":Genapp.util.htmlStringFormat(a.label),"ext:qwidth":200,"ext:qtip":Genapp.util.htmlStringFormat(a.definition),html:a.label}},{xtype:"hidden",name:"column__"+a.name,value:"1"}]};return b},getDefaultColumnsConfig:function(){var a=[];this.columnsDS.each(function(b){if(b.data.is_default){this.items.push(this.form.getColumnConfig(b.data))}},{form:this,items:a});return a},addAllColumns:function(){this.columnsDS.each(function(a){this.addColumn(null,a)},this)},removeAllColumns:function(){this.columnsPanel.removeAll()}});Genapp.MapPanel=Ext.extend(Ext.Panel,{frame:true,collapsible:true,titleCollapse:true,title:"Map",header:false,layout:"border",isDrawingMap:false,featureWKT:null,tabTip:"The map with the request's results's location",hideLayersAndLegendVerticalLabel:false,rightPanelCollapsed:false,rightPanelWidth:170,layerPanelTitle:"Layers",layerPanelTabTip:"The layers's tree",legendPanelTitle:"Legends",legendPanelTabTip:"The layers's legends",panZoomBarControlTitle:"Zoom",navigationControlTitle:"Drag the map",selectFeatureControlTitle:"Select Feature",invalidWKTMsg:"The feature cannot be displayed",zoomToFeaturesControlTitle:"Zoom to the features",drawFeatureControlTitle:"Draw a polygon",modifyFeatureControlTitle:"Update the feature",tbarDeleteFeatureButtonTooltip:"Delete the feature",tbarPreviousButtonTooltip:"Previous Position",tbarNextButtonTooltip:"Next Position",zoomBoxInControlTitle:"Zoom in",zoomBoxOutControlTitle:"Zoom out",zoomToMaxExtentControlTitle:"Zoom to max extend",featureInfoControlTitle:"Get the plot location information",hideLegalMentions:true,legalMentionsLinkHref:Genapp.base_url+"map/show-legal-mentions",legalMentionsLinkText:"Legal Mentions",minZoomLevel:0,resultsBBox:null,layersActivation:{},initComponent:function(){this.addEvents("afterinit");this.toolbar=new mapfish.widgets.toolbar.Toolbar({configurable:false});this.layersAndLegendsPanel=new Ext.TabPanel({region:"east",width:this.rightPanelWidth,collapsed:this.rightPanelCollapsed,collapsible:true,titleCollapse:false,cls:"genapp-query-map-right-panel",activeItem:0,split:true,items:[this.layerPanel=new Ext.Panel({layout:"fit",cls:"genapp-query-layer-tree-panel",title:this.layerPanelTitle,tabTip:this.layerPanelTabTip,frame:true,layoutConfig:{animate:true}}),this.legendPanel=new Ext.Panel({cls:"genapp-query-legend-panel",title:this.legendPanelTitle,tabTip:this.legendPanelTabTip,frame:true,layoutConfig:{animate:true}})]});if(!this.hideLayersAndLegendVerticalLabel){this.layersAndLegendsPanel.on("collapse",function(a){Ext.get(a.id+"-xcollapsed").createChild({tag:"div",cls:"genapp-query-map-right-panel-xcollapsed-vertical-label-div"})},this,{single:true})}this.items=[this.mapPanel=new Ext.Panel({region:"center",cls:"genapp_query_mappanel",frame:true,layout:"fit",tbar:this.toolbar,xtype:"panel",listeners:{render:function(a){a.body.setStyle("width","100%");a.body.setStyle("height","100%");Ext.Ajax.request({url:Genapp.base_url+"map/getLayers",success:function(c,e){var d=Ext.decode(c.responseText);this.layersList=[];this.layersActivation={};for(var f=0;f<d.layers.length;f++){var h;if(d.layers[f].untiled){h=new OpenLayers.Layer.WMS.Untiled(d.layers[f].name,d[d.layers[f].url],d.layers[f].params,d.layers[f].options)}else{h=new OpenLayers.Layer.WMS(d.layers[f].name,d[d.layers[f].url],d.layers[f].params,d.layers[f].options)}this.layersList.push(h);var b=d.layers[f].params.activateType.toLowerCase();if(Ext.isEmpty(this.layersActivation[b])){this.layersActivation[b]=[d.layers[f].name]}else{this.layersActivation[b].push(d.layers[f].name)}if(d.layers[f].hasLegend){var g=a.ownerCt.items.get(1).items.get(1).add(new Ext.BoxComponent({id:this.id+d.layers[f].name,autoEl:{tag:"div",children:[{tag:"span",html:d.layers[f].options.label,cls:"x-form-item x-form-item-label"},{tag:"img",src:Genapp.base_url+"proxy/getlegendimage?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetLegendGraphic&Format=image/png&WIDTH=160&LAYER="+d.layers[f].params.layers+"&HASSLD="+(d.layers[f].params.hasSLD?"true":"false")}]}}));if(d.layers[f].params.isDisabled||d.layers[f].params.isHidden||!d.layers[f].params.isChecked){g.on("render",function(j){j.hide()});g.on("show",(function(j,k){if(j.rendered){j.getEl().child("img").dom.src=Genapp.base_url+"proxy/getlegendimage?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetLegendGraphic&Format=image/png&WIDTH=160&LAYER="+k.layers+"&HASSLD="+(k.hasSLD?"true":"false")+"&dc="+(new Date()).getTime()}}).createCallback(g,d.layers[f].params))}}}a.ownerCt.items.get(1).items.get(1).doLayout();this.initMap(a.body.id);a.on("bodyresize",this.map.updateSize,this.map);if(!this.hideLegalMentions){a.el.createChild({tag:"div",cls:"genapp-map-panel-legal-mentions",children:[{tag:"a",target:"_blank",href:this.legalMentionsLinkHref,html:this.legalMentionsLinkText}]},a.el.child(".olMapViewport",true)).on("click",Ext.emptyFn,null,{stopPropagation:true})}Ext.Ajax.request({url:Genapp.base_url+"map/get-tree-layers",success:function(j,k){this.layerTreeModel=Ext.decode(j.responseText);this.initLayerTree();a.ownerCt.items.get(1).items.get(0).add(this.layertree);a.ownerCt.items.get(1).items.get(0).doLayout();this.initToolbar();a.ownerCt.items.get(0).getTopToolbar().doLayout();this.fireEvent("afterinit",this)},scope:this})},scope:this})},scope:this}}),this.layersAndLegendsPanel];Genapp.MapPanel.superclass.initComponent.call(this)},initMap:function(d){var a=[];for(var f=this.minZoomLevel;f<Genapp.map.resolutions.length;f++){a.push(Genapp.map.resolutions[f])}this.map=new OpenLayers.Map(d,{controls:[],resolutions:a,projection:Genapp.map.projection,units:"m",tileSize:new OpenLayers.Size(Genapp.map.tilesize,Genapp.map.tilesize),maxExtent:new OpenLayers.Bounds(Genapp.map.x_min,Genapp.map.y_min,Genapp.map.x_max,Genapp.map.y_max),eventListeners:{changelayer:function(h){if(h.property=="visibility"){this.toggleLayersAndLegendsForZoom(h.layer)}},scope:this}});this.wktFormat=new OpenLayers.Format.WKT();this.vectorLayer=new OpenLayers.Layer.Vector("Vector Layer");var c=new OpenLayers.Layer("Empty baselayer",{isBaseLayer:true});this.map.addLayer(c);for(var f=0;f<this.layersList.length;f++){this.map.addLayer(this.layersList[f])}this.map.addLayer(this.vectorLayer);this.map.addControl(new OpenLayers.Control.PanZoomBar({title:this.panZoomBarControlTitle}));this.map.addControl(new OpenLayers.Control.MousePosition({prefix:"X: ",separator:" - Y: ",suffix:" m (L2e)",numDigits:0,title:"MousePosition"}));this.map.addControl(new OpenLayers.Control.Scale());this.map.addControl(new OpenLayers.Control.ScaleLine({title:"ScaleLine",bottomOutUnits:"",bottomInUnits:""}));this.map.setCenter(new OpenLayers.LonLat(Genapp.map.x_center,Genapp.map.y_center),Genapp.map.defaultzoom);if(this.isDrawingMap){this.vectorLayer.preFeatureInsert=function(h){if(this.features.length>1){this.removeFeatures([this.features[0]])}};var b=new OpenLayers.Control.SelectFeature(this.vectorLayer,{multiple:false,clickout:true,toggle:true,title:this.selectFeatureControlTitle});this.map.addControl(b);b.activate();if(this.featureWKT){var e=this.wktFormat.read(this.featureWKT);if(e){this.vectorLayer.addFeatures([e])}else{alert(this.invalidWKTMsg)}}}else{var g=new OpenLayers.Control.SelectFeature(this.vectorLayer,{hover:true});this.map.addControl(g);g.activate()}},initLayerTree:function(){this.layertree=new mapfish.widgets.LayerTree({title:"",border:false,map:this.map,model:this.layerTreeModel,enableDD:true,listeners:{afterrender:function(){for(var a=0;a<this.map.layers.length;a++){this.toggleLayersAndLegendsForZoom(this.map.layers[a])}},scope:this},plugins:[{init:function(a){a.getRootNode().cascade(function(b){if(b.attributes.disabled==true){b.forceDisable=true}else{b.forceDisable=false}})}},mapfish.widgets.LayerTree.createContextualMenuPlugin(["opacitySlide"])],ascending:false});this.map.setLayerIndex(this.vectorLayer,100)},initToolbar:function(){this.toolbar.map=this.map;if(this.isDrawingMap){this.toolbar.addControl(new OpenLayers.Control.ZoomToFeatures(this.vectorLayer,{title:this.zoomToFeaturesControlTitle,maxZoomLevel:9,ratio:1.05,autoActivate:true}),{iconCls:"zoomstations"});this.toolbar.addControl(new OpenLayers.Control.DrawFeature(this.vectorLayer,OpenLayers.Handler.Polygon),{iconCls:"drawpolygon",tooltip:this.drawFeatureControlTitle});this.toolbar.addControl(new OpenLayers.Control.ModifyFeature(this.vectorLayer,{displayClass:"olControlModifyFeature",deleteCodes:[46,100],type:OpenLayers.Control.TYPE_TOOL,title:this.modifyFeatureControlTitle}),{iconCls:"modifyfeature",disabled:false});var b=new Ext.Toolbar.Button({iconCls:"deletefeature",tooltip:this.tbarDeleteFeatureButtonTooltip,disabled:false,handler:OpenLayers.Function.bind(function(){if(this.vectorLayer.features.length){var e=this.map.getControlsBy("title",this.selectFeatureControlTitle);if(this.vectorLayer.selectedFeatures.length){e[0].unselect(this.vectorLayer.selectedFeatures[0])}this.vectorLayer.removeFeatures(this.vectorLayer.features)}else{}},this)});this.toolbar.add(b)}this.toolbar.addFill();if(!this.hideMapDetails){this.toolbar.addControl(new OpenLayers.Control.FeatureInfoControl(),{iconCls:"feature-info",tooltip:this.featureInfoControlTitle})}var c=new OpenLayers.Control.NavigationHistory({});this.map.addControl(c);c.activate();var d=new Ext.Toolbar.Button({iconCls:"back",tooltip:this.tbarPreviousButtonTooltip,disabled:true,handler:c.previous.trigger});var a=new Ext.Toolbar.Button({iconCls:"next",tooltip:this.tbarNextButtonTooltip,disabled:true,handler:c.next.trigger});this.toolbar.add(d);this.toolbar.add(a);c.previous.events.register("activate",d,function(){this.setDisabled(false)});c.previous.events.register("deactivate",d,function(){this.setDisabled(true)});c.next.events.register("activate",a,function(){this.setDisabled(false)});c.next.events.register("deactivate",a,function(){this.setDisabled(true)});this.toolbar.addSeparator();this.toolbar.addControl(new OpenLayers.Control.ZoomBox({title:this.zoomBoxInControlTitle}),{iconCls:"zoomin"});this.toolbar.addControl(new OpenLayers.Control.ZoomBox({out:true,title:this.zoomBoxOutControlTitle}),{iconCls:"zoomout"});this.toolbar.addControl(new OpenLayers.Control.Navigation({isDefault:true,title:this.navigationControlTitle,mouseWheelOptions:{interval:100}}),{iconCls:"pan"});this.toolbar.addSeparator();this.toolbar.addButton({handler:this.zoomOnResultsBBox,scope:this,iconCls:"zoomstations",tooltip:this.zoomToFeaturesControlTitle});this.toolbar.addControl(new OpenLayers.Control.ZoomToMaxExtent({map:this.map,active:true,title:this.zoomToMaxExtentControlTitle}),{iconCls:"zoomfull"});this.toolbar.activate()},clean:function(){this.vectorLayer.destroyFeatures(this.vectorLayer.features)},zoomToFeature:function(c,b){var a=this.wktFormat.read(b);a.attributes.id=c.substring(c.lastIndexOf("__")+2);this.vectorLayer.destroyFeatures(this.vectorLayer.features);this.map.setLayerIndex(this.vectorLayer,100);if(a){this.vectorLayer.addFeatures([a])}else{alert(this.invalidWKTMsg)}this.map.setCenter(new OpenLayers.LonLat(a.geometry.x,a.geometry.y),7)},zoomOnBBox:function(g){if(!Ext.isEmpty(g)){var h=this.map;var d=1;var a=h.numZoomLevels-1;var c=this.wktFormat.read(g);var f=c.geometry.getBounds();f=f.scale(d);if((f.getWidth()===0)&&(f.getHeight()===0)){var e=a}else{var b=h.getZoomForExtent(f);var e=(b>a)?a:b}h.setCenter(f.getCenterLonLat(),e)}},zoomOnResultsBBox:function(){this.zoomOnBBox(this.resultsBBox)},toggleLayersAndLegends:function(d){var e=[];var b=[];var c=[];var a=[];for(layerName in d){if(d.hasOwnProperty(layerName)){switch(d[layerName]){case"checked":e.push(layerName);break;case"unchecked":b.push(layerName);break;case"disable":c.push(layerName);break;case"hide":a.push(layerName);break;default:break}}}this.enableLayersAndLegends(e,true,true);this.enableLayersAndLegends(b,false,true);this.disableLayersAndLegends(c,true,false,true);this.disableLayersAndLegends(a,true,true,true)},enableLayersAndLegends:function(g,b,f){var a=this.layerPanel.isVisible();this.layersAndLegendsPanel.activate(this.layerPanel);for(var c=0;c<g.length;c++){var e=this.layertree.layerToNodeIds[g[c]];if(!Ext.isEmpty(e)){if(f!=false){this.layertree.getNodeById(e).forceDisable=false}if(this.layertree.getNodeById(e).zoomDisable!=true){this.layertree.getNodeById(e).enable()}this.layertree.getNodeById(e).getUI().show();if(b==true){var d=this.map.getLayersByName(g[c]);d[0].redraw(true);this.layertree.setNodeChecked(e,true)}}}this.layersAndLegendsPanel.activate(this.legendPanel);this.setLegendsVisible(g,true);if(a){this.layersAndLegendsPanel.activate(this.layerPanel)}},disableLayersAndLegends:function(g,a,c,f){if(!Ext.isEmpty(g)){for(var b=0;b<g.length;b++){var e=this.layertree.layerToNodeIds[g[b]];if(!Ext.isEmpty(e)){if(a==true){this.layertree.setNodeChecked(e,false)}var d=this.layertree.getNodeById(e);if(c==true){d.getUI().hide()}d.disable();if(f!=false){d.forceDisable=true}}this.setLegendsVisible([g[b]],false)}}},toggleLayersAndLegendsForZoom:function(a){if(!Ext.isEmpty(this.layertree)){var c=this.layertree.layerToNodeIds[a.name];if(!Ext.isEmpty(c)){var b=this.layertree.getNodeById(c);if(!Ext.isEmpty(b)&&!b.hidden){if(!a.calculateInRange()){b.zoomDisable=true;this.disableLayersAndLegends([a.name],false,false,false)}else{b.zoomDisable=false;if(b.forceDisable!=true){this.enableLayersAndLegends([a.name],false,false)}}}}}},setLegendsVisible:function(d,c){for(i=0;i<d.length;i++){var a=this.legendPanel.findById(this.id+d[i]);if(!Ext.isEmpty(a)){if(c==true){var b=this.map.getLayersByName(d[i]);if(b[0].calculateInRange()&&b[0].getVisibility()){a.show()}else{a.hide()}}else{a.hide()}}}},beforeDestroy:function(){if(this.map){this.map.destroy()}Genapp.MapPanel.superclass.beforeDestroy.call(this)}});Genapp.NumberRangePicker=Ext.extend(Ext.Panel,{layout:"form",height:59,width:176,labelWidth:30,buttonAlign:"center",cls:"x-menu-number-range-item",minFieldLabel:"Min",maxFieldLabel:"Max",okButtonText:"ok",hideValidationButton:true,initComponent:function(){Ext.apply(this,{items:[this.minField=new Genapp.form.TwinNumberField({fieldLabel:this.minFieldLabel}),this.maxField=new Genapp.form.TwinNumberField({fieldLabel:this.maxFieldLabel})]});if(!this.hideValidationButton){this.buttons=[{xtype:"button",text:this.okButtonText,width:"auto",handler:this.onOkButtonPress.createDelegate(this)}];this.height=this.height+28}Genapp.NumberRangePicker.superclass.initComponent.call(this)},onOkButtonPress:function(a,b){if(b){this.fireEvent("select",this,{minValue:this.minField.getValue(),maxValue:this.maxField.getValue()})}}});Ext.reg("numberrangepicker",Genapp.NumberRangePicker);Ext.namespace("Genapp.form");Genapp.form.DateRangeField=Ext.extend(Ext.form.DateField,{minText:"The dates in this field must be equal to or after {0}",maxText:"The dates in this field must be equal to or before {0}",reverseText:"The end date must be posterior to the start date",notEqualText:"The end date can't be equal to the start date",dateSeparator:" - ",endDatePrefix:"<= ",startDatePrefix:">= ",usePrefix:true,hideValidationButton:false,authorizeEqualValues:true,mergeEqualValues:true,autoReverse:true,minValue:new Date(0),maxValue:new Date(2999,11,31),minDefaultValue:new Date(),maxDefaultValue:new Date(),setDisabledDates:function(a){this.disabledDates=a;this.initDisabledDays();if(this.menu){this.menu.rangePicker.startDatePicker.setDisabledDates(this.disabledDatesRE);this.menu.rangePicker.endDatePicker.setDisabledDates(this.disabledDatesRE)}},setDisabledDays:function(a){this.disabledDays=a;if(this.menu){this.menu.rangePicker.startDatePicker.setDisabledDays(a);this.menu.rangePicker.endDatePicker.setDisabledDays(a)}},setMinValue:function(a){this.minValue=(typeof a=="string"?this.parseDate(a):a);if(this.menu){this.menu.rangePicker.startDatePicker.setMinDate(this.minValue);this.menu.rangePicker.endDatePicker.setMinDate(this.minValue)}},setMaxValue:function(a){this.maxValue=(typeof a=="string"?this.parseDate(a):a);if(this.menu){this.menu.rangePicker.startDatePicker.setMaxDate(this.maxValue);this.menu.rangePicker.endDatePicker.setMaxDate(this.maxValue)}},getErrors:function(c){var e=Ext.form.DateField.superclass.getErrors.apply(this,arguments);c=this.formatDate(c||this.processValue(this.getRawValue()));if(c.length<1){return e}var a=c.split(this.dateSeparator);if(a.length!=1&&a.length!=2){e.push(String.format(this.invalidText,c,this.format+this.dateSeparator+this.format));return e}var d=this.parseRangeDate(c);if(a.length==1){if(!d){e.push(String.format(this.invalidText,c,this.format));return e}var b=Ext.form.DateField.superclass.getErrors.call(this,c);if(!Ext.isEmpty(b)){e.push(String.format(this.invalidText,c,this.format));return e}}else{if(a.length==2){if(!d){e.push(String.format(this.invalidText,c,this.format+this.dateSeparator+this.format));return e}var b=Ext.form.DateField.superclass.getErrors.call(this,c);if(!Ext.isEmpty(b)){e.push(String.format(this.invalidText,c,this.format+this.dateSeparator+this.format));return e}if(d.endDate.getTime()-d.startDate.getTime()<0){e.push(this.reverseText);return e}if(!this.authorizeEqualValues&&d.endDate.getElapsed(d.startDate)==0){e.push(this.notEqualText);return e}}}if(d.startDate!=null){if(d.startDate.getTime()-this.minValue.getTime()<0){e.push(String.format(this.minText,this.formatDate(this.minValue)));return e}if(this.maxValue.getTime()-d.startDate.getTime()<0){e.push(String.format(this.maxText,this.formatDate(this.maxValue)));return e}}if(d.endDate!=null){if(d.endDate.getTime()-this.minValue.getTime()<0){e.push(String.format(this.minText,this.formatDate(this.minValue)));return e}if(this.maxValue.getTime()-d.endDate.getTime()<0){e.push(String.format(this.maxText,this.formatDate(this.maxValue)));return e}}return e},parseRangeDate:function(j){if(!j){return null}if(this.isRangeDate(j)){return j}if(Ext.isDate(j)){return{startDate:j,endDate:j}}var k=j.split(this.dateSeparator);if(k.length==1){var c=j.indexOf(this.startDatePrefix,0);var h=j.indexOf(this.endDatePrefix,0);if(c!=-1){var a=this.parseDate.call(this,j.substring(c+this.startDatePrefix.length));if(a){return{startDate:a,endDate:null}}else{return null}}else{if(h!=-1){var e=this.parseDate.call(this,j.substring(h+this.endDatePrefix.length));if(e){return{startDate:null,endDate:e}}else{return null}}else{var b=this.parseDate.call(this,j);if(b){return{startDate:b,endDate:b}}else{return null}}}}else{if(k.length==2){var l=Date.parseDate(k[0],this.format);var g=Date.parseDate(k[1],this.format);if((!l||!g)&&this.altFormats){if(!this.altFormatsArray){this.altFormatsArray=this.altFormats.split("|")}var d,f;if(!l){for(d=0,f=this.altFormatsArray.length;d<f&&!l;d++){l=Date.parseDate(k[0],this.altFormatsArray[d])}}if(!g){for(d=0,f=this.altFormatsArray.length;d<f&&!g;d++){g=Date.parseDate(k[1],this.altFormatsArray[d])}}}if(!l||!g){return null}else{return{startDate:l,endDate:g}}}else{return null}}},formatDate:function(a){if(Ext.isDate(a)){return Genapp.form.DateRangeField.superclass.formatDate.call(this,a)}if(this.isRangeDate(a)){if(a.startDate==null&&a.endDate!=null){if(this.usePrefix){return this.endDatePrefix+a.endDate.format(this.format)}else{return this.minValue.format(this.format)+this.dateSeparator+a.endDate.format(this.format)}}else{if(a.startDate!=null&&a.endDate==null){if(this.usePrefix){return this.startDatePrefix+a.startDate.format(this.format)}else{return a.startDate.format(this.format)+this.dateSeparator+this.maxValue.format(this.format)}}else{if(a.startDate!=null&&a.endDate!=null){if(this.mergeEqualValues&&a.endDate.getElapsed(a.startDate)==0){return a.startDate.format(this.format)}else{if(this.autoReverse&&a.endDate.getTime()-a.startDate.getTime()<0){return a.endDate.format(this.format)+this.dateSeparator+a.startDate.format(this.format)}else{return a.startDate.format(this.format)+this.dateSeparator+a.endDate.format(this.format)}}}else{return""}}}}else{return a}},onTriggerClick:function(){if(this.disabled){return}if(!this.menu){this.menu=new Genapp.menu.DateRangeMenu({hideOnClick:false,hideValidationButton:this.hideValidationButton,showToday:this.showToday})}this.onFocus();if(typeof this.minDefaultValue==="string"){this.minDefaultValue=new Date(this.minDefaultValue)}if(typeof this.maxDefaultValue==="string"){this.maxDefaultValue=new Date(this.maxDefaultValue)}Ext.apply(this.menu.rangePicker.startDatePicker,{minDate:this.minValue,maxDate:this.maxValue,defaultValue:this.minDefaultValue,disabledDatesRE:this.disabledDatesRE,disabledDatesText:this.disabledDatesText,disabledDays:this.disabledDays,disabledDaysText:this.disabledDaysText,format:this.format,showToday:this.showToday,minText:String.format(this.minText,this.formatDate(this.minValue)),maxText:String.format(this.maxText,this.formatDate(this.maxValue))});Ext.apply(this.menu.rangePicker.endDatePicker,{minDate:this.minValue,maxDate:this.maxValue,defaultValue:this.maxDefaultValue,disabledDatesRE:this.disabledDatesRE,disabledDatesText:this.disabledDatesText,disabledDays:this.disabledDays,disabledDaysText:this.disabledDaysText,format:this.format,showToday:this.showToday,minText:String.format(this.minText,this.formatDate(this.minValue)),maxText:String.format(this.maxText,this.formatDate(this.maxValue))});var b=this.getValue();var c=this.minDefaultValue;var a=this.maxDefaultValue;if(Ext.isDate(b)){c=b;a=b}else{if(this.isRangeDate(b)){if(b.startDate!=null){c=b.startDate}if(b.endDate!=null){a=b.endDate}}}this.menu.rangePicker.startDatePicker.setValue(c);this.menu.rangePicker.endDatePicker.setValue(a);this.menu.show(this.el,"tl-bl?");this.menuEvents("on")},isRangeDate:function(a){return(Ext.isObject(a)&&(Ext.isDate(a.startDate)||a.startDate==null)&&(Ext.isDate(a.endDate)||a.endDate==null))},getValue:function(){return this.parseRangeDate(Ext.form.DateField.superclass.getValue.call(this))||""},setValue:function(a){return Ext.form.DateField.superclass.setValue.call(this,this.formatDate(this.parseRangeDate(a)))},beforeBlur:function(){var a=this.parseRangeDate(this.getRawValue());if(a){this.setValue(a)}}});Ext.reg("daterangefield",Genapp.form.DateRangeField);Ext.namespace("Genapp.form");Genapp.form.GeometryField=Ext.extend(Ext.form.TriggerField,{fieldLabel:"Location",mapWindowTitle:"Draw the search zone on the map :",mapWindowValidateButtonText:"Validate",mapWindowValidateAndSearchButtonText:"Validate and search",mapWindowCancelButtonText:"Cancel",triggerClass:"x-form-map-trigger",editable:false,hideMapDetails:true,mapWindowMaximizable:true,mapWindowMaximized:false,mapWindowHeight:500,mapWindowWidth:850,mapWindowMinZoomLevel:0,initComponent:function(){Genapp.form.GeometryField.superclass.initComponent.call(this);if(!this.hideTrigger){this.onTriggerClick=function(){if(this.disabled){return}if(!(this.mapWindow instanceof Ext.Window)){this.openMap(this)}else{this.mapWindow.show()}}}},openMap:function(){if(!this.mapWindow){this.mapWindow=new Ext.Window({layout:"fit",maximizable:this.mapWindowMaximizable,maximized:this.mapWindowMaximized,title:this.mapWindowTitle,width:this.mapWindowWidth,height:this.mapWindowHeight,closeAction:"destroy",draggable:false,resizable:false,modal:true,scope:true,items:this.mapPanel=new Genapp.MapPanel({title:"",isDrawingMap:true,featureWKT:this.getRawValue(),hideMapDetails:this.hideMapDetails,minZoomLevel:this.mapWindowMinZoomLevel,resultsBBox:Ext.getCmp("consultation_panel").mapPanel.resultsBBox}),buttons:[{text:this.mapWindowCancelButtonText,handler:function(){this.mapWindow.destroy()},scope:this},{text:this.mapWindowValidateButtonText,handler:this.onWindowValidate,scope:this},{text:this.mapWindowValidateAndSearchButtonText,handler:this.onWindowValidate.createDelegate(this,[true])}]});this.mapWindow.on("destroy",function(){delete this.mapWindow;if(this.submitRequest==true){Ext.getCmp("consultation_panel").submitRequest();this.submitRequest=false}},this);this.mapPanel.on("afterinit",function(b){var a=Ext.getCmp("consultation_panel");b.map.setCenter(a.mapPanel.map.getCenter());b.map.zoomTo(a.mapPanel.map.getZoom()-this.mapWindowMinZoomLevel);b.enableLayersAndLegends(this.mapPanel.layersActivation.request,true,true)},this)}this.mapWindow.show()},onWindowValidate:function(a){var b=this.mapPanel.vectorLayer.features.length?this.mapPanel.wktFormat.write(this.mapPanel.vectorLayer.features[0]):"";this.setValue(b);if(a==true){this.submitRequest=true}this.mapWindow.destroy();this.el.highlight()}});Ext.reg("geometryfield",Genapp.form.GeometryField);Ext.namespace("Genapp.form");Genapp.form.NumberRangeField=Ext.extend(Ext.form.TriggerField,{numberSeparator:" - ",minText:"The minimum value for this field is {0}",maxText:"The maximum value for this field is {0}",reverseText:"The max number must be superior to the min number",formatText:"The correct format is '{0}'",allowDecimals:true,decimalSeparator:".",decimalPrecision:2,allowNegative:true,minValue:-Number.MAX_VALUE,maxValue:Number.MAX_VALUE,nanText:"'{0}' is not a valid number",baseChars:"0123456789 ",hideValidationButton:false,setEmptyText:false,initEvents:function(){var a=this.baseChars+"";if(this.allowDecimals){a+=this.decimalSeparator}if(this.allowNegative){a+="-"}this.maskRe=new RegExp("["+Ext.escapeRe(a)+"]");Genapp.form.NumberRangeField.superclass.initEvents.call(this)},initComponent:function(){Genapp.form.NumberRangeField.superclass.initComponent.call(this);this.addEvents("select");if(this.setEmptyText){this.emptyText=this.minValue+this.numberSeparator+this.maxValue}var a=0;if(this.decimalPrecision>0){a=a+this.decimalSeparator;for(i=0;i<this.decimalPrecision;i++){a=a+"0"}}a=a+this.numberSeparator+a;this.formatText=String.format(this.formatText,a)},validateValue:function(e){if(!Genapp.form.NumberRangeField.superclass.validateValue.call(this,e)){return false}if(e.length<1){return true}var c=e.split(this.numberSeparator);if(c.length==1){var b=this.parseValue(c[0]);if(isNaN(b)){this.markInvalid(String.format(this.nanText,b));return false}else{return true}}else{if(c.length==2){var d=this.parseValue(c[0]);var a=this.parseValue(c[1]);if(a===""||d===""){this.markInvalid(this.formatText);return false}if(isNaN(d)){this.markInvalid(String.format(this.nanText,d));return false}if(isNaN(a)){this.markInvalid(String.format(this.nanText,a));return false}if(d<this.minValue){this.markInvalid(String.format(this.minText,this.minValue));return false}if(a>this.maxValue){this.markInvalid(String.format(this.maxText,this.maxValue));return false}if((a-d)<0){this.markInvalid(this.reverseText);return false}return true}else{this.markInvalid(this.formatText);return false}}},getValue:function(){var b=Genapp.form.NumberRangeField.superclass.getValue.call(this);var a=b.split(this.numberSeparator);if(a.length==1){return String(this.fixPrecision(this.parseValue(a[0]))).replace(".",this.decimalSeparator)}else{if(a.length==2){return String(this.fixPrecision(this.parseValue(a[0]))).replace(".",this.decimalSeparator)+this.numberSeparator+String(this.fixPrecision(this.parseValue(a[1]))).replace(".",this.decimalSeparator)}else{return""}}},setValue:function(c){var d=null;var a=null;if(Ext.isObject(c)){if(typeof c.minValue!=="undefined"&&typeof c.maxValue!=="undefined"){d=c.minValue;a=c.maxValue}else{return""}}else{if(typeof c==="string"){var b=c.split(this.numberSeparator);if(b.length==1){d=a=this.parseValue(b[0])}else{if(b.length==2){d=this.parseValue(b[0]);a=this.parseValue(b[1])}else{return""}}}else{return""}}min=typeof d=="number"?d:parseFloat(String(d).replace(this.decimalSeparator,"."));max=typeof a=="number"?a:parseFloat(String(a).replace(this.decimalSeparator,"."));mins=isNaN(min)?"":String(this.fixPrecision(min)).replace(".",this.decimalSeparator);maxs=isNaN(max)?"":String(this.fixPrecision(max)).replace(".",this.decimalSeparator);if(min==max){c=mins}else{if(min<max){c=mins+this.numberSeparator+maxs}else{c=maxs+this.numberSeparator+mins}}return Genapp.form.NumberRangeField.superclass.setValue.call(this,c)},parseValue:function(a){a=parseFloat(String(a).replace(this.decimalSeparator,"."));return isNaN(a)?"":a},fixPrecision:function(b){var a=isNaN(b);if(!this.allowDecimals||this.decimalPrecision==-1||a||!b){return a?"":b}return parseFloat(parseFloat(b).toFixed(this.decimalPrecision))},onTriggerClick:function(){if(this.disabled){return}if(!this.menu){this.menu=new Genapp.menu.NumberRangeMenu({hideOnClick:false,hideValidationButton:this.hideValidationButton})}this.onFocus();Ext.apply(this.menu.rangePicker.minField,{emptyText:this.setEmptyText?this.minValue:null,allowDecimals:this.allowDecimals,decimalSeparator:this.decimalSeparator,decimalPrecision:this.decimalPrecision,allowNegative:this.allowNegative,minValue:this.minValue,maxValue:this.maxValue,baseChars:this.baseChars});Ext.apply(this.menu.rangePicker.maxField,{emptyText:this.setEmptyText?this.maxValue:null,allowDecimals:this.allowDecimals,decimalSeparator:this.decimalSeparator,decimalPrecision:this.decimalPrecision,allowNegative:this.allowNegative,minValue:this.minValue,maxValue:this.maxValue,baseChars:this.baseChars});var b=this.getValue().split(this.numberSeparator);if(b.length==1){var c=this.parseValue(b[0]);var a=c}else{if(b.length==2){var c=this.parseValue(b[0]);var a=this.parseValue(b[1])}else{return}}this.menu.rangePicker.minField.setValue(c);this.menu.rangePicker.maxField.setValue(a);this.menu.show(this.el,"tl-bl?");this.menuEvents("on")},menuEvents:function(a){this.menu[a]("select",this.onSelect,this);this.menu[a]("hide",this.onMenuHide,this);this.menu[a]("show",this.onFocus,this)},onSelect:function(a,b){this.fireEvent("select",this,b);this.menu.hide()},onMenuHide:function(){this.focus(false,60);this.menuEvents("un");this.setValue({minValue:this.menu.rangePicker.minField.getValue(),maxValue:this.menu.rangePicker.maxField.getValue()})},validateBlur:function(){return !this.menu||!this.menu.isVisible()},onDestroy:function(){Ext.destroy(this.menu,this.wrap);Genapp.form.NumberRangeField.superclass.onDestroy.call(this)},beforeBlur:function(){var a=this.getRawValue();if(a){this.setValue(a)}}});Ext.reg("numberrangefield",Genapp.form.NumberRangeField);Ext.namespace("Genapp.form");Genapp.form.TwinNumberField=Ext.extend(Ext.form.TwinTriggerField,{fieldClass:"x-form-field x-form-num-field",allowDecimals:true,decimalSeparator:".",decimalPrecision:2,allowNegative:true,minValue:-Number.MAX_VALUE,maxValue:Number.MAX_VALUE,minText:"The minimum value for this field is {0}",maxText:"The maximum value for this field is {0}",nanText:"{0} is not a valid number",baseChars:"0123456789",trigger1Class:"x-form-clear-trigger",hideTrigger1:true,hideTrigger2:true,initComponent:function(){this.on("change",this.onChange,this);Genapp.form.TwinNumberField.superclass.initComponent.call(this)},onTrigger1Click:function(){this.reset();this.triggers[0].hide()},onChange:function(b){var a=this.getValue();if(a!==""&&a!=null){this.triggers[0].show()}else{this.triggers[0].hide()}},initEvents:function(){var a=this.baseChars+"";if(this.allowDecimals){a+=this.decimalSeparator}if(this.allowNegative){a+="-"}this.maskRe=new RegExp("["+Ext.escapeRe(a)+"]");Ext.form.NumberField.superclass.initEvents.call(this)},validateValue:function(b){if(!Ext.form.NumberField.superclass.validateValue.call(this,b)){return false}if(b.length<1){return true}b=String(b).replace(this.decimalSeparator,".");if(isNaN(b)){this.markInvalid(String.format(this.nanText,b));return false}var a=this.parseValue(b);if(a<this.minValue){this.markInvalid(String.format(this.minText,this.minValue));return false}if(a>this.maxValue){this.markInvalid(String.format(this.maxText,this.maxValue));return false}return true},getValue:function(){return this.fixPrecision(this.parseValue(Ext.form.NumberField.superclass.getValue.call(this)))},setValue:function(a){a=typeof a=="number"?a:parseFloat(String(a).replace(this.decimalSeparator,"."));a=isNaN(a)?"":String(a).replace(".",this.decimalSeparator);if(this.triggers){if(a!==""&&a!=null&&a!=this.minValue&&a!=this.maxValue){this.triggers[0].show()}else{this.triggers[0].hide()}}return Ext.form.NumberField.superclass.setValue.call(this,a)},parseValue:function(a){a=parseFloat(String(a).replace(this.decimalSeparator,"."));return isNaN(a)?"":a},fixPrecision:function(b){var a=isNaN(b);if(!this.allowDecimals||this.decimalPrecision==-1||a||!b){return a?"":b}return parseFloat(parseFloat(b).toFixed(this.decimalPrecision))},beforeBlur:function(){var a=this.parseValue(this.getRawValue());if(a!==""&&a!=null){this.setValue(this.fixPrecision(a))}}});Ext.reg("twinnumberfield",Genapp.form.TwinNumberField);Ext.namespace("Genapp.menu");Genapp.menu.DateRangeMenu=Ext.extend(Ext.menu.DateMenu,{layout:"auto",cls:"x-date-range-menu",initComponent:function(){this.on("beforeshow",this.onBeforeShow,this);Ext.apply(this,{plain:true,showSeparator:false,items:[this.rangePicker=new Genapp.DateRangePicker(this.initialConfig)]});this.rangePicker.purgeListeners();Ext.menu.DateMenu.superclass.initComponent.call(this);this.relayEvents(this.rangePicker,["select"])},onBeforeShow:function(){if(this.rangePicker){this.rangePicker.startDatePicker.hideMonthPicker(true);this.rangePicker.endDatePicker.hideMonthPicker(true)}},showAt:function(c,b,a){this.parentMenu=b;if(!this.el){this.render()}if(a!==false){this.fireEvent("beforeshow",this);c=this.el.adjustForConstraints(c)}this.el.setXY(c);if(this.enableScrolling){this.constrainScroll(c[1])}this.el.show();Ext.menu.Menu.superclass.onShow.call(this);this.hidden=false;this.focus();this.fireEvent("show",this)}});Ext.reg("daterangemenu",Genapp.menu.DateRangeMenu);Ext.namespace("Genapp.menu");Genapp.menu.NumberRangeMenu=Ext.extend(Ext.menu.Menu,{layout:"auto",cls:"x-number-range-menu",initComponent:function(){Ext.apply(this,{plain:true,showSeparator:false,items:[this.rangePicker=new Genapp.NumberRangePicker(this.initialConfig)]});this.rangePicker.purgeListeners();Genapp.menu.NumberRangeMenu.superclass.initComponent.call(this);this.relayEvents(this.rangePicker,["select"])},showAt:function(c,b,a){this.parentMenu=b;if(!this.el){this.render()}if(a!==false){c=this.el.adjustForConstraints(c)}this.el.setXY(c);if(this.enableScrolling){this.constrainScroll(c[1])}this.el.show();Ext.menu.Menu.superclass.onShow.call(this);this.hidden=false;this.focus();this.fireEvent("show",this)}});Ext.reg("numberrangemenu",Genapp.menu.NumberRangeMenu);Ext.namespace("Ext.ux.form");Ext.ux.form.BasicCheckbox=Ext.extend(Ext.form.Field,{focusClass:undefined,fieldClass:"x-form-field",checked:false,mode:"compat",themedCompat:false,defaultAutoCreate:{tag:"input",type:"checkbox",autocomplete:"off"},boxLabel:undefined,inputValue:undefined,markEl:"wrap",mustCheck:false,mustCheckText:"This field is required",compatConfig:{enabled:{no:"checkbox_off",on:"checkbox_on"},disabled:{no:"checkbox_off_dled",on:"checkbox_on_dled"},width:14,height:16},switchConfig:{enabled:{"0":"checkbox_off","1":"checkbox_on"},disabled:{"0":"checkbox_off_dled","1":"checkbox_on_dled"},width:14,height:16},cycledConfig:{enabled:{"0":"flag_blue","1":"flag_green","2":"flag_orange","3":"flag_pink","4":"flag_purple","5":"flag_red","6":"flag_yellow"},disabled:{"0":"flag_grey","1":"flag_grey","2":"flag_grey","3":"flag_grey","4":"flag_grey","5":"flag_grey","6":"flag_grey"},width:16,height:16},originalValue:undefined,protectedValue:undefined,initComponent:function(){Ext.ux.form.BasicCheckbox.superclass.initComponent.call(this);this.addEvents("check","click")},onResize:function(){Ext.ux.form.BasicCheckbox.superclass.onResize.apply(this,arguments);if(!this.boxLabel){this.el.alignTo(this.wrap,"c-c")}},initEvents:function(){Ext.ux.form.BasicCheckbox.superclass.initEvents.call(this);if(this.mode!="compat"||this.themedCompat){this.mon(this.el,{click:this.onClick,change:this.onChange,mouseenter:this.onMouseEnter,mouseleave:this.onMouseLeave,mousedown:this.onMouseDown,mouseup:this.onMouseUp,scope:this})}else{this.mon(this.el,{click:this.onClick,change:this.onChange,scope:this})}},getResizeEl:function(){return this.wrap},getPositionEl:function(){return this.wrap},alignErrorIcon:function(){this.errorIcon.alignTo(this.wrap,"tl-tr",[2,0])},markInvalid:function(a){Ext.ux.form.BasicCheckbox.superclass.markInvalid.call(this,a)},clearInvalid:function(){Ext.ux.form.BasicCheckbox.superclass.clearInvalid.call(this)},validateValue:function(b){var a=(this.rendered?this.el.dom.value:this.inputValue);var f=((this.rendered?this.el.dom.disabled:this.disabled)?"disabled":"enabled");if(this.mode=="compat"&&this.mustCheck&&!b){this.markInvalid(this.mustCheckText);return false}if(this.mode!="compat"){if(a!==undefined&&a!==null&&this[this.mode+"Config"][f][a]===undefined){this.markInvalid();return false}}if(this.vtype){var e=Ext.form.VTypes;if(!e[this.vtype](b,this)){this.markInvalid(this.vtypeText||e[this.vtype+"Text"]);return false}}if(typeof this.validator=="function"){var c=this.validator(b);if(c!==true){this.markInvalid(c);return false}}if(this.regex&&!this.regex.test(b)){this.markInvalid(this.regexText);return false}return true},onRender:function(b,a){Ext.ux.form.BasicCheckbox.superclass.onRender.call(this,b,a);var c=this[this.mode+"Config"].width;var d=this[this.mode+"Config"].height;this.protectedValue=this.inputValue;if(this.protectedValue!==undefined){this.el.dom.value=this.protectedValue}else{this.setNextValue()}if(this.mode!="compat"||this.themedCompat){this.el.setOpacity(0)}this.innerWrap=this.el.wrap({cls:"x-sm-form-check-innerwrap"});this.innerWrap.setStyle({position:"relative",display:"inline"});this.wrap=this.innerWrap.wrap({cls:"x-form-check-wrap"});this.vel=this.innerWrap.createChild({tag:"div",cls:"x-sm-form-check"},this.el.dom);if(this.mode!="compat"||this.themedCompat){this.vel.setSize(c,d);this.el.setStyle({position:"absolute"});this.el.setTop(Math.round((d-16)/2));this.el.setLeft(Math.round((c-14)/2))}if(this.boxLabel){this.wrap.createChild({tag:"label",htmlFor:this.el.id,cls:"x-form-cb-label",html:this.boxLabel})}if(this.mode=="compat"){this.checked=(this.checked?true:(this.el.dom.checked?true:false));this.setValue(this.checked)}else{this.el.dom.checked=true;this.el.dom.defaultChecked=true;this.setValue(this.protectedValue)}},manageActiveClass:function(){if(this.rendered&&(this.mode!="compat"||this.themedCompat)){var b=(this.mode=="compat"?this.protectedValue:(this.rendered?this.el.dom.value:this.protectedValue));var f=((this.rendered?this.el.dom.disabled:this.disabled)?"disabled":"enabled");var g=this[this.mode+"Config"][f][b];var a;for(var e in this[this.mode+"Config"][f]){a=e;break}if(g===undefined){g=this[this.mode+"Config"][f][a]}if(this.previousClass!==undefined){this.vel.removeClass(this.previousClass)}this.previousClass=g;this.vel.addClass(g)}},setNextValue:function(){var b=(this.mode=="compat"?this.protectedValue:(this.rendered?this.el.dom.value:this.protectedValue));var e=((this.rendered?this.el.dom.disabled:this.disabled)?"disabled":"enabled");var f=false;var a=null;this.protectedValue=null;for(var c in this[this.mode+"Config"][e]){if(a===null){a=c}if(b===undefined){break}if(f&&this.protectedValue===null){this.protectedValue=c}if(c==b){f=true}}if(this.protectedValue===null){this.protectedValue=a}if(this.mode!="compat"){this.inputValue=this.protectedValue}if(this.rendered&&this.inputValue!==undefined){this.el.dom.value=this.inputValue}},onDestroy:function(){if(this.wrap){this.wrap.remove()}Ext.ux.form.BasicCheckbox.superclass.onDestroy.call(this)},initValue:function(){this.originalValue=this.inputValue;if(this.mode=="compat"){this.originalValue=this.checked}},getRawValue:function(){if(this.mode=="compat"){if(this.rendered){return this.el.dom.checked}else{return this.checked}}var a=this.rendered?this.el.getValue():Ext.value(this.value,"");return a},getValue:function(){var a=false;if(this.mode=="compat"){if(this.rendered){a=this.el.dom.checked}else{a=this.protectedValue}}return a},onClick:function(){if(this.mode=="compat"){if(this.el.dom.checked!=this.checked){this.setNextValue();this.checked=this.el.dom.checked}}else{this.setNextValue();this.el.dom.checked=true;this.el.dom.defaultChecked=true}this.manageActiveClass();this.validate();this.fireEvent("check",this,this.checked,this.inputValue);this.fireEvent("click",this,this.checked,this.inputValue)},onChange:function(){if(this.mode=="compat"){if(this.el.dom.checked!=this.checked){this.setNextValue();this.checked=this.el.dom.checked}}else{this.inputValue=this.el.dom.value;this.protectedValue=this.inputValue;this.el.dom.checked=true;this.el.dom.defaultChecked=true}this.manageActiveClass();this.validate();this.fireEvent("check",this,this.checked,this.inputValue);this.fireEvent("change",this,this.checked,this.inputValue)},setValue:function(b){if(this.mode=="compat"){this.checked=(b===true||b==="true"||b=="1"||String(b).toLowerCase()=="on");if(this.rendered){this.el.dom.checked=this.checked;this.el.dom.defaultChecked=this.checked}this.protectedValue=(this.checked?"on":"no")}else{var c=((this.rendered?this.el.dom.disabled:this.disabled)?"disabled":"enabled");this.checked=true;if(this[this.mode+"Config"][c][b]!==undefined){this.protectedValue=b}else{for(var a in this[this.mode+"Config"][c]){this.protectedValue=a;break}}this.inputValue=this.protectedValue;if(this.rendered&&this.inputValue!==undefined){this.el.dom.value=this.inputValue}}this.manageActiveClass();this.validate();this.fireEvent("check",this,this.checked);return this},disable:function(){Ext.ux.form.BasicCheckbox.superclass.disable.call(this);this.manageActiveClass()},enable:function(){Ext.ux.form.BasicCheckbox.superclass.enable.call(this);this.manageActiveClass()},onMouseEnter:function(){this.wrap.addClass("x-sm-form-check-over")},onMouseLeave:function(){this.wrap.removeClass("x-sm-form-check-over")},onMouseDown:function(){this.wrap.addClass("x-sm-form-check-down")},onMouseUp:function(){this.wrap.removeClass("x-sm-form-check-down")},onFocus:function(){Ext.ux.form.BasicCheckbox.superclass.onFocus.call(this);this.wrap.addClass("x-sm-form-check-focus")},onBlur:function(){Ext.ux.form.BasicCheckbox.superclass.onBlur.call(this);this.wrap.removeClass("x-sm-form-check-focus")}});Ext.form.Checkbox=Ext.ux.form.BasicCheckbox;Ext.reg("checkbox",Ext.form.Checkbox);Ext.ux.form.Checkbox=Ext.extend(Ext.ux.form.BasicCheckbox,{mode:"switch"});Ext.reg("switch_checkbox",Ext.ux.form.Checkbox);Ext.ux.form.CycleCheckbox=Ext.extend(Ext.ux.form.BasicCheckbox,{mode:"cycled"});Ext.reg("cycle_checkbox",Ext.ux.form.CycleCheckbox);Ext.override(Ext.form.Field,{markEl:"el",markInvalid:function(c){if(!this.rendered||this.preventMark){return}c=c||this.invalidText;var a=this.getMessageHandler();if(a){a.mark(this,c)}else{if(this.msgTarget){this[this.markEl].addClass(this.invalidClass);var b=Ext.getDom(this.msgTarget);if(b){b.innerHTML=c;b.style.display=this.msgDisplay}}}this.fireEvent("invalid",this,c)},clearInvalid:function(){if(!this.rendered||this.preventMark){return}var a=this.getMessageHandler();if(a){a.clear(this)}else{if(this.msgTarget){this[this.markEl].removeClass(this.invalidClass);var b=Ext.getDom(this.msgTarget);if(b){b.innerHTML="";b.style.display="none"}}}this.fireEvent("valid",this)}});Ext.apply(Ext.form.MessageTargets,{qtip:{mark:function(a,c){var b=a[(a.markEl?a.markEl:"el")];b.addClass(a.invalidClass);b.dom.qtip=c;b.dom.qclass="x-form-invalid-tip";if(Ext.QuickTips){Ext.QuickTips.enable()}},clear:function(a){var b=a[(a.markEl?a.markEl:"el")];b.removeClass(a.invalidClass);b.dom.qtip=""}},title:{mark:function(a,c){var b=a[(a.markEl?a.markEl:"el")];b.addClass(a.invalidClass);b.dom.title=c},clear:function(a){a[a.markEl].dom.title=""}},under:{mark:function(b,d){var c=b[(b.markEl?b.markEl:"el")],e=b.errorEl;c.addClass(b.invalidClass);if(!e){var a=b.getErrorCt();if(!a){c.dom.title=d;return}e=b.errorEl=a.createChild({cls:"x-form-invalid-msg"});e.setWidth(a.getWidth(true)-20)}e.update(d);Ext.form.Field.msgFx[b.msgFx].show(e,b)},clear:function(a){var b=a[(a.markEl?a.markEl:"el")],c=a.errorEl;b.removeClass(a.invalidClass);if(c){Ext.form.Field.msgFx[a.msgFx].hide(c,a)}else{b.dom.title=""}}},side:{mark:function(c,e){var d=c[(c.markEl?c.markEl:"el")],b=c.errorIcon;d.addClass(c.invalidClass);if(!b){var a=c.getErrorCt();if(!a){d.dom.title=e;return}b=c.errorIcon=a.createChild({cls:"x-form-invalid-icon"})}c.alignErrorIcon();b.dom.qtip=e;b.dom.qclass="x-form-invalid-tip";b.show();c.on("resize",c.alignErrorIcon,c)},clear:function(b){var c=b[(b.markEl?b.markEl:"el")],a=b.errorIcon;c.removeClass(b.invalidClass);if(a){a.dom.qtip="";a.hide();b.un("resize",b.alignErrorIcon,b)}else{c.dom.title=""}}}});(function(){function b(d){var c=Array.prototype.slice.call(arguments,1);return d.replace(/\{(\d+)\}/g,function(e,f){return c[f]})}var a=Date.formatCodeToRegex;Date.createParser=function(){var c=["var dt, y, m, d, h, i, s, ms, o, z, zz, u, v,","def = Date.defaults,","results = String(input).match(Date.parseRegexes[{0}]);","if(results){","{1}","if(u != null){","v = new Date(u * 1000);","}else{","dt = (new Date()).clearTime();","y = y >= 0? y : Ext.num(def.y, dt.getFullYear());","m = m >= 0? m : Ext.num(def.m - 1, dt.getMonth());","d = d || Ext.num(def.d, dt.getDate());","h  = h || Ext.num(def.h, dt.getHours());","i  = i || Ext.num(def.i, dt.getMinutes());","s  = s || Ext.num(def.s, dt.getSeconds());","ms = ms || Ext.num(def.ms, dt.getMilliseconds());","if(z >= 0 && y >= 0){","v = new Date(y, 0, 1, h, i, s, ms);","v = !strict? v : (strict === true && (z <= 364 || (v.isLeapYear() && z <= 365))? v.add(Date.DAY, z) : null);","}else if(strict === true && !Date.isValid(y, m + 1, d, h, i, s, ms)){","v = null;","}else{","v = new Date(y, m, d, h, i, s, ms);","}","}","}","if(v){","v.setFullYear(y);","if(zz != null){","v = v.add(Date.SECOND, -v.getTimezoneOffset() * 60 - zz);","}else if(o){","v = v.add(Date.MINUTE, -v.getTimezoneOffset() + (sn == '+'? -1 : 1) * (hr * 60 + mn));","}","}","return v;"].join("\n");return function(l){var e=Date.parseRegexes.length,m=1,f=[],k=[],j=false,d="";for(var h=0;h<l.length;++h){d=l.charAt(h);if(!j&&d=="\\"){j=true}else{if(j){j=false;k.push(String.escape(d))}else{var g=a(d,m);m+=g.g;k.push(g.s);if(g.g&&g.c){f.push(g.c)}}}}Date.parseRegexes[e]=new RegExp("^"+k.join("")+"$","i");Date.parseFunctions[l]=new Function("input","strict",b(c,e,f.join("")))}}();Date.formatCodes.f="String.leftPad(this.getFullYear(), 4, '0')";Date.parseCodes.f=Date.parseCodes.Y}());Ext.DatePicker.prototype.onMonthClick=function(f,b){f.stopEvent();var c=new Ext.Element(b),a;if(c.is("button.x-date-mp-cancel")){this.hideMonthPicker()}else{if(c.is("button.x-date-mp-ok")){var g=new Date(this.mpSelYear,this.mpSelMonth,(this.activeDate||this.value).getDate());if(g.getMonth()!=this.mpSelMonth){g=new Date(this.mpSelYear,this.mpSelMonth,1).getLastDateOfMonth()}g.setFullYear(this.mpSelYear);this.update(g);this.hideMonthPicker()}else{if(a=c.up("td.x-date-mp-month",2)){this.mpMonths.removeClass("x-date-mp-sel");a.addClass("x-date-mp-sel");this.mpSelMonth=a.dom.xmonth}else{if(a=c.up("td.x-date-mp-year",2)){this.mpYears.removeClass("x-date-mp-sel");a.addClass("x-date-mp-sel");this.mpSelYear=a.dom.xyear}else{if(c.is("a.x-date-mp-prev")){this.updateMPYear(this.mpyear-10)}else{if(c.is("a.x-date-mp-next")){this.updateMPYear(this.mpyear+10)}}}}}}};Ext.DatePicker.prototype.onMonthDblClick=function(f,c){f.stopEvent();var d=new Ext.Element(c),b;var a=null;if(b=d.up("td.x-date-mp-month",2)){a=new Date(this.mpSelYear,b.dom.xmonth,(this.activeDate||this.value).getDate());a.setFullYear(this.mpSelYear);this.update(a);this.hideMonthPicker()}else{if(b=d.up("td.x-date-mp-year",2)){a=new Date(b.dom.xyear,this.mpSelMonth,(this.activeDate||this.value).getDate());a.setFullYear(b.dom.xyear);this.update(a);this.hideMonthPicker()}}};Ext.DatePicker.prototype.update=function(G,A){if(this.rendered){var a=this.activeDate,o=this.isVisible();this.activeDate=G;if(!A&&a&&this.el){var n=G.getTime();if(a.getMonth()==G.getMonth()&&a.getFullYear()==G.getFullYear()){this.cells.removeClass("x-date-selected");this.cells.each(function(d){if(d.dom.firstChild.dateValue==n){d.addClass("x-date-selected");if(o&&!this.cancelFocus){Ext.fly(d.dom.firstChild).focus(50)}return false}},this);return}}var j=G.getDaysInMonth(),p=G.getFirstDateOfMonth(),f=p.getDay()-this.startDay;if(f<0){f+=7}j+=f;var B=G.add("mo",-1),g=B.getDaysInMonth()-f,e=this.cells.elements,q=this.textNodes,y=86400000,D=(new Date(B.getFullYear(),B.getMonth(),g)).clearTime(),C=new Date().clearTime().getTime(),u=G.clearTime(true).getTime(),s=this.minDate?this.minDate.clearTime(true):Number.NEGATIVE_INFINITY,x=this.maxDate?this.maxDate.clearTime(true):Number.POSITIVE_INFINITY,F=this.disabledDatesRE,r=this.disabledDatesText,I=this.disabledDays?this.disabledDays.join(""):false,E=this.disabledDaysText,z=this.format;D.setFullYear(B.getFullYear());if(this.showToday){var l=new Date().clearTime(),c=(l<s||l>x||(F&&z&&F.test(l.dateFormat(z)))||(I&&I.indexOf(l.getDay())!=-1));if(!this.disabled){this.todayBtn.setDisabled(c);this.todayKeyListener[c?"disable":"enable"]()}}var k=function(K,d){d.title="";var w=D.getTime();d.firstChild.dateValue=w;if(w==C){d.className+=" x-date-today";d.title=K.todayText}if(w==u){d.className+=" x-date-selected";if(o){Ext.fly(d.firstChild).focus(50)}}if(w<s){d.className=" x-date-disabled";d.title=K.minText;return}if(w>x){d.className=" x-date-disabled";d.title=K.maxText;return}if(I){if(I.indexOf(D.getDay())!=-1){d.title=E;d.className=" x-date-disabled"}}if(F&&z){var J=D.dateFormat(z);if(F.test(J)){d.title=r.replace("%0",J);d.className=" x-date-disabled"}}};var v=0;for(;v<f;v++){q[v].innerHTML=(++g);D.setDate(D.getDate()+1);e[v].className="x-date-prevday";k(this,e[v])}for(;v<j;v++){var b=v-f+1;q[v].innerHTML=(b);D.setDate(D.getDate()+1);e[v].className="x-date-active";k(this,e[v])}var H=0;for(;v<42;v++){q[v].innerHTML=(++H);D.setDate(D.getDate()+1);e[v].className="x-date-nextday";k(this,e[v])}this.mbtn.setText(this.monthNames[G.getMonth()]+" "+G.getFullYear());if(!this.internalRender){var h=this.el.dom.firstChild,m=h.offsetWidth;this.el.setWidth(m+this.el.getBorderWidth("lr"));Ext.fly(h).setWidth(m);this.internalRender=true;if(Ext.isOpera&&!this.secondPass){h.rows[0].cells[1].style.width=(m-(h.rows[0].cells[0].offsetWidth+h.rows[0].cells[2].offsetWidth))+"px";this.secondPass=true;this.update.defer(10,this,[G])}}}};