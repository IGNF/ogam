{% extends "::base.html.twig" %}

{% block body %}
<script type="text/javascript" src="{{ asset('js/integration/progressbar.js') }}"></script>
<script type="text/javascript" src="{{ asset('js/integration/later.min.js') }}"></script>
<h1>{% trans %}Data integration module{% endtrans %}</h1>
<p class="onTableLink">
    <a href="{{ path("integration_creation") }}">{% trans %}Create data submission{% endtrans %}</a>
</p>

<!-- Show the currently active location submissions -->
{% if submissions is not empty %}
<table class="sectiontable">
<tr>
    <th style="text-align:center">{% trans %}Submission ID{% endtrans %}</th>
    <th style="text-align:center">{{ 'Date'|trans }}</th>
    <th style="text-align:center">{{ 'Provider'|trans }}</th>
    <th style="text-align:center">{{ 'User'|trans }}</th>
    <th style="text-align:center">{{ 'Dataset'|trans }}</th>
    <th style="text-align:center">{{ 'Step'|trans }}</th>
    <th style="text-align:center">{{ 'Status'|trans }}</th>
    <th>{{ 'File'|trans }}</th>
    <th style="text-align:right">{{ 'Lines'|trans }}&nbsp;</th>
    <th style="text-align:center">{{ 'Actions'|trans }}</th>
    <th></th>
</tr>
{%  
set user = app.user

%}
{% for submission in submissions %}

<tr class="sectiontableentry{{ loop.index0 % 2 }}">
    <td>{{ submission.id|e }}</td>
    <td>{{ submission.creationDate|date("Y-m-d") }}</td>
    <td>{{ submission.provider.label|e }}</td>
    <td>{{ submission.user.login|e }}</td>
    <td>{{ submission.dataset.label|e }}</td>
    <td>{{ submission.step|e }}</td>
    <td>
            {% if submission.status in ['OK','CHECKED'] %}
                {{ submission.status }}
                <img src="{{ asset('img/Green_tick.png') }}" />
            {% elseif submission.status is same as('WARNING') %}
                {{ submission.status }}
                <img src="{{ asset('img/warning_orange.png') }}" />
            {% elseif submission.status is same as('RUNNING') %}
                <div class="tempStatusDiv" id="tempStatusDiv_{{ submission.id }}">
                <script type="text/javascript">
                var OgamDesktopIntegration = {};
                // Display the progress bar
                display('progressBar{{- submission.id -}}', '', 0, '{{ absolute_url('/img/') }}');

                // Refresh The status of the submission
                OgamDesktopIntegration.getStatus_{{- submission.id -}} = function (){
                    {% if submission.step is same as('CHECKED') %}
                    var url = '{{ url('integration_checkstatus') }}';
                    {% else %}
                      var  url = '{{ url('integration_status') }}';
                    {% endif %}
                    OgamDesktopIntegration.request = new XMLHttpRequest();
                    OgamDesktopIntegration.request.onreadystatechange = function() {
                        if (OgamDesktopIntegration.request.readyState == 4) { // 4: request finished and response is ready
                            if (OgamDesktopIntegration.request.status == 200) { // Success
                                var rp = JSON.parse(OgamDesktopIntegration.request.responseText);
                                var src = '{{ absolute_url('/img') }}';
                                switch(rp.status){
                                    case 'OK':
                                    case 'WARNING':
                                    case 'ERROR':
                                    case 'CRASH':
                                        //Ext.TaskMgr.stop(OgamDesktopIntegration.getStatusTask_{{- submission.id -}};
                                        OgamDesktopIntegration.getStatusTask_{{- submission.id -}}.clear();
                                        location.reload();
                                        break;
                                    case 'RUNNING':
                                        total = rp.totalCount;
                                        if (total == 0) {
                                            percentage = 1;
                                        } else {
                                            percentage = rp.currentCount / total;
                                        }
                                        percentage = (percentage * 100);
                                    setLabel('progressBar{{- submission.id -}}', rp.taskName);
                                    setProgress('progressBar{{- submission.id -}}', percentage);
                                        break;
                                    default:
                                        return;
                                }
                            } else { // Failure

                            }
                        }
                    };
                    OgamDesktopIntegration.request.open("GET", url+'?action=status&submissionId='+{{ submission.id }}, true);
                    OgamDesktopIntegration.request.send();
                }
                OgamDesktopIntegration.getStatusTask_{{ submission.id }} = later.setInterval(OgamDesktopIntegration.getStatus_{{- submission.id -}}, later.parse.text('every 4 sec'));
                </script>
                </div>
            {% else %}
                {{ submission.status|e }}
                <img src="{{ asset('img/Red_x.png') }}" />
            {% endif %}
    </td>
    <td colspan=2>
        {% if submission.status is not same as('RUNNING') %}
            <table width="100%">
            {% for file in submission.files %}
                <tr><td class="file-name">
                    <span title="{{ file.fileType|e('html_attr') }}">
                    {{ file.fileName|replace({'\\':'/'})|split('/')|last }}
                    </span>
                </td>
                <td class="line-number">{{ file.nbLines }}</td>
                </tr>
            {% endfor %}
            </table>
        {% endif %}
    </td>

    <td>
    {% if submission.step is constant('STEP_INSERTED', submission)  and submission.status is constant('STATUS_OK', submission) %}

    <p><a href="{{ path('integration_check', {'submissionId': submission.id}) }}" >{{ 'Check data'|trans }}</a></p>
    {% endif %}
    {% if submission.step is not constant('STEP_INIT', submission) and submission.status is not constant('STATUS_RUNNING', submission) %}

    <p><a href="{{ absolute_url("../proxy/show-report?submissionId=#{submission.id}") }}" >{{ 'Show report'|trans }}</a></p>
    {% endif %}
    {%  if (submission.step is same as('CHECKED') and (submission.status is same as("OK") or submission.status is same as('WARNING'))) %}

    <p><a href="{{ path('integration_validate',{'submissionId': submission.id}) }}" onClick="return confirm('{{ 'Confirm_submission_warning'|trans }}');">{{ 'Confirm submission'|trans }}</a></p>
    {% endif %}
    {%  if (submission.step != "VALIDATED" or user.isAllowed('CANCEL_VALIDATED_SUBMISSION'))
        and (submission.provider.id is same as(user.provider.id) or user.isAllowed('CANCEL_OTHER_PROVIDER_SUBMISSION')) %}
        
    <p><a href="{{ path('integration_cancel', {'submissionId': submission.id}) }}" onClick="return confirm('{{ 'Are you sure?'|trans }}');">{{ 'Cancel Submission'|trans }}</a></p>
    {% endif %} 
</td></tr>
{% endfor %}
</table>
{% else %}
<div class="no-submission">{% trans %}No submission found{% endtrans %}</div>
{% endif %}
<p class="subTableLink">
    <a href="{{ path("integration_creation") }}">{% trans %}Create data submission{% endtrans %}</a>
</p>

{% endblock %}
