MAP

#
# Start of OGAM map file
#
NAME OGAM_MAPSERVER
STATUS ON
SIZE 600 400
SYMBOLSET "C:/ms4w/apps/OGAM/Mapserv/data/fonts/symbols.sym" 

EXTENT 2460853 1070607 5537352 5031904

UNITS meters
SHAPEPATH "C:/ms4w/apps/OGAM/Mapserv/data/"
IMAGECOLOR 255 255 255
FONTSET "C:/ms4w/apps/OGAM/Mapserv/data/fonts/fonts.txt"

CONFIG  "MS_ERRORFILE" "C:/ms4w/apps/OGAM/website/htdocs/logs/mapserver_ogam.log"
DEBUG 5

#
# Start of web interface definition
#
WEB
   LOG "C:/ms4w/apps/OGAM/website/htdocs/logs/mapserver_ogam.log"
   METADATA
   
        WFS_TITLE                       "OGAM MapServer"  
        WFS_SRS                         "EPSG:3857"
        WFS_ABSTRACT                    "OGAM Data"  
        WFS_MAXFEATURES                 "40"
        WFS_ONLINERESOURCE              "http://localhost/cgi-bin/mapserv.exe?map=C:/ms4w/apps/OGAM/Mapserv/ogam.map&"

        WMS_TITLE                       "OGAM MapServer" 
        WMS_ABSTRACT                    "OGAM Mapserver"
        WMS_ACCESSCONSTRAINTS           "none"
        WMS_ONLINERESOURCE              "http://localhost/cgi-bin/mapserv.exe?map=C:/ms4w/apps/OGAM/Mapserv/ogam.map&"
        WMS_SRS                         "EPSG:3857"
        "ows_enable_request"            "*"
        "wms_include_items"      "*"
        "wms_feature_info_mime_type"    "text/html"
        "queryable"    "true"
      
        "wcs_label"                    "OGAM MapServer"
        "wcs_description"              "OGAM MapServer"
        "wcs_onlineresource"           "http://localhost/ogam/" 
        "wcs_fees"                     "none"
        "wcs_accessconstraints"        "none"
        "wcs_keywordlist"              "wcs,test"
        "wcs_metadatalink_type"        "TC211"
        "wcs_metadatalink_format"      "text/plain"
    END
    VALIDATION
        # %SESSION_ID% must be 40 letters or digits
        'SESSION_ID'     '^[a-zA-Z0-9\-]+$'
        #%PLOT_CODE% must be 16 letters or digits or dot or dash
        PLOT_CODE          '^[a-zA-Z0-9\.\-]{0,16}$'
    END
END

PROJECTION
  "init=epsg:3857"
END

SCALEBAR
    UNITS kilometers    
    INTERVALS 1
    SIZE 100 2
    LABEL
        COLOR  0 0 0
        OUTLINECOLOR 255 255 255
    END
END

OUTPUTFORMAT
  NAME PNG
  DRIVER "AGG/PNG"
  MIMETYPE "image/png"
  IMAGEMODE RGBA
  FORMATOPTION  INTERLACE=OFF
  TRANSPARENT ON
END

OUTPUTFORMAT
  NAME JPEG
  DRIVER "AGG/JPEG"
  MIMETYPE "image/jpeg"
  IMAGEMODE RGB
  EXTENSION "jpg"
  FORMATOPTION QUALITY=80 
END

#
# Start of legend
#
LEGEND
  KEYSIZE 18 12
  LABEL
    FONT arial_win
    TYPE TRUETYPE 
    ENCODING UTF-8
    SIZE 10
    COLOR 0 0 0
  END
END


#
# NUTS regions at 1 / 3 000 000 
#
LAYER  
    NAME nuts_0
    TYPE POLYGON
    STATUS ON 
    DEBUG 5
    METADATA
        WFS_TITLE        "Country Boundaries"
        GML_FEATUREID      "gid" 
        GML_INCLUDE_ITEMS  "all"   
    END
    DUMP TRUE 
    TEMPLATE "template.html"
    
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" 
    CONNECTION "user=ogam password=ogam dbname=ogam host=localhost port=5432"
    DATA "the_geom FROM nuts_0 USING UNIQUE gid USING srid=3857"
    CLASSITEM "nuts_id"
    LABELITEM "nuts_id"
    CLASS
          NAME 'Country'    
          OUTLINECOLOR 0 0 0      
          LABEL
                COLOR  255 0 0
                FONT arial_win
                TYPE truetype
                SIZE 8
                POSITION AUTO          
                PARTIALS FALSE
                BUFFER 5
                OUTLINECOLOR 255 255 255           
         END     
    END
    PROJECTION
            "init=epsg:3857"
    END
END



#
# Result Vector layer 
#
LAYER
    NAME "result_location_polygon"
    GROUP result_location
    TRANSPARENCY 80
    TYPE POLYGON
    STATUS ON
    METADATA
        WFS_TITLE          "Results"
        GML_FEATUREID      "oid" 
        GML_INCLUDE_ITEMS  "all"    
        "gml_display_group"     "provider_id,plot_code"         
    END
    DUMP TRUE 
    template "dummy"
    VALIDATION
        'SESSION_ID'     '^[a-zA-Z0-9\-]+$'
    END
    
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" 
    CONNECTION "user=ogam password=ogam dbname=ogam host=localhost port=5432"
    DATA "the_geom FROM (
            SELECT the_geom, format, pk, oid FROM result_location
            WHERE GeometryType(the_geom) = 'POLYGON'
              AND session_id = '%SESSION_ID%'
        ) as foo USING UNIQUE oid USING srid=3857
    "
    
    SYMBOLSCALEDENOM 3000000
    CLASS
      NAME 'Result location'
      STYLE
        MINSIZE 3
        COLOR 238 153 0
        OUTLINECOLOR 238 153 0
      END
    END
END 
LAYER
    NAME "result_location_point"
    GROUP result_location
    TRANSPARENCY 80
    TYPE POINT
    STATUS ON
    METADATA
        WFS_TITLE          "Results"
        GML_FEATUREID      "oid" 
        GML_INCLUDE_ITEMS  "all"    
        "gml_display_group"     "provider_id,plot_code"         
    END
    DUMP TRUE 
    
    VALIDATION
        'SESSION_ID'     '^[a-zA-Z0-9\-]+$'
    END
    
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" 
    CONNECTION "user=ogam password=ogam dbname=ogam host=localhost port=5432"
    DATA "the_geom FROM (
            SELECT the_geom, format, pk, oid FROM result_location
            WHERE GeometryType(the_geom) = 'POINT'
              AND session_id = '%SESSION_ID%'
        ) as foo USING UNIQUE oid USING srid=3857
    "
    
    SYMBOLSCALEDENOM 3000000
    CLASS
      NAME 'Result location'
      STYLE
        MINSIZE 3
        MAXSIZE 7
        COLOR 238 153 0
        SYMBOL "circle"
      END
    END
END 

#
# Vector layer for all locations for all countries
#
LAYER
    NAME "all_locations"
    TRANSPARENCY 80
    TYPE POINT
    STATUS ON
    
    METADATA
        WFS_TITLE          "All Plots"
        GML_FEATUREID      "oid" 
        GML_INCLUDE_ITEMS  "all"        
    END
    DUMP TRUE 
    template "template.html"
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER" 
    CONNECTION "user=ogam password=ogam dbname=ogam host=localhost port=5432"
    DATA "the_geom FROM (
            SELECT st_transform(the_geom, 3857) as the_geom, plot_code as oid  
            FROM location
        ) as foo USING UNIQUE oid USING srid=3857
    "
    
    SYMBOLSCALEDENOM 3000000
    CLASS
      NAME 'Plot location'
      STYLE
        MINSIZE 3
        COLOR 150 150 150
        OUTLINECOLOR 150 150 150
        SYMBOL "circle"
      END
    END
END 

LAYER
    NAME "plot_location_detail"
    TRANSPARENCY 100
    DEBUG 5
    STATUS ON
    TYPE POINT 
    CONNECTIONTYPE postgis
    PROCESSING "CLOSE_CONNECTION=DEFER"
    CONNECTION "user=ogam password=ogam dbname=ogam host=localhost port=5432"
    DATA "the_geom FROM (
            SELECT st_transform(the_geom, 3857) as the_geom, provider_id || '_' || plot_code as oid,plot_code
            FROM location
        ) as foo USING UNIQUE oid USING srid=3857"


    FILTER "plot_code = '%PLOT_CODE%'"
  
    CLASS
      STYLE
        SIZE 30
        WIDTH 2
        MAXSIZE 30
        MINSIZE 30
        OUTLINECOLOR 255 0 0
        SYMBOL "square"
      END
    END
END 



END # Map File
